<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K-MATCH</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Import Map: ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
        }
    }
    </script>
    <style>body { font-family: sans-serif; }</style>
</head>
<body class="bg-gray-50 text-slate-800">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Users, Layers, Settings, RefreshCw, Star, Heart, ArrowRight, ArrowLeft,
            CheckCircle, X, Zap, Award, Smile, Sparkles, ThumbsUp, Lock, Unlock,
            Edit3, Lightbulb, Download, LogOut, Upload, Database, AlertCircle, Eye, Trash2, ToggleLeft, ToggleRight, BarChart2
        } from 'lucide-react';
        
        // --- Firebase Imports & Config ---
        import { initializeApp } from "firebase/app";
        import { 
            getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged 
        } from "firebase/auth";
        import { 
            getFirestore, collection, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, writeBatch
        } from "firebase/firestore";

        // ã€é‡è¦ã€‘ã“ã“ã«Firebaseã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ã‚³ãƒ”ãƒ¼ã—ãŸè¨­å®šå€¤ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„
        const firebaseConfig = {
            apiKey: "AIzaSyCGIKgIuSlee2SxUlNsatUH1l7C2BkH3hc",
            authDomain: "k-mach.firebaseapp.com",
            projectId: "k-mach",
            storageBucket: "k-mach.firebasestorage.app",
            messagingSenderId: "735279357382",
            appId: "1:735279357382:web:8dcecd5d5f01c7337826c7"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Constants ---
        const CATEGORIES = [
            // è‡ªç„¶ç§‘å­¦åˆ†é‡
            { id: 'NAT_MAT', group: 'è‡ªç„¶ç§‘å­¦åˆ†é‡', name: 'ç‰©è³ªãƒ»ææ–™', color: 'from-blue-500 to-cyan-400' },
            { id: 'NAT_BIO', group: 'è‡ªç„¶ç§‘å­¦åˆ†é‡', name: 'ç”Ÿå‘½ãƒ»ç”Ÿç‰©', color: 'from-green-500 to-emerald-400' },
            { id: 'NAT_EAR', group: 'è‡ªç„¶ç§‘å­¦åˆ†é‡', name: 'åœ°çƒãƒ»ç’°å¢ƒ', color: 'from-teal-500 to-green-400' },
            { id: 'NAT_PHY', group: 'è‡ªç„¶ç§‘å­¦åˆ†é‡', name: 'ç‰©ç†ãƒ»å·¥å­¦', color: 'from-indigo-500 to-blue-400' },
            { id: 'NAT_INF', group: 'è‡ªç„¶ç§‘å­¦åˆ†é‡', name: 'æ•°ç†ãƒ»æƒ…å ±', color: 'from-violet-500 to-purple-400' },

            // ç¤¾ä¼šç§‘å­¦åˆ†é‡
            { id: 'SOC_ECO', group: 'ç¤¾ä¼šç§‘å­¦åˆ†é‡', name: 'çµŒæ¸ˆãƒ»ç”£æ¥­', color: 'from-orange-500 to-amber-400' },
            { id: 'SOC_PUB', group: 'ç¤¾ä¼šç§‘å­¦åˆ†é‡', name: 'æ”¿ç­–ãƒ»è¡Œæ”¿ãƒ»å…¬å…±', color: 'from-red-500 to-rose-400' },
            { id: 'SOC_EDU', group: 'ç¤¾ä¼šç§‘å­¦åˆ†é‡', name: 'æ•™è‚²ãƒ»å¿ƒç†', color: 'from-pink-500 to-rose-400' },
            { id: 'SOC_SOC', group: 'ç¤¾ä¼šç§‘å­¦åˆ†é‡', name: 'ç¤¾ä¼šãƒ»æ–‡åŒ–', color: 'from-fuchsia-500 to-pink-400' },
            { id: 'SOC_INT', group: 'ç¤¾ä¼šç§‘å­¦åˆ†é‡', name: 'å›½éš›ãƒ»åœ°ç†', color: 'from-yellow-500 to-orange-400' },

            // äººæ–‡ç§‘å­¦åˆ†é‡
            { id: 'HUM_HIS', group: 'äººæ–‡ç§‘å­¦åˆ†é‡', name: 'æ­´å²ãƒ»åœ°åŸŸå²', color: 'from-amber-600 to-yellow-500' },
            { id: 'HUM_LNG', group: 'äººæ–‡ç§‘å­¦åˆ†é‡', name: 'è¨€èªãƒ»ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³', color: 'from-cyan-600 to-blue-500' },
            { id: 'HUM_LIT', group: 'äººæ–‡ç§‘å­¦åˆ†é‡', name: 'æ–‡å­¦ãƒ»ç‰©èª', color: 'from-emerald-600 to-teal-500' },
            { id: 'HUM_PHL', group: 'äººæ–‡ç§‘å­¦åˆ†é‡', name: 'å“²å­¦ãƒ»å€«ç†', color: 'from-indigo-600 to-violet-500' },
            { id: 'HUM_ART', group: 'äººæ–‡ç§‘å­¦åˆ†é‡', name: 'èŠ¸è¡“ãƒ»ãƒ‡ã‚¶ã‚¤ãƒ³', color: 'from-rose-600 to-pink-500' },
        ];

        // Updated TOPIC_TAGS with correct data and ID ranges
        // T01-T28: Natural (Blue style)
        // T29-T48: Social (Orange style)
        // T49-T57: Humanities (Rose style)
        const TOPIC_TAGS = [
            { id: 'T01', name: 'åŠ›å­¦ï¼ˆèº«ä½“ã®å‹•ã/ã‚¹ãƒãƒ¼ãƒ„ç§‘å­¦ï¼‰' }, { id: 'T02', name: 'åŠ›å­¦ï¼ˆæ§‹é€ /æ»‘ç©º/æµ®åŠ›ï¼‰' },
            { id: 'T03', name: 'åœ°éœ‡ãƒ»é˜²ç½' }, { id: 'T04', name: 'å»ºç¯‰' }, { id: 'T05', name: 'ç´™é£›è¡Œæ©Ÿ' },
            { id: 'T06', name: 'ã‚¹ãƒãƒ¼ãƒ„ï¼ˆãƒ•ã‚©ãƒ¼ãƒ /å‹•ä½œ/æˆ¦è¡“ï¼‰' }, { id: 'T07', name: 'ã‚¹ãƒãƒ¼ãƒ„ï¼ˆã‚±ã‚¬/é“å…·ï¼‰' },
            { id: 'T08', name: 'ãƒ¢ãƒ¼ã‚¿ãƒ¼ã‚¹ãƒãƒ¼ãƒ„' }, { id: 'T09', name: 'éŸ³ãƒ»è‰²' },
            { id: 'T10', name: 'ç‰©è³ªï¼ˆæˆåˆ†/åŠ¹æœ/ææ–™ï¼‰' }, { id: 'T11', name: 'è–¬' },
            { id: 'T12', name: 'åŒ–ç²§å“' }, { id: 'T13', name: 'ç’°å¢ƒï¼ˆå…‰å®³/CO2ï¼‰' },
            { id: 'T14', name: 'é£Ÿå“ï¼ˆæˆåˆ†/åˆ†æï¼‰' }, { id: 'T15', name: 'æ¤ç‰©ï¼ˆç”Ÿè‚²/åœŸå£Œï¼‰' },
            { id: 'T16', name: 'ç”Ÿç‰©ï¼ˆæ˜†è™«/å¾®ç”Ÿç‰©/å¤–æ¥ç¨®ï¼‰' }, { id: 'T17', name: 'å¾®ç”Ÿç‰©ï¼ˆç™ºé…µ/åŸ¹é¤Šï¼‰' },
            { id: 'T18', name: 'ã‚¿ãƒ³ãƒ‘ã‚¯è³ªé…µç´ ' }, { id: 'T19', name: 'å®‡å®™ãƒ»å¤©æ–‡' },
            { id: 'T20', name: 'å¤©æ°—' }, { id: 'T21', name: 'æµ·' }, { id: 'T22', name: 'ãƒ’ãƒ¼ãƒˆã‚¢ã‚¤ãƒ©ãƒ³ãƒ‰' },
            { id: 'T23', name: 'å®šç¾©ãƒ»æ³•å‰‡ãƒ»æ•°å¼' }, { id: 'T24', name: 'è§£æï¼ˆç”»åƒ/éŸ³å£°/å‹•ç”»ï¼‰' },
            { id: 'T25', name: 'ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³' }, { id: 'T26', name: 'çµ±è¨ˆãƒ»ãƒ‡ãƒ¼ã‚¿' },
            { id: 'T27', name: 'æ•™è‚²Ã—ICT' }, { id: 'T28', name: 'AIãƒ»ç”ŸæˆAI' }, 
            
            { id: 'T29', name: 'æ ªãƒ»ç‚ºæ›¿' }, { id: 'T30', name: 'SDGs' }, { id: 'T31', name: 'å®‰å…¨ä¿éšœ' }, { id: 'T32', name: 'å›½éš›æƒ…å‹¢' },
            { id: 'T33', name: 'æ–‡åŒ–ã¨ç¤¾ä¼š' }, { id: 'T34', name: 'æ³•å¾‹ãƒ»æ ¡å‰‡' }, { id: 'T35', name: 'åœ°åŸŸã®ç‰¹è‰²' },
            { id: 'T36', name: 'çµŒæ¸ˆæ´»å‹•' }, { id: 'T37', name: 'ç’°å¢ƒã¨æº€è¶³åº¦' }, { id: 'T38', name: 'æ˜ ç”»ãƒ»èŠ¸è¡“' },
            { id: 'T39', name: 'ä¾¡æ ¼ã¨ä¾¡å€¤' }, { id: 'T40', name: 'åŠ¹ç‡åŒ–' }, { id: 'T41', name: 'è¡Œå‹•å¿ƒç†' },
            { id: 'T42', name: 'è¦³å…‰' }, { id: 'T43', name: 'èªçŸ¥ãƒã‚¤ã‚¢ã‚¹' }, { id: 'T44', name: 'ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°' },
            { id: 'T45', name: 'å­ã©ã‚‚' }, { id: 'T46', name: 'SNSãƒ»ãƒãƒƒãƒˆ' }, { id: 'T47', name: 'ãƒ¡ãƒ‡ã‚£ã‚¢' },
            { id: 'T48', name: 'å˜˜ãƒ»ãƒ•ã‚§ã‚¤ã‚¯' }, 

            { id: 'T49', name: 'å­¦ç¿’åŠ¹æœ' }, { id: 'T50', name: 'è‰²å½©å¿ƒç†' },
            { id: 'T51', name: 'ç¡çœ ãƒ»å¥åº·' }, { id: 'T52', name: 'ã‚¹ãƒˆãƒ¬ã‚¹' }, { id: 'T53', name: 'ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³' },
            { id: 'T54', name: 'ãƒ‡ã‚¶ã‚¤ãƒ³' }, { id: 'T55', name: 'å†™çœŸãƒ»æ˜ åƒ' }, { id: 'T56', name: 'æ­´å²ãƒ»èƒŒæ™¯' },
            { id: 'T57', name: 'è¨€èªãƒ»æ–¹è¨€' }
        ];

        const APPROACH_TAGS = [
            { id: 'A01', name: 'æ–‡çŒ®èª¿æŸ»', icon: 'ğŸ“š' }, { id: 'A02', name: 'å…¬é–‹ãƒ‡ãƒ¼ã‚¿', icon: 'ğŸ“Š' },
            { id: 'A03', name: 'ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ', icon: 'ğŸ“' }, { id: 'A04', name: 'ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼', icon: 'ğŸ¤' },
            { id: 'A05', name: 'è¡Œå‹•è¦³å¯Ÿ', icon: 'ğŸ‘€' }, { id: 'A06', name: 'å®Ÿé¨“', icon: 'âš—ï¸' },
            { id: 'A07', name: 'è¨ˆæ¸¬', icon: 'â±ï¸' }, { id: 'A08', name: 'ç”»åƒå‹•ç”»è§£æ', icon: 'ğŸ¥' },
            { id: 'A09', name: 'ãƒ†ã‚­ã‚¹ãƒˆåˆ†æ', icon: 'ğŸ’¬' }, { id: 'A10', name: 'çµ±è¨ˆè§£æ', icon: 'ğŸ“ˆ' },
            { id: 'A11', name: 'é–‹ç™º', icon: 'ğŸ’»' }, { id: 'A12', name: 'ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³', icon: 'ğŸ®' },
            { id: 'A13', name: 'ãƒ¢ãƒã¥ãã‚Š', icon: 'ğŸ› ï¸' }
        ];

        const SKILLS = ['ãƒ‡ãƒ¼ã‚¿åˆ†æ', 'çµ±è¨ˆå‡¦ç†', 'ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°', 'è‹±èªæ–‡çŒ®èª­è§£', 'å®Ÿé¨“æ‰‹æŠ€', 'å·¥ä½œãƒ»DIY', 'ãƒ‡ã‚¶ã‚¤ãƒ³', 'å‹•ç”»ç·¨é›†', 'ãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ—', 'ãƒ—ãƒ¬ã‚¼ãƒ³'];
        
        // Mock Themes for demo data generation
        const MOCK_THEMES = ["æœªåˆ©ç”¨é­šã‚’æ´»ç”¨ã—ãŸæ–°å•†å“é–‹ç™º", "å­¦æ ¡å†…ã®ãƒ—ãƒ©ã‚´ãƒŸå‰Šæ¸›", "AIå¤æ–‡è§£èª­ã‚¢ãƒ—ãƒª", "ä¼çµ±å·¥èŠ¸ã®ãƒªãƒ–ãƒ©ãƒ³ãƒ‡ã‚£ãƒ³ã‚°", "æ¤ç‰©ç”±æ¥ä»£æ›¿è‚‰ã®ç ”ç©¶", "é¿é›£çµŒè·¯ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³"];
        
        const PHASE = { INPUT: 'INPUT', CHECK: 'CHECK', MATCHING: 'MATCHING', PUBLISH: 'PUBLISH' };
        const CLASS_LIST = Array.from({ length: 9 }, (_, i) => i + 1);
        const STUDENT_NUMBERS = Array.from({ length: 40 }, (_, i) => i + 1);

        // [MOCK DATABASE] Firebaseæœªæ¥ç¶šæ™‚ã®ãŸã‚ã®ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿
        const MOCK_MASTER_DATA = [
            { id: 'student_001', email: 'student1@example.com', classId: 3, studentNumber: 15, name: 'ç”°ä¸­ é™½ç¿”', category: 'NAT_BIO', theme: 'åœ°å…ƒã®æ²³å·ã«ãŠã‘ã‚‹å¤–æ¥ç¨®ãŒç”Ÿæ…‹ç³»ã«ä¸ãˆã‚‹å½±éŸ¿èª¿æŸ»' }
        ];

        // --- Logic: Tag Coloring ---
        const getTagStyle = (id, isSelected = false) => {
            const num = parseInt(id.substring(1));
            // Natural: T01-T28 (Blue/Cyan)
            if (num <= 28) {
                return isSelected 
                    ? 'bg-blue-600 border-blue-600 text-white' 
                    : 'bg-blue-50 border-blue-300 text-blue-800 hover:bg-blue-100';
            }
            // Social: T29-T48 (Orange)
            if (num <= 48) {
                return isSelected 
                    ? 'bg-orange-500 border-orange-500 text-white' 
                    : 'bg-orange-50 border-orange-300 text-orange-800 hover:bg-orange-100';
            }
            // Humanities: T49-T57 (Rose/Pink)
            return isSelected 
                ? 'bg-rose-500 border-rose-500 text-white' 
                : 'bg-rose-50 border-rose-300 text-rose-800 hover:bg-rose-100';
        };

        // --- Logic: Metrics Calculation [NEW] ---
        const calculateTeamMetrics = (groupMembers) => {
            if (!groupMembers || groupMembers.length < 2) return { score: 0, connection: 0, interest: 0, diversity: 0, mutualPairs: 0 };

            let connectionScore = 0;
            let mutualPairs = 0;
            let interestScore = 0;
            
            // Analyze pairs
            for (let i = 0; i < groupMembers.length; i++) {
                for (let j = i + 1; j < groupMembers.length; j++) {
                    const s1 = groupMembers[i];
                    const s2 = groupMembers[j];
                    
                    const v1to2 = s1.votes?.[s2.id]?.love;
                    const v2to1 = s2.votes?.[s1.id]?.love;

                    if (v1to2 && v2to1) {
                        connectionScore += 15; // Mutual Love
                        mutualPairs++;
                    } else if (v1to2 || v2to1) {
                        connectionScore += 5; // One-way Love
                    }

                    // Interest (Category match) [MODIFIED] Increased weight
                    if (s1.category && s1.category === s2.category) {
                        interestScore += 10;
                    }
                    // Interest (Topic match)
                    const s1Topics = s1.topics || [];
                    const s2Topics = s2.topics || [];
                    const commonTopics = s1Topics.filter(t => s2Topics.includes(t));
                    interestScore += commonTopics.length * 2;
                }
            }

            // [NEW] Category Consistency Bonus (Team level)
            const categories = groupMembers.map(m => m.category).filter(Boolean);
            const catCounts = {};
            let maxCatCount = 0;
            categories.forEach(c => { 
                catCounts[c] = (catCounts[c] || 0) + 1; 
                if(catCounts[c] > maxCatCount) maxCatCount = catCounts[c];
            });
            const categoryBonus = groupMembers.length > 0 ? (maxCatCount / groupMembers.length) * 20 : 0;

            // Diversity (Unique Skills count)
            const allSkills = new Set();
            groupMembers.forEach(s => (s.skills || []).forEach(sk => allSkills.add(sk)));
            const diversityScore = allSkills.size * 3;

            // Total Score Normalize (Rough calculation for display)
            // Base 30 points
            let total = 30 + connectionScore + interestScore + categoryBonus + diversityScore;
            if (total > 100) total = 100;

            return {
                score: Math.min(100, Math.round(total)),
                connection: connectionScore,
                interest: Math.round(interestScore + categoryBonus),
                diversity: diversityScore,
                mutualPairs,
                uniqueSkillsCount: allSkills.size
            };
        };

        // --- Logic: Matching (Strict 3-5 Members + Skill Diversity) ---
        const getRecommendedCandidates = (currentUser, allStudents) => {
            if (!currentUser || !allStudents) return [];
            
            // Filter out self AND already voted users
            const votedIds = Object.keys(currentUser.votes || {});
            const candidates = allStudents.filter(s => s.id !== currentUser.id && !votedIds.includes(s.id));

            const scoredCandidates = candidates.map(student => {
                let score = 0;
                if (student.category && student.category === currentUser.category) score += 3;
                const cTopics = student.topics || [];
                const myTopics = currentUser.topics || [];
                const commonTopics = cTopics.filter(t => myTopics.includes(t));
                score += commonTopics.length * 5;
                const cApps = student.approaches || [];
                const myApps = currentUser.approaches || [];
                const commonApps = cApps.filter(a => myApps.includes(a));
                score += commonApps.length * 2;
                return { ...student, affinityScore: score };
            });
            scoredCandidates.sort((a, b) => b.affinityScore - a.affinityScore);
            
            // Limit to remaining checks needed (Total 30)
            const currentVoteCount = votedIds.length;
            const remainingCount = Math.max(0, 30 - currentVoteCount);
            
            const topSlice = Math.min(remainingCount, scoredCandidates.length);
            return scoredCandidates.slice(0, topSlice);
        };

        const runWeightedMatchingAlgorithm = (students, votes) => {
            if (!students || students.length === 0) return [];
            
            // Weights
            const W_MUTUAL_LOVE = 1000;
            const W_ONE_WAY_LOVE = 100;
            const W_TAG_MATCH = 5;
            const W_CAT_MATCH = 3;
            const W_SKILL_PENALTY = 10; 

            const scoreMatrix = {}; 
            
            const targetStudents = students.filter(s => s.role !== 'teacher' && s.role !== 'admin');
            
            // Build Score Matrix
            targetStudents.forEach(s1 => {
                scoreMatrix[s1.id] = {};
                targetStudents.forEach(s2 => {
                    if (s1.id === s2.id) return;
                    let score = 0;
                    
                    // Category Match
                    if (s1.category && s1.category === s2.category) score += W_CAT_MATCH;
                    
                    // Topic Match
                    const s1t = s1.topics || []; const s2t = s2.topics || [];
                    score += s1t.filter(t => s2t.includes(t)).length * W_TAG_MATCH;

                    // Skill Diversity Check (Penalty for overlaps)
                    const s1s = s1.skills || []; const s2s = s2.skills || [];
                    const commonSkills = s1s.filter(s => s2s.includes(s)).length;
                    score -= commonSkills * W_SKILL_PENALTY;
                    
                    // Votes (Strongest factor)
                    const v1 = votes[s1.id]?.[s2.id] || {};
                    if (v1.love) score += W_ONE_WAY_LOVE;
                    
                    scoreMatrix[s1.id][s2.id] = score;
                });
            });

            const unassigned = new Set(targetStudents.map(s => s.id));
            let groups = [];
            const MIN_SIZE = 3;
            const MAX_SIZE = 5;

            // 1. Form Cores
            while (unassigned.size > 0) {
                let bestPair = null, maxScore = -1;
                const arr = Array.from(unassigned).sort(() => Math.random() - 0.5);
                for (let i = 0; i < arr.length; i++) {
                    for (let j = i + 1; j < arr.length; j++) {
                        const id1 = arr[i], id2 = arr[j];
                        let pairScore = (scoreMatrix[id1][id2] || 0) + (scoreMatrix[id2][id1] || 0);
                        const v1 = votes[id1]?.[id2] || {};
                        const v2 = votes[id2]?.[id1] || {};
                        if (v1.love && v2.love) pairScore += W_MUTUAL_LOVE * 2;
                        if (pairScore > maxScore) { maxScore = pairScore; bestPair = [id1, id2]; }
                    }
                }
                if (!bestPair) break;
                const newGroup = [...bestPair];
                newGroup.forEach(id => unassigned.delete(id));
                groups.push(newGroup);
                if (unassigned.size === 0) break;
            }
            
            // 2. Grow Groups
            for (const group of groups) {
                while (group.length < 4 && unassigned.size > 0) {
                    let bestCand = null, maxCandScore = -Infinity;
                    for (const candId of unassigned) {
                        let totalScore = 0;
                        group.forEach(mId => {
                            totalScore += (scoreMatrix[candId][mId] || 0) + (scoreMatrix[mId][candId] || 0);
                            const v = votes[candId]?.[mId] || {};
                            if(v.love) totalScore += W_ONE_WAY_LOVE;
                        });
                        if (totalScore > maxCandScore) { maxCandScore = totalScore; bestCand = candId; }
                    }
                    if (bestCand) { group.push(bestCand); unassigned.delete(bestCand); } else break;
                }
            }

            // 3. Assign Leftovers
            const leftovers = Array.from(unassigned);
            let homeless = [];
            leftovers.forEach(candId => {
                let bestGroupIdx = -1, maxFitScore = -Infinity;
                groups.forEach((group, idx) => {
                    if (group.length >= MAX_SIZE) return; 
                    let score = 0;
                    group.forEach(mId => score += (scoreMatrix[candId][mId] || 0) + (scoreMatrix[mId][candId] || 0));
                    if (score > maxFitScore) { maxFitScore = score; bestGroupIdx = idx; }
                });
                if (bestGroupIdx !== -1) groups[bestGroupIdx].push(candId);
                else homeless.push(candId);
            });

            // 4. Initial check for oversized groups (6+) to split
            let balancedGroups = [];
            groups.forEach(g => {
                if(g.length <= 5) balancedGroups.push(g);
                else {
                    let rem = [...g];
                    while(rem.length > 5) {
                        const splitSize = Math.ceil(rem.length / 2);
                        balancedGroups.push(rem.splice(0, splitSize));
                    }
                    balancedGroups.push(rem);
                }
            });
            groups = balancedGroups;

            // 5. Final Rebalancing (CRITICAL FIX for < 3)
            let iterations = 0;
            const MAX_ITERATIONS = 100;
            
            // Add initial homeless
            if (homeless.length > 0) {
                groups.sort((a,b) => a.length - b.length);
                const smallG = groups.find(g => g.length < MAX_SIZE);
                if(smallG) smallG.push(...homeless);
                else groups.push(homeless);
                homeless = [];
            }

            while(iterations < MAX_ITERATIONS) {
                const smallGroups = groups.filter(g => g.length < 3);
                if (smallGroups.length === 0) break; 

                let pool = [];
                for(let i=groups.length-1; i>=0; i--) {
                    if(groups[i].length < 3) {
                        pool.push(...groups[i]);
                        groups.splice(i, 1);
                    }
                }

                for(const pid of pool) {
                    groups.sort((a,b) => a.length - b.length);
                    const target = groups.find(g => g.length < 5);
                    
                    if(target) {
                        target.push(pid);
                    } else {
                        const richGroup = groups.find(g => g.length >= 5);
                        if(richGroup) {
                             const stolen = richGroup.splice(0, 2);
                             groups.push([pid, ...stolen]);
                        } else {
                             if(groups.length > 0) groups[0].push(pid);
                             else groups.push([pid]);
                        }
                    }
                }
                
                for (let i = groups.length - 1; i >= 0; i--) {
                    if (groups[i].length > 5) {
                        const bigGroup = groups[i];
                        groups.splice(i, 1);
                        const half = Math.ceil(bigGroup.length / 2);
                        groups.push(bigGroup.slice(0, half));
                        groups.push(bigGroup.slice(half));
                    }
                }
                iterations++;
            }
            return groups;
        };

        const generateMockStudents = (count) => {
            const mocks = [];
            const lastNames = ['ä½è—¤', 'éˆ´æœ¨', 'é«˜æ©‹', 'ç”°ä¸­', 'æ¸¡è¾º', 'ä¼Šè—¤', 'å±±æœ¬', 'ä¸­æ‘', 'å°æ—', 'åŠ è—¤', 'å‰ç”°', 'å±±ç”°', 'ä½ã€…æœ¨', 'å±±å£', 'æ¾æœ¬', 'äº•ä¸Š', 'æœ¨æ‘', 'æ—', 'æ–è—¤', 'æ¸…æ°´'];
            const firstNames = ['è“®', 'é™½ç¿”', 'æ¹Š', 'çµèœ', 'é™½è‘µ', 'è‰å­', 'å¤§ç¿”', 'æ‚ çœŸ', 'çµè¡£', 'æ¥“', 'æ˜¥æ–—', 'èŠ½ä¾', 'ç¢§', 'æœé™½', 'è©©', 'ç´¬', 'å’²è‰¯', 'è’¼', 'æ¨¹', 'ç¾æœˆ'];
            for (let i = 0; i < count; i++) {
                const ln = lastNames[Math.floor(Math.random() * lastNames.length)];
                const fn = firstNames[Math.floor(Math.random() * firstNames.length)];
                const cat = CATEGORIES[Math.floor(Math.random() * CATEGORIES.length)];
                const theme = MOCK_THEMES[Math.floor(Math.random() * MOCK_THEMES.length)];
                const topics = []; const numTopics = Math.random() > 0.7 ? 2 : 1;
                for(let j=0; j<numTopics; j++) topics.push(TOPIC_TAGS[Math.floor(Math.random() * TOPIC_TAGS.length)].id);
                const apps = []; const numApps = Math.floor(Math.random() * 3) + 1;
                for(let j=0; j<numApps; j++) apps.push(APPROACH_TAGS[Math.floor(Math.random() * APPROACH_TAGS.length)].id);
                const sks = []; const numSkills = Math.floor(Math.random() * 3) + 2;
                while(sks.length < numSkills) { const s = SKILLS[Math.floor(Math.random() * SKILLS.length)]; if(!sks.includes(s)) sks.push(s); }
                const classId = Math.floor(Math.random() * 9) + 1;
                const studentNumber = Math.floor(Math.random() * 40) + 1;
                mocks.push({
                    id: `student_${Date.now()}_${i}`,
                    name: `${ln} ${fn}`,
                    classId, studentNumber, category: cat.id, theme,
                    topics: [...new Set(topics)], approaches: [...new Set(apps)], skills: sks,
                    comment: 'è‰¯ã„ãƒãƒ¼ãƒ ã‚’ä½œã‚ŠãŸã„ã§ã™ï¼ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ï¼', timestamp: Date.now()
                });
            }
            return mocks;
        };

        // --- CSV Import Component (Fixed NaN issue) ---
        const DataImporter = ({ onImport }) => {
            const [text, setText] = useState('');
            
            const handleImport = () => {
                const rows = text.trim().split('\n');
                const data = [];
                rows.forEach(row => {
                    const cols = row.split(',').map(c => c.trim());
                    if(cols.length >= 4) {
                        const classId = parseInt(cols[1]);
                        const studentNumber = parseInt(cols[2]);
                        
                        if (!isNaN(classId) && !isNaN(studentNumber)) {
                            data.push({
                                id: cols[0], // Email as ID
                                email: cols[0],
                                classId: classId,
                                studentNumber: studentNumber,
                                name: cols[3],
                                category: cols[4] || '', // Allow empty
                                theme: cols[5] || '', // Allow empty
                                role: cols[6] || 'student', 
                            });
                        }
                    }
                });
                if(data.length === 0) {
                    alert("ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
                    return;
                }
                onImport(data);
                setText('');
            };

            return (
                <div className="bg-gray-800 p-4 rounded-xl border border-gray-700 mt-4">
                    <h3 className="font-bold text-gray-300 mb-2 flex items-center gap-2"><Upload size={16}/> ç”Ÿå¾’ãƒ‡ãƒ¼ã‚¿ä¸€æ‹¬ç™»éŒ² (CSV)</h3>
                    <p className="text-xs text-gray-500 mb-2">Format: email, class, number, name, categoryID, theme, role</p>
                    <textarea 
                        className="w-full h-32 bg-gray-900 text-xs font-mono text-green-400 p-2 rounded border border-gray-600 mb-2"
                        placeholder="student1@example.com, 1, 1, å±±ç”°å¤ªéƒ, NAT_MAT, ç ”ç©¶ãƒ†ãƒ¼ãƒ, student"
                        value={text}
                        onChange={(e) => setText(e.target.value)}
                    />
                    <button onClick={handleImport} className="bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded-lg text-xs font-bold w-full">ç™»éŒ²ã‚’å®Ÿè¡Œ (ä¸Šæ›¸ãæ›´æ–°)</button>
                </div>
            );
        };

        // --- Components ---

        const LoginScreen = ({ onLogin }) => (
            <div className="min-h-screen flex items-center justify-center bg-gray-100 p-4">
                <div className="bg-white p-8 rounded-3xl shadow-xl max-w-md w-full text-center">
                    <div className="bg-blue-600 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg shadow-blue-200">
                        <Sparkles size={32} className="text-white"/>
                    </div>
                    <h1 className="text-2xl font-black text-gray-800 mb-2">K-MATCH</h1>
                    <p className="text-gray-500 mb-8">Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚<br/>ç™»éŒ²æ¸ˆã¿ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿åˆ©ç”¨å¯èƒ½ã§ã™ã€‚</p>
                    <button onClick={onLogin} className="w-full bg-white border border-gray-300 text-gray-700 font-bold py-3 rounded-xl flex items-center justify-center gap-3 hover:bg-gray-50 transition">
                        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" className="w-5 h-5"/> Googleã§ãƒ­ã‚°ã‚¤ãƒ³
                    </button>
                </div>
            </div>
        );

        const RosterStatus = ({ students, onSelectStudent, phase }) => {
            return (
                <div className="mt-8 bg-gray-800 rounded-2xl p-6 border border-gray-700 overflow-x-auto">
                    <h3 className="text-sm font-bold text-gray-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                        <Users size={16}/> Class Roster Status <span className="text-xs normal-case text-gray-500 ml-2">(ç·‘è‰²ã®ç•ªå·ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°ãƒ»å‰Šé™¤)</span>
                    </h3>
                    <div className="flex gap-4 min-w-max pb-4">
                        {CLASS_LIST.map(cls => (
                            <div key={cls} className="bg-gray-900/50 rounded-xl p-3 border border-gray-700 w-32 flex-shrink-0">
                                <div className="text-center font-bold text-gray-300 mb-2 border-b border-gray-700 pb-1">{cls}çµ„</div>
                                <div className="grid grid-cols-4 gap-1">
                                {STUDENT_NUMBERS.map(num => {
                                    const student = students.find(s => s.classId === cls && s.studentNumber === num);
                                    const isRegistered = !!student;
                                    let isSubmitted = false;
                                    
                                    // Status Logic:
                                    // INPUT: Comment exists or Topics selected
                                    // CHECK: 30 or more actions (votes + skips) recorded
                                    if(phase === PHASE.INPUT) {
                                        isSubmitted = student && (student.comment || (student.topics && student.topics.length > 0));
                                    } else if(phase === PHASE.CHECK) {
                                        isSubmitted = student && student.votes && Object.keys(student.votes).length >= 30;
                                    }
                                    
                                    return (
                                        <button 
                                            key={num} 
                                            onClick={() => isRegistered ? onSelectStudent(student) : null}
                                            className={`aspect-square flex items-center justify-center text-[9px] font-bold rounded-sm transition-all ${
                                                !isRegistered ? 'bg-gray-800 text-gray-600 cursor-default' :
                                                isSubmitted ? 'bg-green-500 text-white shadow-[0_0_8px_rgba(34,197,94,0.6)] scale-105 hover:bg-green-400' :
                                                'bg-yellow-600 text-white hover:bg-yellow-500' 
                                            }`}
                                            title={isRegistered ? `${student.name} (${student.email})` : 'æœªç™»éŒ²'}
                                        >
                                            {num}
                                        </button>
                                    );
                                })}
                                </div>
                            </div>
                        ))}
                    </div>
                    <div className="flex justify-end gap-4 mt-2 text-xs text-gray-500">
                        <div className="flex items-center gap-2"><div className="w-3 h-3 bg-gray-800 rounded-sm"></div> æœªç™»éŒ²</div>
                        <div className="flex items-center gap-2"><div className="w-3 h-3 bg-yellow-600 rounded-sm"></div> é€”ä¸­/ç™»éŒ²ã®ã¿</div>
                        <div className="flex items-center gap-2"><div className="w-3 h-3 bg-green-500 rounded-sm shadow-[0_0_5px_rgba(34,197,94,0.6)]"></div> {phase === PHASE.CHECK ? '30ä»¶å®Œäº†' : 'å…¥åŠ›å®Œäº†'}</div>
                    </div>
                </div>
            );
        };

        const TeacherPanel = ({ phase, studentCount, handleMatching, handlePublish, reset, onExport, onImportData, students, onDeleteStudent, onDeleteAll, isDemoMode, setIsDemoMode, onGenerateDemo }) => {
            const updatePhase = async (newPhase) => { await setDoc(doc(db, 'system', 'config'), { phase: newPhase }, { merge: true }); };
            const [selectedStudent, setSelectedStudent] = useState(null);

            return (
                <div className="bg-gray-900 text-white p-4 shadow-inner">
                    <div className="max-w-6xl mx-auto">
                        <div className="flex flex-col md:flex-row justify-between items-center gap-4 mb-4">
                            <div>
                                <h2 className="text-sm font-bold text-gray-400 uppercase tracking-widest mb-1">Control Panel</h2>
                                <div className="text-2xl font-bold flex items-center gap-3"><span>ç™»éŒ²è€…æ•°: {studentCount}å</span></div>
                            </div>

                            <div className="flex items-center gap-2 bg-gray-800 p-2 rounded-lg border border-gray-700">
                                <button onClick={() => setIsDemoMode(!isDemoMode)} className="flex items-center gap-2 text-xs font-bold px-2">
                                    {isDemoMode ? <ToggleRight size={24} className="text-green-400"/> : <ToggleLeft size={24} className="text-gray-500"/>}
                                    Demo Mode
                                </button>
                                {isDemoMode && phase === PHASE.INPUT && (
                                    <button onClick={onGenerateDemo} className="bg-gray-700 hover:bg-gray-600 text-xs px-3 py-1 rounded border border-gray-600 flex items-center gap-1"><Database size={12}/> +50 Mock</button>
                                )}
                            </div>

                            <div className="flex gap-2">
                                {phase === PHASE.INPUT && (
                                    <button onClick={() => updatePhase(PHASE.CHECK)} className="bg-gradient-to-r from-green-500 to-emerald-600 px-6 py-3 rounded-xl font-bold shadow-lg hover:scale-105 transition flex items-center gap-2">
                                        å…¥åŠ›ç· åˆ‡ â†’ ãƒã‚§ãƒƒã‚¯ã¸ <ArrowRight size={18}/>
                                    </button>
                                )}
                                {phase === PHASE.CHECK && (
                                    <>
                                        <button onClick={() => updatePhase(PHASE.INPUT)} className="bg-gray-700 hover:bg-gray-600 px-4 py-3 rounded-xl font-bold transition flex items-center gap-2"><ArrowLeft size={18}/> æˆ»ã‚‹</button>
                                        <button onClick={handleMatching} className="bg-gradient-to-r from-purple-500 to-indigo-600 px-6 py-3 rounded-xl font-bold shadow-lg hover:scale-105 transition flex items-center gap-2">
                                            <Layers size={18}/> ãƒãƒƒãƒãƒ³ã‚°å®Ÿè¡Œ
                                        </button>
                                    </>
                                )}
                                {phase === PHASE.MATCHING && (
                                    <>
                                        <button onClick={() => updatePhase(PHASE.CHECK)} className="bg-gray-700 hover:bg-gray-600 px-4 py-3 rounded-xl font-bold transition flex items-center gap-2"><ArrowLeft size={18}/> æˆ»ã‚‹</button>
                                        <button onClick={handleMatching} className="bg-gray-700 hover:bg-gray-600 px-4 py-3 rounded-xl font-bold transition flex items-center gap-2"><RefreshCw size={18}/> å†ç”Ÿæˆ</button>
                                        <button onClick={handlePublish} className="bg-gradient-to-r from-orange-500 to-red-500 px-6 py-3 rounded-xl font-bold shadow-lg hover:scale-105 transition flex items-center gap-2"><Star size={18} fill="white"/> å…¬é–‹ã™ã‚‹</button>
                                    </>
                                )}
                                {phase === PHASE.PUBLISH && (
                                    <>
                                        <button onClick={() => updatePhase(PHASE.MATCHING)} className="bg-gray-700 hover:bg-gray-600 px-4 py-3 rounded-xl font-bold transition flex items-center gap-2"><ArrowLeft size={18}/> æˆ»ã‚‹</button>
                                        <button onClick={onExport} className="bg-blue-600 hover:bg-blue-500 px-6 py-3 rounded-xl font-bold shadow-lg transition flex items-center gap-2"><Download size={18}/> CSVå‡ºåŠ›</button>
                                        <div className="flex flex-col gap-1">
                                            <button onClick={reset} className="border border-red-500/50 text-red-400 hover:bg-red-500/10 px-4 py-2 rounded-lg font-bold text-xs transition">ãƒªã‚»ãƒƒãƒˆ</button>
                                            <button onClick={onDeleteAll} className="bg-red-900/30 text-red-500 hover:bg-red-900/50 px-4 py-1 rounded-lg font-bold text-[10px] transition border border-red-900">å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤</button>
                                        </div>
                                    </>
                                )}
                            </div>
                        </div>
                        {/* Import in INPUT only */}
                        {phase === PHASE.INPUT && <DataImporter onImport={onImportData} />}
                        {/* Status in INPUT and CHECK */}
                        {(phase === PHASE.INPUT || phase === PHASE.CHECK) && <RosterStatus students={students} onSelectStudent={setSelectedStudent} phase={phase} />}
                    </div>
                    {/* Student Detail Modal */}
                    {selectedStudent && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={() => setSelectedStudent(null)}>
                            <div className="bg-white text-gray-800 p-6 rounded-2xl shadow-xl max-w-sm w-full" onClick={e => e.stopPropagation()}>
                                <h3 className="font-bold text-lg mb-2">{selectedStudent.classId}çµ„ {selectedStudent.studentNumber}ç•ª</h3>
                                <div className="text-xl font-bold mb-4">{selectedStudent.name}</div>
                                <div className="text-sm text-gray-500 mb-4 font-mono bg-gray-100 p-2 rounded">{selectedStudent.email}</div>
                                <div className="text-sm mb-6">
                                    <p><strong>ã‚«ãƒ†ã‚´ãƒªãƒ¼:</strong> {CATEGORIES.find(c=>c.id===selectedStudent.category)?.name || selectedStudent.category}</p>
                                    <p><strong>ãƒ†ãƒ¼ãƒ:</strong> {selectedStudent.theme}</p>
                                    {/* Added Vote Count for CHECK phase debugging */}
                                    {phase === PHASE.CHECK && (
                                        <p className="mt-2 pt-2 border-t text-green-600 font-bold">
                                            ãƒã‚§ãƒƒã‚¯é€²æ—: {selectedStudent.votes ? Object.keys(selectedStudent.votes).length : 0} / 30 ä»¶
                                        </p>
                                    )}
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={() => { onDeleteStudent(selectedStudent.id); setSelectedStudent(null); }} className="flex-1 bg-red-500 hover:bg-red-600 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2"><Trash2 size={18}/> ç™»éŒ²æŠ¹æ¶ˆ</button>
                                    <button onClick={() => setSelectedStudent(null)} className="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 py-3 rounded-xl font-bold">é–‰ã˜ã‚‹</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const ModernInputForm = ({ currentUser, onSave }) => {
            const [isSubmitted, setIsSubmitted] = useState(false);
            const [formData, setFormData] = useState({ classId: 1, studentNumber: 1, name: '', category: '', theme: '', topics: [], approaches: [], skills: [], comment: '' });
            useEffect(() => { 
                if (currentUser) {
                    setFormData(prev => ({ ...prev, ...currentUser }));
                    if(currentUser.comment) setIsSubmitted(true);
                } 
            }, [currentUser]);
            const handleSubmit = () => { onSave(formData); setIsSubmitted(true); };
            const toggleSelection = (field, value) => {
                setFormData(prev => {
                    const current = prev[field] || [];
                    if (current.includes(value)) return { ...prev, [field]: current.filter(v => v !== value) };
                    if (field === 'topics' && current.length >= 5) return prev;
                    return { ...prev, [field]: [...current, value] };
                });
            };
            const currentCategory = CATEGORIES.find(c => c.id === formData.category) || { name: 'æœªè¨­å®š', group: '-', color: 'from-gray-400 to-gray-300' };
            const isCategoryLocked = !!currentUser.category; 
            const isThemeLocked = !!currentUser.theme;
            const sectionTitleClass = "text-lg font-bold text-gray-800 mb-4 flex items-center gap-2 border-b-2 border-gray-100 pb-2";

            if (isSubmitted) {
                return (
                    <div className="flex flex-col items-center justify-center min-h-[70vh] p-6 text-center">
                        <div className="bg-blue-50 p-6 rounded-full mb-6 animate-pulse"><CheckCircle size={64} className="text-blue-500" /></div>
                        <h2 className="text-3xl font-black text-gray-800 mb-2">ç™»éŒ²å®Œäº†ï¼</h2>
                        <p className="text-gray-500 mb-8">å…ˆç”Ÿã‹ã‚‰ã®åˆå›³ãŒã‚ã‚‹ã¾ã§ã€ã“ã®ã¾ã¾ãŠå¾…ã¡ãã ã•ã„ã€‚</p>
                        <button onClick={() => setIsSubmitted(false)} className="flex items-center gap-2 text-gray-400 hover:text-gray-600 font-bold transition"><Edit3 size={16} /> ä¿®æ­£ã™ã‚‹</button>
                    </div>
                );
            }

            return (
                <div className="max-w-xl mx-auto p-6 pb-24">
                    <div className="text-center mb-8"><h2 className="text-3xl font-black text-gray-800 mb-2">My Profile</h2><p className="text-gray-500">ã‚ãªãŸã®ã€Œå¾—æ„ã€ã‚„ã€Œèˆˆå‘³ã€ã‚’æ•™ãˆã¦ãã ã•ã„</p></div>
                    <div className="space-y-8">
                        <section className="bg-white p-6 rounded-3xl shadow-sm border border-gray-100 relative overflow-hidden">
                            <div className="absolute top-0 right-0 bg-gray-100 px-3 py-1 rounded-bl-xl text-xs text-gray-500 font-bold flex items-center gap-1"><Lock size={10} /> å›ºå®šæƒ…å ±</div>
                            <div className="flex gap-4 mb-4">
                                <div className="w-1/3"><label className="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Class</label><div className="w-full p-3 bg-gray-100 rounded-xl font-bold text-gray-700">{formData.classId}çµ„</div></div>
                                <div className="w-1/3"><label className="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">No.</label><div className="w-full p-3 bg-gray-100 rounded-xl font-bold text-gray-700">{formData.studentNumber}ç•ª</div></div>
                            </div>
                            <div className="mb-4"><label className="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Name</label><div className="w-full text-xl font-bold border-b-2 border-gray-200 py-1 bg-transparent text-gray-800">{formData.name}</div></div>
                            <div className="mb-4">
                                <label className="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2 flex justify-between">Category {isCategoryLocked ? <Lock size={12}/> : <Unlock size={12} className="text-green-500"/>}</label>
                                {isCategoryLocked ? (
                                    <div className={`p-3 rounded-xl bg-gradient-to-r ${currentCategory.color} text-white shadow-sm`}><div className="text-[10px] opacity-80">{currentCategory.group}</div><div className="font-bold">{currentCategory.name}</div></div>
                                ) : (
                                    <select className="w-full p-3 bg-gray-50 rounded-xl font-bold text-gray-700 outline-none focus:ring-2 focus:ring-blue-500/50" value={formData.category} onChange={e => setFormData({...formData, category: e.target.value})}>
                                        <option value="">ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                                        {CATEGORIES.map(c => (<option key={c.id} value={c.id}>{c.group} : {c.name}</option>))}
                                    </select>
                                )}
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2 flex justify-between">Research Theme {isThemeLocked ? <Lock size={12}/> : <Unlock size={12} className="text-green-500"/>}</label>
                                {isThemeLocked ? (
                                    <div className="w-full p-3 bg-gray-100 rounded-xl font-bold text-gray-700 text-sm leading-snug">{formData.theme}</div>
                                ) : (
                                    <textarea className="w-full p-3 bg-gray-50 rounded-xl text-gray-700 outline-none focus:ring-2 focus:ring-blue-500/20 font-bold text-sm" rows="2" value={formData.theme} onChange={e => setFormData({...formData, theme: e.target.value})} placeholder="ç¾åœ¨è€ƒãˆã¦ã„ã‚‹æ¢ç©¶ã®ãƒ†ãƒ¼ãƒã‚’å…¥åŠ›" />
                                )}
                            </div>
                        </section>
                        
                        <section>
                            <label className={sectionTitleClass}><Sparkles size={20} className="text-purple-500"/> ãƒˆãƒ”ãƒƒã‚¯ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠï¼ˆæœ€å¤§5ã¤ï¼‰<span className="ml-auto text-xs font-bold text-blue-500 bg-blue-50 px-2 py-1 rounded-full">{(formData.topics||[]).length}/5</span></label>
                            <div className="flex flex-wrap gap-2">{TOPIC_TAGS.map(t => (<button key={t.id} onClick={() => toggleSelection('topics', t.id)} className={`text-xs px-4 py-2 rounded-lg border font-bold transition-all duration-200 ${(formData.topics||[]).includes(t.id) ? getTagStyle(t.id, true) : getTagStyle(t.id, false)}`}>{t.name}</button>))}</div>
                        </section>
                        <section>
                            <label className={sectionTitleClass}><Settings size={20} className="text-green-500"/> ã‚¢ãƒ—ãƒ­ãƒ¼ãƒï¼ˆè¤‡æ•°å¯ï¼‰</label>
                            <div className="flex flex-wrap gap-2">{APPROACH_TAGS.map(a => (<button key={a.id} onClick={() => toggleSelection('approaches', a.id)} className={`text-xs px-4 py-2 rounded-lg border font-bold transition-all duration-200 flex items-center gap-2 ${(formData.approaches||[]).includes(a.id) ? 'bg-green-600 border-green-600 text-white shadow-md transform scale-105' : 'bg-white border-gray-200 text-gray-600 hover:border-green-300 hover:bg-gray-50'}`}><span>{a.icon}</span><span>{a.name}</span></button>))}</div>
                        </section>
                        <section>
                            <label className={sectionTitleClass}><Zap size={20} className="text-orange-500"/> ã‚¹ã‚­ãƒ«ï¼ˆè¤‡æ•°å¯ï¼‰</label>
                            <div className="flex flex-wrap gap-2">{SKILLS.map(s => (<button key={s} onClick={() => toggleSelection('skills', s)} className={`text-xs px-4 py-2 rounded-lg border font-bold transition-all duration-200 ${(formData.skills||[]).includes(s) ? 'bg-purple-600 border-purple-600 text-white shadow-md transform scale-105' : 'bg-white border-gray-200 text-gray-600 hover:border-purple-300 hover:bg-gray-50'}`}>{s}</button>))}</div>
                        </section>
                        <section className="bg-white p-6 rounded-3xl shadow-sm border border-gray-100">
                            <label className={sectionTitleClass}><Smile size={20} className="text-pink-500"/> ã²ã¨ã“ã¨</label>
                            <textarea className="w-full p-4 bg-gray-50 rounded-2xl text-gray-700 outline-none focus:ring-2 focus:ring-blue-500/20" rows="3" value={formData.comment} onChange={e => setFormData({...formData, comment: e.target.value})} placeholder="ç‰¹ã«ã‚„ã‚ŠãŸã„ã“ã¨ã€ã“ã‚“ãªäººï¼ˆã‚„ã‚‹æ°—ã‚„ã‚¹ã‚­ãƒ«ï¼‰ã‚’å‹Ÿé›†ï¼ãªã©ã‚’è¨˜è¿°ã€‚" />
                        </section>
                        <button onClick={handleSubmit} className="w-full bg-gray-900 text-white font-bold text-lg py-4 rounded-2xl shadow-xl hover:bg-gray-800 hover:scale-[1.02] transition-all">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç™»éŒ²å®Œäº†</button>
                    </div>
                </div>
            );
        };

        const CardStack = ({ currentUser, students, onVote }) => {
            const [currentIndex, setCurrentIndex] = useState(0);
            const [direction, setDirection] = useState(null);
            const [selections, setSelections] = useState({ direction: false, skill: false, love: false });
            const candidates = useMemo(() => getRecommendedCandidates(currentUser, students), [students.length, currentUser.id]);
            const currentStudent = candidates[currentIndex];
            useEffect(() => { setSelections({ direction: false, skill: false, love: false }); }, [currentIndex]);
            const toggleSelection = (type) => setSelections(prev => ({ ...prev, [type]: !prev[type] }));
            const hasSelection = useMemo(() => Object.values(selections).some(v => v), [selections]);
            const handleSwipe = (dir) => {
                if (!currentStudent || direction || (dir === 'right' && !hasSelection)) return;
                setDirection(dir);
                
                // [FIX] Always record vote (even skip) to progress status
                // Also ensure we are recording a valid vote object
                const voteData = dir === 'right' ? selections : { skipped: true };
                onVote(currentStudent.id, voteData);
                
                setTimeout(() => { setDirection(null); setCurrentIndex(prev => prev + 1); }, 400);
            };
            if (currentIndex >= candidates.length) return <div className="flex flex-col items-center justify-center h-[70vh] text-center p-6"><div className="bg-green-100 p-6 rounded-full mb-6 animate-bounce"><CheckCircle size={64} className="text-green-600" /></div><h2 className="text-2xl font-bold text-gray-800 mb-2">ãƒã‚§ãƒƒã‚¯å®Œäº†ï¼</h2><p className="text-gray-500">å…ˆç”Ÿã®ãƒãƒƒãƒãƒ³ã‚°é–‹å§‹ã‚’ãŠå¾…ã¡ãã ã•ã„ã€‚</p></div>;
            const categoryData = CATEGORIES.find(c => c.id === currentStudent.category) || CATEGORIES[0];
            let cardClass = "absolute inset-0 bg-white rounded-3xl shadow-2xl border border-gray-100 overflow-hidden flex flex-col transition-all duration-500 ease-out";
            if (direction === 'left') cardClass += " transform -translate-x-[150%] -rotate-12 opacity-0";
            else if (direction === 'right') cardClass += " transform translate-x-[150%] rotate-12 opacity-0";
            return (
                <div className="flex flex-col items-center justify-center min-h-[85vh] p-4 overflow-hidden relative">
                    <div className="w-full max-w-md aspect-[3/4] relative">
                        {currentIndex + 1 < candidates.length && <div className="absolute top-4 left-4 right-4 bottom-4 bg-gray-50 rounded-3xl border border-gray-200 shadow-sm -z-10 transform scale-95 opacity-50"></div>}
                        <div className={cardClass}>
                            <div className={`h-32 bg-gradient-to-br ${categoryData.color} p-6 flex flex-col justify-end text-white relative`}>
                                <div className="absolute top-4 right-4 bg-white/20 backdrop-blur px-3 py-1 rounded-full text-xs font-bold">ID: {currentStudent.id.slice(-4)}</div>
                                <div className="absolute top-4 left-4 bg-black/20 backdrop-blur px-2 py-1 rounded text-[10px] font-mono">Match: {currentStudent.affinityScore}pt</div>
                                <div className="font-bold text-sm opacity-90">{categoryData.group}</div>
                                <div className="text-2xl font-black leading-none shadow-black/10 drop-shadow-md">{categoryData.name}</div>
                            </div>
                            <div className="flex-1 p-6 flex flex-col gap-4 overflow-y-auto pb-32">
                                {currentStudent.theme && <div className="mb-2"><h4 className="text-sm font-bold text-gray-800 mb-2 flex items-center gap-2 border-b border-gray-100 pb-1"><Lightbulb size={16} className="text-yellow-500"/> ä»Šè€ƒãˆã¦ã„ã‚‹é¡Œæ</h4><div className="bg-yellow-50/50 p-4 rounded-xl border border-yellow-100 font-bold text-gray-800 leading-snug shadow-sm">{currentStudent.theme}</div></div>}
                                <div><h4 className="text-sm font-bold text-gray-800 mb-2 flex items-center gap-2 border-b border-gray-100 pb-1"><Sparkles size={16} className="text-purple-500"/> ãƒˆãƒ”ãƒƒã‚¯</h4><div className="flex flex-wrap gap-2">{currentStudent.topics?.map(tid => <span key={tid} className={`px-2 py-1 rounded-lg text-xs font-bold border ${getTagStyle(tid, false)}`}>{TOPIC_TAGS.find(t=>t.id===tid)?.name}</span>)}</div></div>
                                <div><h4 className="text-sm font-bold text-gray-800 mb-2 flex items-center gap-2 border-b border-gray-100 pb-1"><Settings size={16} className="text-green-500"/> ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ</h4><div className="flex flex-wrap gap-2">{currentStudent.approaches?.map(aid => { const a = APPROACH_TAGS.find(t=>t.id===aid); return a ? <div key={aid} className="bg-green-50 text-green-700 px-2 py-1 rounded-lg text-xs font-bold border border-green-100 flex items-center gap-1"><span>{a.icon}</span><span>{a.name}</span></div> : null; })}</div></div>
                                <div><h4 className="text-sm font-bold text-gray-800 mb-2 flex items-center gap-2 border-b border-gray-100 pb-1"><Zap size={16} className="text-orange-500"/> ã‚¹ã‚­ãƒ«</h4><div className="flex flex-wrap gap-2">{currentStudent.skills?.map(s => <span key={s} className="bg-purple-50 text-purple-700 px-2 py-1 rounded-lg text-xs font-bold border border-purple-100">{s}</span>)}</div></div>
                                <div className="mt-2"><div className="text-sm font-bold text-gray-800 mb-2 flex items-center gap-2 border-b border-gray-100 pb-1"><Smile size={16} className="text-pink-500"/> ã²ã¨ã“ã¨</div><div className="bg-gray-50 p-4 rounded-xl border border-gray-100 relative"><p className="text-sm text-gray-600 italic">"{currentStudent.comment}"</p></div></div>
                            </div>
                            <div className="absolute bottom-0 left-0 right-0 bg-white/95 backdrop-blur-sm border-t p-4 pb-6 flex gap-2 justify-center">
                                <button onClick={() => handleSwipe('left')} className={`flex-1 py-3 rounded-xl flex flex-col items-center transition border-2 border-gray-200 text-gray-400 hover:bg-red-50 hover:text-red-500 hover:border-red-200`}><X size={20} /><span className="text-[10px] font-bold mt-1">ã‚¹ã‚­ãƒƒãƒ—</span></button>
                                <button onClick={() => toggleSelection('direction')} className={`flex-1 py-3 rounded-xl flex flex-col items-center transition border-2 ${selections.direction ? 'bg-green-50 border-green-500 text-green-700' : 'bg-gray-50 border-transparent text-gray-400 hover:bg-gray-100'}`}><CheckCircle size={20} className={selections.direction ? 'fill-current' : ''}/><span className="text-[10px] font-bold mt-1">æ–¹å‘æ€§</span></button>
                                <button onClick={() => toggleSelection('skill')} className={`flex-1 py-3 rounded-xl flex flex-col items-center transition border-2 ${selections.skill ? 'bg-blue-50 border-blue-500 text-blue-700' : 'bg-gray-50 border-transparent text-gray-400 hover:bg-gray-100'}`}><Zap size={20} className={selections.skill ? 'fill-current' : ''}/><span className="text-[10px] font-bold mt-1">ã‚¹ã‚­ãƒ«</span></button>
                                <button onClick={() => toggleSelection('love')} className={`flex-1 py-3 rounded-xl flex flex-col items-center transition border-2 ${selections.love ? 'bg-pink-50 border-pink-500 text-pink-700' : 'bg-gray-50 border-transparent text-gray-400 hover:bg-gray-100'}`}><Heart size={20} className={selections.love ? 'fill-current' : ''}/><span className="text-[10px] font-bold mt-1">çµ„ã¿ãŸã„</span></button>
                                <button onClick={() => handleSwipe('right')} disabled={!hasSelection} className={`flex-1 py-3 rounded-xl flex flex-col items-center transition border-2 ${hasSelection ? 'bg-blue-600 text-white border-blue-600' : 'bg-gray-200 text-gray-400 border-gray-200'}`}><ThumbsUp size={20} /><span className="text-[10px] font-bold mt-1">é€ä¿¡</span></button>
                            </div>
                        </div>
                    </div>
                    <div className="text-xs text-gray-400 mt-4 font-mono">{currentIndex + 1} / {candidates.length} Cards</div>
                </div>
            );
        };
        const ModernResultView = ({ currentUser, students, groups, isPublished }) => {
            // [NEW] Modal State for Member Details
            const [selectedMember, setSelectedMember] = useState(null);

            if (!isPublished) return <div className="flex flex-col items-center justify-center min-h-[60vh] p-8 text-center"><h2 className="text-3xl font-black text-gray-800 mb-2">Analyzing...</h2><p className="text-gray-500">å…ˆç”ŸãŒæœ€é©ãªãƒãƒ¼ãƒ ã‚’æ§‹æˆä¸­ã§ã™ã€‚<br/>ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚</p></div>;
            const myGroupIndex = groups.findIndex(g => g.members ? g.members.includes(currentUser.id) : g.includes(currentUser.id));
            const myGroupData = groups[myGroupIndex];
            // Fix for object/array structure difference
            const myGroupMemberIds = myGroupData ? (myGroupData.members || myGroupData) : [];
            const myGroupMembers = myGroupMemberIds.map(id => students.find(s => s.id === id)).filter(Boolean);
            
            return (
                <div className="min-h-screen bg-gradient-to-b from-blue-50 to-white p-6 pt-12 relative">
                    <div className="max-w-2xl mx-auto">
                        <div className="text-center mb-10">
                            <div className="inline-block bg-yellow-400 text-yellow-900 font-black text-xs px-3 py-1 rounded-full uppercase tracking-widest mb-4 shadow-lg transform -rotate-2">Team Matched!</div>
                            {myGroupIndex !== -1 && <h1 className="text-5xl font-black text-blue-600 mb-2 tracking-tight drop-shadow-sm">TEAM {myGroupIndex + 1}</h1>}
                            <h2 className="text-2xl font-bold text-gray-900 mb-2">ã‚ãªãŸã®ãƒãƒ¼ãƒ </h2>
                        </div>
                        <div className="grid gap-4">
                            {myGroupMembers.map((member) => {
                                const isMe = member.id === currentUser.id;
                                const cat = CATEGORIES.find(c => c.id === member.category) || CATEGORIES[0];
                                return (
                                    <div 
                                        key={member.id} 
                                        onClick={() => setSelectedMember(member)} // Click to open modal
                                        className="bg-white rounded-2xl p-4 shadow-xl border border-gray-100 flex items-center gap-4 transform hover:scale-[1.02] transition duration-300 cursor-pointer hover:bg-gray-50"
                                    >
                                        <div className={`w-14 h-14 rounded-2xl bg-gradient-to-br ${cat.color} flex items-center justify-center text-white font-bold text-xl shadow-md`}>{member.name.charAt(0)}</div>
                                        <div className="flex-1">
                                            <div className="flex justify-between items-center mb-1"><h3 className="font-bold text-lg text-gray-800 flex items-center gap-2">{member.name}{isMe && <span className="bg-gray-900 text-white text-[10px] px-2 py-0.5 rounded-full">YOU</span>}</h3><div className="text-xs font-bold text-gray-400">{cat.name}</div></div>
                                            <div className="flex gap-2 mb-1"><span className="bg-gray-50 text-gray-500 px-2 py-0.5 rounded text-[10px] font-bold">{member.classId}çµ„ {member.studentNumber}ç•ª</span></div>
                                            <div className="flex flex-wrap gap-1">{member.skills?.slice(0,3).map(s => <span key={s} className="bg-purple-50 text-purple-700 px-2 py-1 rounded-lg text-xs font-bold border border-purple-100">{s}</span>)}</div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>

                    {/* Member Detail Modal */}
                    {selectedMember && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={() => setSelectedMember(null)}>
                            <div className="bg-white text-gray-800 p-0 rounded-3xl shadow-2xl max-w-sm w-full overflow-hidden" onClick={e => e.stopPropagation()}>
                                {/* Re-using design elements from CardStack but static */}
                                {(() => {
                                    const cat = CATEGORIES.find(c => c.id === selectedMember.category) || CATEGORIES[0];
                                    return (
                                        <>
                                            <div className={`h-24 bg-gradient-to-br ${cat.color} p-6 flex flex-col justify-end text-white relative`}>
                                                <div className="absolute top-4 right-4 bg-white/20 backdrop-blur px-3 py-1 rounded-full text-xs font-bold">ID: {selectedMember.id.slice(-4)}</div>
                                                <div className="font-bold text-sm opacity-90">{cat.group}</div>
                                                <div className="text-xl font-black leading-none shadow-black/10 drop-shadow-md">{cat.name}</div>
                                            </div>
                                            <div className="p-6 max-h-[60vh] overflow-y-auto">
                                                <h3 className="text-xl font-bold mb-1">{selectedMember.name} <span className="text-sm text-gray-500 font-normal ml-2">{selectedMember.classId}çµ„ {selectedMember.studentNumber}ç•ª</span></h3>
                                                
                                                {selectedMember.theme && (
                                                    <div className="mb-4 mt-4">
                                                        <h4 className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1 flex items-center gap-1"><Lightbulb size={12}/> ä»Šè€ƒãˆã¦ã„ã‚‹é¡Œæ</h4>
                                                        <div className="bg-yellow-50 p-3 rounded-xl border border-yellow-100 font-bold text-gray-800 text-sm">{selectedMember.theme}</div>
                                                    </div>
                                                )}

                                                <div className="space-y-4 mt-4">
                                                    <div>
                                                        <h4 className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1 flex items-center gap-1"><Sparkles size={12}/> ãƒˆãƒ”ãƒƒã‚¯</h4>
                                                        <div className="flex flex-wrap gap-1">
                                                            {selectedMember.topics?.map(tid => <span key={tid} className={`px-2 py-1 rounded-md text-xs font-bold border ${getTagStyle(tid, false)}`}>{TOPIC_TAGS.find(t=>t.id===tid)?.name}</span>)}
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <h4 className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1 flex items-center gap-1"><Settings size={12}/> ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ</h4>
                                                        <div className="flex flex-wrap gap-1">
                                                            {selectedMember.approaches?.map(aid => { const a = APPROACH_TAGS.find(t=>t.id===aid); return a ? <span key={aid} className="bg-green-50 text-green-700 px-2 py-1 rounded-md text-xs font-bold border border-green-100">{a.icon} {a.name}</span> : null; })}
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <h4 className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1 flex items-center gap-1"><Zap size={12}/> ã‚¹ã‚­ãƒ«</h4>
                                                        <div className="flex flex-wrap gap-1">
                                                            {selectedMember.skills?.map(s => <span key={s} className="bg-purple-50 text-purple-700 px-2 py-1 rounded-md text-xs font-bold border border-purple-100">{s}</span>)}
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <h4 className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1 flex items-center gap-1"><Smile size={12}/> ã²ã¨ã“ã¨</h4>
                                                        <div className="bg-gray-50 p-3 rounded-xl border border-gray-100 text-sm text-gray-600 italic">"{selectedMember.comment}"</div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="p-4 border-t border-gray-100 bg-gray-50 text-center">
                                                <button onClick={() => setSelectedMember(null)} className="bg-gray-800 text-white px-8 py-2 rounded-full font-bold text-sm hover:bg-gray-700 transition">é–‰ã˜ã‚‹</button>
                                            </div>
                                        </>
                                    );
                                })()}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [currentUserData, setCurrentUserData] = useState(null);
            const [students, setStudents] = useState([]);
            const [phase, setPhase] = useState(PHASE.INPUT);
            const [groups, setGroups] = useState([]);
            const [errorMsg, setErrorMsg] = useState('');
            const [isDemoMode, setIsDemoMode] = useState(false);

            useEffect(() => {
                const timer = setTimeout(() => {
                    console.log("Auto reloading...");
                    window.location.reload();
                }, 3600000); 
                return () => clearTimeout(timer);
            }, []);

            // 1. Auth Listener
            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    setUser(u);
                });
                return () => unsubscribe();
            }, []);

            // 2. User Data Listener
            useEffect(() => {
                if (!user) {
                    setCurrentUserData(null);
                    return;
                }
                const unsubUser = onSnapshot(doc(db, 'users', user.email), (docSnap) => {
                    if (docSnap.exists()) {
                        setCurrentUserData(docSnap.data());
                    } else {
                        setErrorMsg("ã“ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ç®¡ç†è€…ã«å•ã„åˆã‚ã›ã¦ãã ã•ã„ã€‚");
                        signOut(auth);
                    }
                }, (error) => {
                     console.error("User listener error:", error);
                });
                return () => unsubUser();
            }, [user]);

            useEffect(() => {
                if (!user) return;
                const unsubSystem = onSnapshot(doc(db, 'system', 'config'), (doc) => {
                    if (doc.exists()) setPhase(doc.data().phase || PHASE.INPUT);
                });
                const unsubStudents = onSnapshot(collection(db, 'users'), (snapshot) => {
                    const loadedStudents = snapshot.docs.map(d => ({ id: d.id, ...d.data() })).filter(u => u.role !== 'teacher' && u.role !== 'admin');
                    setStudents(loadedStudents);
                });
                const unsubGroups = onSnapshot(doc(db, 'system', 'groups'), (doc) => {
                    if(doc.exists()) {
                        const rawList = doc.data().list || [];
                        const formattedGroups = rawList.map(item => item.members || item); 
                        setGroups(formattedGroups);
                    } else {
                        setGroups([]);
                    }
                });
                return () => { unsubSystem(); unsubStudents(); unsubGroups(); };
            }, [user]);

            const handleLogin = async () => {
                try {
                    await signInWithPopup(auth, new GoogleAuthProvider());
                    setErrorMsg('');
                } catch (error) {
                    console.error(error);
                    if (error.code === 'auth/unauthorized-domain') setErrorMsg(`ã€è¨­å®šã‚¨ãƒ©ãƒ¼ã€‘ã“ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ (${window.location.hostname}) ã¯Firebaseã§è¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚Firebaseã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã® Authentication > è¨­å®š > æ‰¿èªæ¸ˆã¿ãƒ‰ãƒ¡ã‚¤ãƒ³ ã«ã“ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚`);
                    else if (error.code === 'auth/api-key-not-valid' || error.message.includes('api-key-not-valid')) setErrorMsg("ã€è¨­å®šã‚¨ãƒ©ãƒ¼ã€‘APIã‚­ãƒ¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚index.htmlå†…ã® firebaseConfig ã‚’ã€Firebaseã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ã‚³ãƒ”ãƒ¼ã—ãŸæœ¬ç‰©ã®å€¤ã«æ›¸ãæ›ãˆã¦ãã ã•ã„ã€‚");
                    else if (error.code === 'auth/popup-closed-by-user') setErrorMsg("ãƒ­ã‚°ã‚¤ãƒ³æ“ä½œãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸã€‚");
                    else setErrorMsg("ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message);
                }
            };
            const handleLogout = () => signOut(auth);
            const handleSaveProfile = async (data) => {
                if(!user) return;
                if(currentUserData.role === 'teacher' || currentUserData.role === 'admin') { alert("ã€ç¢ºèªã€‘ç®¡ç†è€…ã®ãŸã‚ã€ãƒ‡ãƒ¼ã‚¿ã¯ä¿å­˜ã•ã‚Œã¾ã›ã‚“ï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰ï¼‰"); return; }
                await updateDoc(doc(db, 'users', user.email), { ...data, updatedAt: new Date() });
            };
            
            // [FIX] Correct Vote Handling: Use setDoc with merge to avoid overwriting entire map
            const handleVote = async (targetId, selections) => {
                if(!user) return;
                if(currentUserData.role === 'teacher' || currentUserData.role === 'admin') { console.log("Teacher vote ignored"); return; }
                
                const userRef = doc(db, 'users', user.email);
                // Dynamically update the specific key in the 'votes' map
                await setDoc(userRef, { votes: { [targetId]: selections } }, { merge: true });
            };

            const handleGenerateMock = () => {
                const mocks = generateMockStudents(50);
                const batch = writeBatch(db);
                mocks.forEach(data => {
                    const ref = doc(db, 'users', `mock_${data.id}`); 
                    batch.set(ref, { ...data, email: `mock_${data.id}@example.com` }); 
                });
                batch.commit().then(() => alert("ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿50ä»¶ã‚’è¿½åŠ ã—ã¾ã—ãŸ"));
            };
            const handleImportData = async (dataList) => {
                const batch = writeBatch(db);
                dataList.forEach(data => { const ref = doc(db, 'users', data.email); batch.set(ref, data, { merge: true }); });
                await batch.commit();
                alert(`${dataList.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç™»éŒ²ã—ã¾ã—ãŸã€‚æ—¢å­˜ã®ç”Ÿå¾’å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã¯ä¿æŒã•ã‚Œã¾ã™ã€‚`);
            };
            const handleDeleteStudent = async (studentId) => {
                if(!confirm("æœ¬å½“ã«ã“ã®ç”Ÿå¾’ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚")) return;
                await deleteDoc(doc(db, 'users', studentId)); 
            };
            const handleDeleteAll = async () => {
                if(!confirm("ã€è­¦å‘Šã€‘å…¨ç”Ÿå¾’ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nCSVã«ã‚ˆã‚‹å†ç™»éŒ²ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚\næœ¬å½“ã«ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
                if(!confirm("æœ€çµ‚ç¢ºèªï¼šæœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
                const batch = writeBatch(db);
                students.forEach(s => { batch.delete(doc(db, 'users', s.id)); });
                await batch.commit();
                alert("å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚");
            };
            const handleMatching = async () => {
                await updateDoc(doc(db, 'system', 'config'), { phase: PHASE.MATCHING });
                const allVotes = {};
                students.forEach(s => { if(s.votes) allVotes[s.id] = s.votes; });
                const result = runWeightedMatchingAlgorithm(students, allVotes);
                const firestoreData = result.map(group => {
                    const members = group;
                    const metrics = calculateTeamMetrics(members.map(mid => students.find(s => s.id === mid)).filter(Boolean));
                    return { members, metrics };
                });
                await setDoc(doc(db, 'system', 'groups'), { list: firestoreData });
            };
            const handlePublish = async () => { await updateDoc(doc(db, 'system', 'config'), { phase: PHASE.PUBLISH }); };
            const handleReset = async () => {
                if(!confirm("æœ¬å½“ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) return;
                await updateDoc(doc(db, 'system', 'config'), { phase: PHASE.INPUT });
                await setDoc(doc(db, 'system', 'groups'), { list: [] });
            };

            const handleExportCSV = () => {
                const studentHeaders = ['Team ID', 'Class', 'Number', 'Name', 'Email', 'Category', 'Theme', 'Topics', 'Approaches', 'Skills', 'Comment'];
                const teamHeaders = ['', '', 'Team ID (List)', 'Member Emails', 'Team Score', 'Mutual Pairs', 'Connection Score', 'Interest Score', 'Diversity Score'];
                const studentRows = [];
                const teamRows = [];

                groups.forEach((groupData, groupIdx) => {
                    const teamName = `TEAM ${groupIdx + 1}`;
                    const groupMembers = groupData.members || groupData;
                    const metrics = groupData.metrics || {};
                    
                    const teamEmails = groupMembers.map(sid => { const s = students.find(st => st.id === sid); return s ? s.email : ''; }).filter(e => e).join(', ');
                    
                    teamRows.push([
                        teamName, 
                        `"${teamEmails}"`, 
                        metrics.score || 0,
                        metrics.mutualPairs || 0,
                        metrics.connection || 0,
                        metrics.interest || 0,
                        metrics.diversity || 0
                    ]);

                    groupMembers.forEach(studentId => {
                        const student = students.find(s => s.id === studentId);
                        if (student) {
                            const catName = CATEGORIES.find(c => c.id === student.category)?.name || '';
                            const topicNames = (student.topics||[]).map(tid => TOPIC_TAGS.find(t => t.id === tid)?.name).join('|');
                            const approachNames = (student.approaches||[]).map(aid => APPROACH_TAGS.find(a => a.id === aid)?.name).join('|');
                            const skillNames = (student.skills||[]).join('|');
                            studentRows.push([teamName, student.classId, student.studentNumber, student.name, student.email, catName, `"${student.theme||''}"`, `"${topicNames}"`, `"${approachNames}"`, `"${skillNames}"`, `"${student.comment||''}"`]);
                        }
                    });
                });

                const maxRows = Math.max(studentRows.length, teamRows.length);
                const combinedRows = [];
                combinedRows.push([...studentHeaders, ...teamHeaders].join(','));

                for (let i = 0; i < maxRows; i++) {
                    const left = studentRows[i] ? studentRows[i].join(',') : new Array(studentHeaders.length).fill('').join(',');
                    const rightData = teamRows[i] ? teamRows[i].join(',') : ','; 
                    const right = teamRows[i] ? `, ,${rightData}` : ', , , , , , ,'; 
                    combinedRows.push(`${left}${right}`);
                }

                const csvContent = combinedRows.join('\n');
                const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
                const blob = new Blob([bom, csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.setAttribute('download', 'teams_and_emails.csv');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            if (!user) return <LoginScreen onLogin={handleLogin} />;
            if (errorMsg) return <div className="min-h-screen flex items-center justify-center p-4"><div className="bg-red-50 text-red-600 p-6 rounded-xl border border-red-200 text-center"><AlertCircle className="mx-auto mb-2"/>{errorMsg}</div></div>;
            if (!currentUserData) return <div className="min-h-screen flex items-center justify-center">Loading...</div>;

            const isTeacher = currentUserData.role === 'teacher' || currentUserData.role === 'admin';

            return (
                <div className="min-h-screen bg-gray-50 font-sans text-gray-800 selection:bg-blue-200">
                    <header className="bg-white/80 backdrop-blur-md border-b border-gray-200 sticky top-0 z-50">
                        <div className="max-w-4xl mx-auto px-4 h-16 flex justify-between items-center">
                            <div className="flex items-center gap-2"><div className="bg-gradient-to-tr from-blue-500 to-purple-500 text-white p-2 rounded-xl shadow-lg"><Sparkles size={20} fill="white" /></div><div><h1 className="font-bold text-gray-800 leading-tight">K-MATCH</h1></div></div>
                            <div className="flex items-center gap-3"><span className="text-xs font-bold px-3 py-1 bg-gray-100 rounded-full text-gray-600">{phase}</span><button onClick={handleLogout} className="text-gray-400 hover:text-gray-600"><LogOut size={20}/></button></div>
                        </div>
                    </header>
                    
                    {isTeacher && (
                        <TeacherPanel 
                            phase={phase} students={students} studentCount={students.length} 
                            handleMatching={handleMatching} handlePublish={handlePublish} onExport={handleExportCSV} 
                            reset={handleReset} onImportData={handleImportData} onDeleteStudent={handleDeleteStudent} onDeleteAll={handleDeleteAll} 
                            isDemoMode={isDemoMode} setIsDemoMode={setIsDemoMode} onGenerateDemo={handleGenerateMock}
                        />
                    )}

                    <main>
                        {((!isTeacher) || (isTeacher && phase !== PHASE.MATCHING && phase !== PHASE.PUBLISH)) && (
                            <div className={isTeacher ? "border-4 border-green-500 rounded-xl m-4 relative overflow-hidden bg-gray-100" : ""}>
                                {isTeacher && <div className="absolute top-0 left-0 bg-green-500 text-white px-3 py-1 text-xs font-bold rounded-br-xl z-50 flex items-center gap-1"><Eye size={12}/> ç”Ÿå¾’ç”»é¢ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ (æ“ä½œç„¡åŠ¹)</div>}
                                {phase === PHASE.INPUT && <ModernInputForm currentUser={currentUserData} onSave={handleSaveProfile} />}
                                {phase === PHASE.CHECK && <CardStack currentUser={currentUserData} students={students} onVote={handleVote} />}
                            </div>
                        )}
                        {/* [MODIFIED] Hide preview for teacher completely during MATCHING and PUBLISH phases */}
                        {!isTeacher && (phase === PHASE.MATCHING || phase === PHASE.PUBLISH) && (
                            <div>
                                <ModernResultView currentUser={currentUserData} students={students} groups={groups} isPublished={phase === PHASE.PUBLISH} />
                            </div>
                        )}
                        
                        {isTeacher && (phase === PHASE.MATCHING || phase === PHASE.PUBLISH) && (
                            <div className="max-w-6xl mx-auto p-8 border-t border-gray-200 mt-8">
                                <h3 className="font-black text-2xl mb-6 text-gray-800">å…¨ãƒãƒ¼ãƒ ä¸€è¦§ (ç®¡ç†è€…ç”¨)</h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    {groups.map((groupData, idx) => {
                                        const group = groupData.members || groupData;
                                        const metrics = groupData.metrics || {};
                                        return (
                                        <div key={idx} className="bg-white rounded-2xl shadow-lg border border-gray-100 p-5 relative overflow-hidden">
                                            {/* Score Badge */}
                                            <div className="absolute top-0 right-0 bg-gray-100 px-3 py-1 rounded-bl-xl text-xs font-bold text-gray-500 flex items-center gap-2">
                                                <span>Score: {metrics.score}</span>
                                                {metrics.mutualPairs > 0 && <span className="text-pink-500 flex items-center gap-0.5"><Heart size={10} fill="currentColor"/>{metrics.mutualPairs}</span>}
                                            </div>
                                            
                                            <div className="flex justify-between items-center mb-4 pb-2 border-b border-gray-100">
                                                <h4 className="font-bold text-gray-700">TEAM {idx + 1}</h4>
                                                <span className="bg-blue-100 text-blue-700 text-xs font-bold px-2 py-1 rounded-md">{group.length} Members</span>
                                            </div>
                                            <ul className="space-y-3">{group.map(sid => { const s = students.find(st => st.id === sid); const cat = CATEGORIES.find(c => c.id === s?.category) || CATEGORIES[0]; return (<li key={sid} className="flex items-center gap-3"><div className={`w-8 h-8 rounded-full bg-gradient-to-br ${cat?.color} flex items-center justify-center text-white text-xs font-bold`}>{s?.name.charAt(0)}</div><div><div className="font-bold text-sm text-gray-800">{s?.name}</div><div className="text-[10px] text-gray-400">{cat?.name}</div></div></li>)})}</ul>
                                            
                                            {/* Metrics Detail */}
                                            <div className="mt-4 pt-3 border-t border-gray-50 flex justify-between text-[10px] text-gray-400">
                                                <div title="çµæŸåŠ›">Con: {metrics.connection}</div>
                                                <div title="å…±é€šé–¢å¿ƒ">Int: {metrics.interest}</div>
                                                <div title="å¤šæ§˜æ€§">Div: {metrics.diversity}</div>
                                            </div>
                                        </div>
                                    )})} 
                                </div>
                            </div>
                        )}
                    </main>
                    <footer className="py-6 text-center text-gray-300 text-xs font-bold uppercase tracking-widest">Quest Learning Matcher v2.0</footer>
                </div>
            );
        };
        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
