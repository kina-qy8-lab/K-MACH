<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>K-MATCH</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Import Map: ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ -->
  <script type="importmap">
  {
    "imports": {
      "react": "https://esm.sh/react@18.2.0",
      "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
      "lucide-react": "https://esm.sh/lucide-react@0.263.1",
      "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
      "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
      "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
    }
  }
  </script>

  <style>body { font-family: sans-serif; }</style>
</head>

<body class="bg-gray-50 text-slate-800">
  <div id="root"></div>

  <script type="text/babel" data-type="module">
    import React, { useState, useEffect, useMemo, useRef } from "react";
    import { createRoot } from "react-dom/client";
    import {
      Users, Layers, Settings, RefreshCw, Star, Heart, ArrowRight, ArrowLeft,
      CheckCircle, X, Zap, Award, Smile, Sparkles, ThumbsUp, Lock, Unlock,
      Edit3, Lightbulb, Download, LogOut, Upload, Database, AlertCircle, Eye,
      Trash2, ToggleLeft, ToggleRight, BarChart2, Move
    } from "lucide-react";

    // --- Firebase Imports & Config ---
    import { initializeApp } from "firebase/app";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "firebase/auth";
    import {
      getFirestore, collection, doc, getDoc, setDoc, updateDoc, deleteDoc,
      onSnapshot, writeBatch
    } from "firebase/firestore";

    // ã€é‡è¦ã€‘ã“ã“ã«Firebaseã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ã‚³ãƒ”ãƒ¼ã—ãŸè¨­å®šå€¤ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„
    const firebaseConfig = {
      apiKey: "AIzaSyCGIKgIuSlee2SxUlNsatUH1l7C2BkH3hc",
      authDomain: "k-mach.firebaseapp.com",
      projectId: "k-mach",
      storageBucket: "k-mach.firebasestorage.app",
      messagingSenderId: "735279357382",
      appId: "1:735279357382:web:8dcecd5d5f01c7337826c7"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- Constants ---
    const CATEGORIES = [
      // è‡ªç„¶ç§‘å­¦åˆ†é‡
      { id: "NAT_MAT", group: "è‡ªç„¶ç§‘å­¦åˆ†é‡", name: "ç‰©è³ªãƒ»ææ–™", color: "from-blue-500 to-cyan-400" },
      { id: "NAT_BIO", group: "è‡ªç„¶ç§‘å­¦åˆ†é‡", name: "ç”Ÿå‘½ãƒ»ç”Ÿç‰©", color: "from-green-500 to-emerald-400" },
      { id: "NAT_EAR", group: "è‡ªç„¶ç§‘å­¦åˆ†é‡", name: "åœ°çƒãƒ»ç’°å¢ƒ", color: "from-teal-500 to-green-400" },
      { id: "NAT_PHY", group: "è‡ªç„¶ç§‘å­¦åˆ†é‡", name: "ç‰©ç†ãƒ»å·¥å­¦", color: "from-indigo-500 to-blue-400" },
      { id: "NAT_INF", group: "è‡ªç„¶ç§‘å­¦åˆ†é‡", name: "æ•°ç†ãƒ»æƒ…å ±", color: "from-violet-500 to-purple-400" },

      // ç¤¾ä¼šç§‘å­¦åˆ†é‡
      { id: "SOC_ECO", group: "ç¤¾ä¼šç§‘å­¦åˆ†é‡", name: "çµŒæ¸ˆãƒ»ç”£æ¥­", color: "from-orange-500 to-amber-400" },
      { id: "SOC_PUB", group: "ç¤¾ä¼šç§‘å­¦åˆ†é‡", name: "æ”¿ç­–ãƒ»è¡Œæ”¿ãƒ»å…¬å…±", color: "from-red-500 to-rose-400" },
      { id: "SOC_EDU", group: "ç¤¾ä¼šç§‘å­¦åˆ†é‡", name: "æ•™è‚²ãƒ»å¿ƒç†", color: "from-pink-500 to-rose-400" },
      { id: "SOC_SOC", group: "ç¤¾ä¼šç§‘å­¦åˆ†é‡", name: "ç¤¾ä¼šãƒ»æ–‡åŒ–", color: "from-fuchsia-500 to-pink-400" },
      { id: "SOC_INT", group: "ç¤¾ä¼šç§‘å­¦åˆ†é‡", name: "å›½éš›ãƒ»åœ°ç†", color: "from-yellow-500 to-orange-400" },

      // äººæ–‡ç§‘å­¦åˆ†é‡
      { id: "HUM_HIS", group: "äººæ–‡ç§‘å­¦åˆ†é‡", name: "æ­´å²ãƒ»åœ°åŸŸå²", color: "from-amber-600 to-yellow-500" },
      { id: "HUM_LNG", group: "äººæ–‡ç§‘å­¦åˆ†é‡", name: "è¨€èªãƒ»ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³", color: "from-cyan-600 to-blue-500" },
      { id: "HUM_LIT", group: "äººæ–‡ç§‘å­¦åˆ†é‡", name: "æ–‡å­¦ãƒ»ç‰©èª", color: "from-emerald-600 to-teal-500" },
      { id: "HUM_PHL", group: "äººæ–‡ç§‘å­¦åˆ†é‡", name: "å“²å­¦ãƒ»å€«ç†", color: "from-indigo-600 to-violet-500" },
      { id: "HUM_ART", group: "äººæ–‡ç§‘å­¦åˆ†é‡", name: "èŠ¸è¡“ãƒ»ãƒ‡ã‚¶ã‚¤ãƒ³", color: "from-rose-600 to-pink-500" }
    ];

    // ã€è¿½åŠ ã€‘ã‚«ãƒ†ã‚´ãƒªæœªå…¥åŠ›ã¯ã€Œç©ºæ¬„ã€ã¨ã—ã¦è¡¨ç¤ºã™ã‚‹ãŸã‚ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€
    const EMPTY_CATEGORY_META = { id: "", group: "", name: "", color: "from-gray-400 to-gray-300" };
    const getCategoryMeta = (catId) => CATEGORIES.find(c => c.id === catId) || EMPTY_CATEGORY_META;

    const TOPIC_TAGS = [
      { id: "T01", name: "åŠ›å­¦ï¼ˆèº«ä½“ã®å‹•ã/ã‚¹ãƒãƒ¼ãƒ„ç§‘å­¦ï¼‰" }, { id: "T02", name: "åŠ›å­¦ï¼ˆæ§‹é€ /æ»‘ç©º/æµ®åŠ›ï¼‰" },
      { id: "T03", name: "åœ°éœ‡ãƒ»é˜²ç½" }, { id: "T04", name: "å»ºç¯‰" }, { id: "T05", name: "ç´™é£›è¡Œæ©Ÿ" },
      { id: "T06", name: "ã‚¹ãƒãƒ¼ãƒ„ï¼ˆãƒ•ã‚©ãƒ¼ãƒ /å‹•ä½œ/æˆ¦è¡“ï¼‰" }, { id: "T07", name: "ã‚¹ãƒãƒ¼ãƒ„ï¼ˆã‚±ã‚¬/é“å…·ï¼‰" },
      { id: "T08", name: "ãƒ¢ãƒ¼ã‚¿ãƒ¼ã‚¹ãƒãƒ¼ãƒ„" }, { id: "T09", name: "éŸ³ãƒ»è‰²" },
      { id: "T10", name: "ç‰©è³ªï¼ˆæˆåˆ†/åŠ¹æœ/ææ–™ï¼‰" }, { id: "T11", name: "è–¬" },
      { id: "T12", name: "åŒ–ç²§å“" }, { id: "T13", name: "ç’°å¢ƒï¼ˆå…‰å®³/CO2ï¼‰" },
      { id: "T14", name: "é£Ÿå“ï¼ˆæˆåˆ†/åˆ†æï¼‰" }, { id: "T15", name: "æ¤ç‰©ï¼ˆç”Ÿè‚²/åœŸå£Œï¼‰" },
      { id: "T16", name: "ç”Ÿç‰©ï¼ˆæ˜†è™«/å¾®ç”Ÿç‰©/å¤–æ¥ç¨®ï¼‰" }, { id: "T17", name: "å¾®ç”Ÿç‰©ï¼ˆç™ºé…µ/åŸ¹é¤Šï¼‰" },
      { id: "T18", name: "ã‚¿ãƒ³ãƒ‘ã‚¯è³ªé…µç´ " }, { id: "T19", name: "å®‡å®™ãƒ»å¤©æ–‡" },
      { id: "T20", name: "å¤©æ°—" }, { id: "T21", name: "æµ·" }, { id: "T22", name: "ãƒ’ãƒ¼ãƒˆã‚¢ã‚¤ãƒ©ãƒ³ãƒ‰" },
      { id: "T23", name: "å®šç¾©ãƒ»æ³•å‰‡ãƒ»æ•°å¼" }, { id: "T24", name: "è§£æï¼ˆç”»åƒ/éŸ³å£°/å‹•ç”»ï¼‰" },
      { id: "T25", name: "ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³" }, { id: "T26", name: "çµ±è¨ˆãƒ»ãƒ‡ãƒ¼ã‚¿" },
      { id: "T27", name: "æ•™è‚²Ã—ICT" }, { id: "T28", name: "AIãƒ»ç”ŸæˆAI" },

      { id: "T29", name: "æ ªãƒ»ç‚ºæ›¿" }, { id: "T30", name: "SDGs" }, { id: "T31", name: "å®‰å…¨ä¿éšœ" }, { id: "T32", name: "å›½éš›æƒ…å‹¢" },
      { id: "T33", name: "æ–‡åŒ–ã¨ç¤¾ä¼š" }, { id: "T34", name: "æ³•å¾‹ãƒ»æ ¡å‰‡" }, { id: "T35", name: "åœ°åŸŸã®ç‰¹è‰²" },
      { id: "T36", name: "çµŒæ¸ˆæ´»å‹•" }, { id: "T37", name: "ç’°å¢ƒã¨æº€è¶³åº¦" }, { id: "T38", name: "æ˜ ç”»ãƒ»èŠ¸è¡“" },
      { id: "T39", name: "ä¾¡æ ¼ã¨ä¾¡å€¤" }, { id: "T40", name: "åŠ¹ç‡åŒ–" }, { id: "T41", name: "è¡Œå‹•å¿ƒç†" },
      { id: "T42", name: "è¦³å…‰" }, { id: "T43", name: "èªçŸ¥ãƒã‚¤ã‚¢ã‚¹" }, { id: "T44", name: "ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°" },
      { id: "T45", name: "å­ã©ã‚‚" }, { id: "T46", name: "SNSãƒ»ãƒãƒƒãƒˆ" }, { id: "T47", name: "ãƒ¡ãƒ‡ã‚£ã‚¢" },
      { id: "T48", name: "å˜˜ãƒ»ãƒ•ã‚§ã‚¤ã‚¯" },

      { id: "T49", name: "å­¦ç¿’åŠ¹æœ" }, { id: "T50", name: "è‰²å½©å¿ƒç†" },
      { id: "T51", name: "ç¡çœ ãƒ»å¥åº·" }, { id: "T52", name: "ã‚¹ãƒˆãƒ¬ã‚¹" }, { id: "T53", name: "ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³" },
      { id: "T54", name: "ãƒ‡ã‚¶ã‚¤ãƒ³" }, { id: "T55", name: "å†™çœŸãƒ»æ˜ åƒ" }, { id: "T56", name: "æ­´å²ãƒ»èƒŒæ™¯" },
      { id: "T57", name: "è¨€èªãƒ»æ–¹è¨€" }
    ];

    const APPROACH_TAGS = [
      { id: "A01", name: "æ–‡çŒ®èª¿æŸ»", icon: "ğŸ“š" }, { id: "A02", name: "å…¬é–‹ãƒ‡ãƒ¼ã‚¿", icon: "ğŸ“Š" },
      { id: "A03", name: "ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ", icon: "ğŸ“" }, { id: "A04", name: "ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼", icon: "ğŸ¤" },
      { id: "A05", name: "è¡Œå‹•è¦³å¯Ÿ", icon: "ğŸ‘€" }, { id: "A06", name: "å®Ÿé¨“", icon: "âš—ï¸" },
      { id: "A07", name: "è¨ˆæ¸¬", icon: "â±ï¸" }, { id: "A08", name: "ç”»åƒå‹•ç”»è§£æ", icon: "ğŸ¥" },
      { id: "A09", name: "ãƒ†ã‚­ã‚¹ãƒˆåˆ†æ", icon: "ğŸ’¬" }, { id: "A10", name: "çµ±è¨ˆè§£æ", icon: "ğŸ“ˆ" },
      { id: "A11", name: "é–‹ç™º", icon: "ğŸ’»" }, { id: "A12", name: "ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³", icon: "ğŸ®" },
      { id: "A13", name: "ãƒ¢ãƒã¥ãã‚Š", icon: "ğŸ› ï¸" }
    ];

    const SKILLS = ["ãƒ‡ãƒ¼ã‚¿åˆ†æ", "çµ±è¨ˆå‡¦ç†", "ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°", "è‹±èªæ–‡çŒ®èª­è§£", "å®Ÿé¨“æ‰‹æŠ€", "å·¥ä½œãƒ»DIY", "ãƒ‡ã‚¶ã‚¤ãƒ³", "å‹•ç”»ç·¨é›†", "ãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ—", "ãƒ—ãƒ¬ã‚¼ãƒ³"];

    // ===============================
    // ã€è¿½åŠ ã€‘ãƒãƒ¼ãƒ ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆï¼ˆTEAM 01ã€œ78ï¼‰
    // ===============================
    const TEAM_SURVEY_TEAMS = Array.from({ length: 78 }, (_, i) => `TEAM ${String(i + 1).padStart(2, "0")}`);

    const toDateSafe = (v) => {
      try {
        if (!v) return null;
        if (typeof v.toDate === "function") return v.toDate();
        if (v instanceof Date) return v;
        return new Date(v);
      } catch (e) { return null; }
    };

    const fmtDateTime = (v) => {
      const d = toDateSafe(v);
      if (!d || isNaN(d.getTime())) return "";
      const pad = (n) => String(n).padStart(2, "0");
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    };

    const escapeCsv = (val) => {
      const s = (val === null || val === undefined) ? "" : String(val);
      if (s.includes('"') || s.includes(",") || s.includes("\n") || s.includes("\r")) {
        return `"${s.replace(/"/g, '""')}"`;
      }
      return s;
    };

    // ===============================
    // Category distance settings
    // ===============================
    // 0: same category
    // 1: near category (you want to mix if needed)
    // 2: same field but not near
    // 3: different field (avoid strongly)
    const CAT_NEIGHBORS = {
      // --- Natural ---
      NAT_PHY: ["NAT_INF", "NAT_MAT"],
      NAT_INF: ["NAT_PHY"],
      NAT_MAT: ["NAT_PHY", "NAT_EAR"],
      NAT_BIO: ["NAT_EAR"],
      NAT_EAR: ["NAT_BIO", "NAT_MAT"],

      // --- Social ---
      SOC_ECO: ["SOC_PUB", "SOC_SOC"],
      SOC_PUB: ["SOC_ECO", "SOC_INT"],
      SOC_SOC: ["SOC_EDU", "SOC_ECO"],
      SOC_EDU: ["SOC_SOC"],
      SOC_INT: ["SOC_PUB"],

      // --- Humanities ---
      HUM_LNG: ["HUM_LIT"],
      HUM_LIT: ["HUM_LNG", "HUM_ART"],
      HUM_ART: ["HUM_LIT"],
      HUM_HIS: ["HUM_PHL"],
      HUM_PHL: ["HUM_HIS"]
    };

    const FIELD_MISMATCH_PENALTY = 999999; // ã€ä¿®æ­£ã€‘åˆ†é‡ä¸ä¸€è‡´ã¯çµ¶å¯¾ç¦æ­¢ã®ãŸã‚æ¥µå¤§åŒ–
    const CAT_MISSING_PENALTY = 0;         // ã€ä¿®æ­£ã€‘categoryæœªå…¥åŠ›ã¯ã€Œã©ã“ã§ã‚‚OKã€æ‰±ã„ã®ãŸã‚ä¸­ç«‹ï¼ˆãƒšãƒŠãƒ«ãƒ†ã‚£ãªã—ï¼‰

    // Weights (tune here)
    const W = {
      // votes (A)
      MUTUAL_LOVE: 900,
      ONE_LOVE: 160,

      MUTUAL_DIR: 320,
      ONE_DIR: 55,

      MUTUAL_SKILL: 220,
      ONE_SKILL: 35,

      // profile similarity
      TOPIC_MATCH: 12,
      APPROACH_MATCH: 6,

      // category distance (core)
      CAT_SAME_BONUS: 260,   // dist=0
      CAT_NEAR_BONUS: 160,   // dist=1
      FIELD_SAME_BONUS: 20,  // dist=2
      CAT_DIST_PENALTY: 120, // distãŒå¢—ãˆã‚‹ã»ã©å¼•ãï¼ˆdist=2ã§-240ãªã©ï¼‰

      // skills (B)
      SKILL_OVERLAP_PENALTY: 3,    // ä»¥å‰ã® -10 ã‚ˆã‚Šå¼±ãï¼ˆå¤šæ§˜æ€§ã¯ãƒãƒ¼ãƒ å´ã§è©•ä¾¡ï¼‰
      TEAM_UNIQUE_SKILL_BONUS: 4,  // ãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚¹ã‚­ãƒ«æ•°ã«å¿œã˜ã¦ãƒãƒ¼ãƒ åŠ ç‚¹ï¼ˆmetrics/æœ€é©åŒ–ã§ä½¿ç”¨ï¼‰

      // skipped
      BOTH_SKIPPED_PENALTY: 20
    };

    // fieldåˆ¤å®š
    const getField = (catId) => {
      if (!catId) return "UNK";
      if (catId.startsWith("NAT_")) return "NAT";
      if (catId.startsWith("SOC_")) return "SOC";
      if (catId.startsWith("HUM_")) return "HUM";
      return "UNK";
    };

    const isNeighborCat = (c1, c2) => {
      if (!c1 || !c2) return false;
      const n1 = CAT_NEIGHBORS[c1] || [];
      const n2 = CAT_NEIGHBORS[c2] || [];
      return n1.includes(c2) || n2.includes(c1);
    };

    const categoryDistance = (c1, c2) => {
      // ã€ä¿®æ­£ã€‘æœªå…¥åŠ›ã¯ã€Œã©ã“ã§ã‚‚OKã€ï¼è·é›¢ã¯ä¸­ç«‹ï¼ˆ0æ‰±ã„ï¼‰
      if (!c1 || !c2) return 0;
      if (c1 === c2) return 0;
      if (isNeighborCat(c1, c2)) return 1;
      const f1 = getField(c1), f2 = getField(c2);
      if (f1 !== "UNK" && f2 !== "UNK" && f1 === f2) return 2;
      return 3;
    };

    // ã€ä¿®æ­£ã€‘åˆ†é‡ä¸€è‡´ãƒã‚§ãƒƒã‚¯é–¢æ•°ï¼ˆçµ¶å¯¾ç¦æ­¢ç”¨ï¼‰
    const isSameField = (c1, c2) => {
      const f1 = getField(c1);
      const f2 = getField(c2);
      if (f1 === "UNK" || f2 === "UNK") return true; // æœªå…¥åŠ›ã¯è¨±å®¹ï¼ˆã©ã“ã§ã‚‚OKï¼‰
      return f1 === f2;
    };

    // distã«å¿œã˜ãŸã‚«ãƒ†ã‚´ãƒªã‚¹ã‚³ã‚¢ï¼ˆæœ€å„ªå…ˆã®æ ¸ï¼‰
    const categoryAffinityScore = (c1, c2) => {
      // ã€ä¿®æ­£ã€‘æœªå…¥åŠ›ã¯ä¸­ç«‹ï¼ˆ0ç‚¹ï¼‰
      if (!c1 || !c2) return 0;

      const dist = categoryDistance(c1, c2);
      if (dist === 0) return W.CAT_SAME_BONUS;
      if (dist === 1) return W.CAT_NEAR_BONUS;
      if (dist === 2) return W.FIELD_SAME_BONUS - (W.CAT_DIST_PENALTY * 2);
      // dist===3
      return -FIELD_MISMATCH_PENALTY;
    };

    // Mock Themes for demo data generation
    const MOCK_THEMES = [
      "æœªåˆ©ç”¨é­šã‚’æ´»ç”¨ã—ãŸæ–°å•†å“é–‹ç™º", "å­¦æ ¡å†…ã®ãƒ—ãƒ©ã‚´ãƒŸå‰Šæ¸›", "AIå¤æ–‡è§£èª­ã‚¢ãƒ—ãƒª",
      "ä¼çµ±å·¥èŠ¸ã®ãƒªãƒ–ãƒ©ãƒ³ãƒ‡ã‚£ãƒ³ã‚°", "æ¤ç‰©ç”±æ¥ä»£æ›¿è‚‰ã®ç ”ç©¶", "é¿é›£çµŒè·¯ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³"
    ];

    const PHASE = { INPUT: "INPUT", CHECK: "CHECK", MATCHING: "MATCHING", PUBLISH: "PUBLISH" };
    const CLASS_LIST = Array.from({ length: 9 }, (_, i) => i + 1);
    const STUDENT_NUMBERS = Array.from({ length: 40 }, (_, i) => i + 1);

    // --- Tag Coloring ---
    const getTagStyle = (id, isSelected = false) => {
      const num = parseInt(id.substring(1));
      // Natural: T01-T28 (Blue/Cyan)
      if (num <= 28) {
        return isSelected
          ? "bg-blue-600 border-blue-600 text-white"
          : "bg-blue-50 border-blue-300 text-blue-800 hover:bg-blue-100";
      }
      // Social: T29-T48 (Orange)
      if (num <= 48) {
        return isSelected
          ? "bg-orange-500 border-orange-500 text-white"
          : "bg-orange-50 border-orange-300 text-orange-800 hover:bg-orange-100";
      }
      // Humanities: T49-T57 (Rose/Pink)
      return isSelected
        ? "bg-rose-500 border-rose-500 text-white"
        : "bg-rose-50 border-rose-300 text-rose-800 hover:bg-rose-100";
    };

    // ===============================
    // Common utilities for matching
    // ===============================
    const commonCount = (a = [], b = []) => {
      const setB = new Set(b);
      let c = 0;
      a.forEach(x => { if (setB.has(x)) c++; });
      return c;
    };

    // ===============================
    // Pair score (undirected)
    // ===============================
    const pairScoreUndirected = (s1, s2, votes) => {
      let score = 0;

      // category distance (core priority)
      score += categoryAffinityScore(s1.category, s2.category);

      // topics / approaches similarity
      score += commonCount(s1.topics || [], s2.topics || []) * W.TOPIC_MATCH;
      score += commonCount(s1.approaches || [], s2.approaches || []) * W.APPROACH_MATCH;

      // skill overlap penalty (B: softer)
      const commonSkills = commonCount(s1.skills || [], s2.skills || []);
      score -= commonSkills * W.SKILL_OVERLAP_PENALTY;

      // votes (A)
      const v12 = votes?.[s1.id]?.[s2.id] || {};
      const v21 = votes?.[s2.id]?.[s1.id] || {};

      // love
      if (v12.love && v21.love) score += W.MUTUAL_LOVE;
      else if (v12.love || v21.love) score += W.ONE_LOVE;

      // direction
      if (v12.direction && v21.direction) score += W.MUTUAL_DIR;
      else if (v12.direction || v21.direction) score += W.ONE_DIR;

      // skill (vote)
      if (v12.skill && v21.skill) score += W.MUTUAL_SKILL;
      else if (v12.skill || v21.skill) score += W.ONE_SKILL;

      // skipped penalty
      if (v12.skipped && v21.skipped) score -= W.BOTH_SKIPPED_PENALTY;

      return score;
    };

    // ===============================
    // Metrics aligned with objective
    // ===============================
    const calculateTeamMetrics = (groupMembers, allStudents, votes) => {
      if (!groupMembers || groupMembers.length < 2) {
        return {
          score: 0, purity: 0, avgCatDistance: 0, crossFieldPairs: 0, mutualPairs: 0,
          connection: 0, interest: 0, diversity: 0, uniqueSkillsCount: 0, uniqueCategoriesCount: 0
        };
      }

      // purity (dominant category ratio)
      const cats = groupMembers.map(m => m.category).filter(Boolean);
      const counts = {};
      cats.forEach(c => counts[c] = (counts[c] || 0) + 1);
      const maxCat = Object.values(counts).reduce((a, b) => Math.max(a, b), 0);
      // ã€ä¿®æ­£ã€‘æœªå…¥åŠ›ã¯purityè¨ˆç®—ã‹ã‚‰é™¤å¤–ï¼ˆç©ºæ¬„ã¯åˆ¶ç´„ãƒ»è©•ä¾¡ã«ä½¿ã‚ãªã„ï¼‰
      const knownCount = cats.length;
      const purity = knownCount ? (maxCat / knownCount) : 1;

      // unique category countï¼ˆæœªå…¥åŠ›ã¯æ•°ãˆãªã„ï¼‰
      const uniqueCategoriesCount = Object.keys(counts).length;

      // avg distance & cross-field pairs
      let distSum = 0;
      let pairCount = 0;
      let crossFieldPairs = 0;

      // connection/interest
      let connection = 0;
      let interest = 0;
      let mutualPairs = 0;

      for (let i = 0; i < groupMembers.length; i++) {
        for (let j = i + 1; j < groupMembers.length; j++) {
          const s1 = groupMembers[i];
          const s2 = groupMembers[j];

          const dist = categoryDistance(s1.category, s2.category);
          distSum += dist;
          pairCount++;
          if (dist === 3) crossFieldPairs++;

          const v12 = votes?.[s1.id]?.[s2.id] || {};
          const v21 = votes?.[s2.id]?.[s1.id] || {};

          if (v12.love && v21.love) { connection += W.MUTUAL_LOVE; mutualPairs++; }
          else if (v12.love || v21.love) connection += W.ONE_LOVE;

          if (v12.direction && v21.direction) interest += W.MUTUAL_DIR;
          else if (v12.direction || v21.direction) interest += W.ONE_DIR;

          if (v12.skill && v21.skill) interest += W.MUTUAL_SKILL;
          else if (v12.skill || v21.skill) interest += W.ONE_SKILL;

          interest += commonCount(s1.topics || [], s2.topics || []) * W.TOPIC_MATCH;
          interest += commonCount(s1.approaches || [], s2.approaches || []) * W.APPROACH_MATCH;
        }
      }

      const avgCatDistance = pairCount ? (distSum / pairCount) : 0;

      // diversity (team unique skills)
      const skillSet = new Set();
      groupMembers.forEach(s => (s.skills || []).forEach(sk => skillSet.add(sk)));
      const uniqueSkillsCount = skillSet.size;
      const diversity = uniqueSkillsCount * W.TEAM_UNIQUE_SKILL_BONUS;

      // Composite score
      let raw = 0;
      raw += purity * 520;
      raw += (1 - Math.min(1, avgCatDistance / 3)) * 310;
      raw += (connection / 10);
      raw += (interest / 10);
      raw += diversity;

      raw -= Math.max(0, uniqueCategoriesCount - 1) * 120;
      raw -= crossFieldPairs * 420;

      let score = Math.max(0, Math.min(100, Math.round(raw / 10)));

      return {
        score,
        purity: Math.round(purity * 100) / 100,
        avgCatDistance: Math.round(avgCatDistance * 100) / 100,
        crossFieldPairs,
        mutualPairs,
        connection: Math.round(connection),
        interest: Math.round(interest),
        diversity: Math.round(diversity),
        uniqueSkillsCount,
        uniqueCategoriesCount
      };
    };

    // ===============================
    // Matching algorithm
    // ===============================
    const runWeightedMatchingAlgorithm = (students, votes) => {
      if (!students || students.length === 0) return [];

      const target = students.filter(s => s.role !== "teacher" && s.role !== "admin");
      const ids = target.map(s => s.id);
      const byId = Object.fromEntries(target.map(s => [s.id, s]));

      const MIN_SIZE = 3;
      const MAX_SIZE = 5;
      const IDEAL_SIZE = 4;

      // Rare category handling
      const catCounts = {};
      target.forEach(s => {
        const c = s.category || "__MISSING__";
        catCounts[c] = (catCounts[c] || 0) + 1;
      });
      const RARE_THRESHOLD = 3;
      const isRareCat = (catId) => {
        const c = catId || "__MISSING__";
        return (catCounts[c] || 0) <= RARE_THRESHOLD;
      };

      // Team-level knobs
      const INIT_MAX_UNIQUE_CATS = 2;
      const INIT_MIN_PURITY = 0.50;
      const UNIQUE_CAT_PENALTY = 180;
      const PURITY_BONUS = 260;

      const groupCategoryStats = (group) => {
        const counts = {};
        let missing = 0;
        group.forEach(id => {
          const c = byId[id]?.category;
          if (!c) { missing++; return; }
          counts[c] = (counts[c] || 0) + 1;
        });
        const uniq = Object.keys(counts).length; // ã€ä¿®æ­£ã€‘æœªå…¥åŠ›ã¯ãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚«ãƒ†ã‚´ãƒªã«æ•°ãˆãªã„
        const max = Object.values(counts).reduce((a, b) => Math.max(a, b), 0) || 0;
        const knownCount = Object.values(counts).reduce((a, b) => a + b, 0) || 0;
        const purity = knownCount ? (max / knownCount) : 1; // ã€ä¿®æ­£ã€‘æœªå…¥åŠ›ã®ã¿ãªã‚‰åˆ¶ç´„ãªã—
        let dom = null;
        let domCnt = -1;
        Object.entries(counts).forEach(([k, v]) => { if (v > domCnt) { domCnt = v; dom = k; } });
        return { uniqCats: uniq, purity, dominantCat: dom, missing };
      };

      const wouldViolateInitCohesion = (group, candId) => {
        const next = [...group, candId];

        // ã€ä¿®æ­£ã€‘åˆ†é‡ä¸ä¸€è‡´ã®å®Œå…¨ç¦æ­¢ï¼ˆæœªå…¥åŠ›ã¯è¨±å®¹ï¼‰
        const candCat = byId[candId]?.category;
        for (const mid of group) {
          if (!isSameField(byId[mid]?.category, candCat)) return true;
        }

        const st = groupCategoryStats(next);

        if (st.uniqCats > INIT_MAX_UNIQUE_CATS) return true;

        const rareInGroup = group.some(id => isRareCat(byId[id]?.category));
        const rareCand = isRareCat(candCat);
        const minPur = (rareInGroup || rareCand) ? 0.40 : INIT_MIN_PURITY;

        if (next.length >= 3 && st.purity < minPur) return true;
        return false;
      };

      // Precompute pair scores
      const ps = {};
      for (let i = 0; i < ids.length; i++) {
        const a = ids[i];
        ps[a] = ps[a] || {};
        for (let j = i + 1; j < ids.length; j++) {
          const b = ids[j];
          const sc = pairScoreUndirected(byId[a], byId[b], votes);
          ps[a][b] = sc;
          ps[b] = ps[b] || {};
          ps[b][a] = sc;
        }
      }

      const fitScore = (candId, group) => {
        let sum = 0;
        group.forEach(m => { sum += (ps[candId]?.[m] || 0); });
        return sum;
      };

      const teamCohesionPenalty = (group) => {
        let penalty = 0;

        for (let i = 0; i < group.length; i++) {
          for (let j = i + 1; j < group.length; j++) {
            const s1 = byId[group[i]], s2 = byId[group[j]];
            const dist = categoryDistance(s1.category, s2.category);
            if (dist === 3) penalty += FIELD_MISMATCH_PENALTY;
            else penalty += dist * 140;
          }
        }

        const st = groupCategoryStats(group);
        penalty += Math.max(0, st.uniqCats - 1) * UNIQUE_CAT_PENALTY;
        penalty -= st.purity * PURITY_BONUS * group.length;

        // ã€ä¿®æ­£ã€‘æœªå…¥åŠ›ã¯ä¸­ç«‹ï¼ˆãƒšãƒŠãƒ«ãƒ†ã‚£ãªã—ï¼‰
        penalty += st.missing * CAT_MISSING_PENALTY;

        const unique = new Set();
        group.forEach(id => (byId[id].skills || []).forEach(sk => unique.add(sk)));
        penalty -= unique.size * W.TEAM_UNIQUE_SKILL_BONUS;

        return penalty;
      };

      const teamObjective = (group) => {
        let sum = 0;
        for (let i = 0; i < group.length; i++) {
          for (let j = i + 1; j < group.length; j++) {
            sum += (ps[group[i]]?.[group[j]] || 0);
          }
        }
        return sum - teamCohesionPenalty(group);
      };

      const totalObjective = (groups) => groups.reduce((acc, g) => acc + teamObjective(g), 0);

      const unassigned = new Set(ids);
      const groups = [];

      const pickSeed = () => {
        let best = null;
        let bestScore = -Infinity;

        for (const id of unassigned) {
          const s = byId[id];
          const cat = s.category;

          let deg = 0;
          for (const id2 of unassigned) {
            if (id2 === id) continue;
            const s2 = byId[id2];
            const d = categoryDistance(cat, s2.category);
            if (d === 3) continue; // ã€ä¿®æ­£ã€‘åˆ¥åˆ†é‡ã¯ã‚«ã‚¦ãƒ³ãƒˆã—ãªã„
            if (d <= 1) deg += 2;
            else if (d === 2) deg += 1;
          }

          const vcnt = s.votes ? Object.keys(s.votes).length : 0;
          const rareBonus = isRareCat(cat) ? 1200 : 0;

          const sc = rareBonus + deg * 10 + Math.min(vcnt, 30);
          if (sc > bestScore) { bestScore = sc; best = id; }
        }
        return best;
      };

      const pickBestPartner = (seedId) => {
        let best = null;
        let bestSc = -Infinity;
        const seedCat = byId[seedId]?.category;

        const consider = (id2, bonus = 0) => {
          if (!isSameField(seedCat, byId[id2].category)) return; // ã€ä¿®æ­£ã€‘åˆ†é‡ä¸ä¸€è‡´ã¯çµ¶å¯¾ç¦æ­¢ï¼ˆæœªå…¥åŠ›ã¯è¨±å®¹ï¼‰
          const sc = (ps[seedId]?.[id2] || -Infinity) + bonus;
          if (sc > bestSc) { bestSc = sc; best = id2; }
        };

        if (isRareCat(seedCat)) {
          for (const id2 of unassigned) {
            if (id2 === seedId) continue;
            if ((byId[id2].category || "") === seedCat && !wouldViolateInitCohesion([seedId], id2)) consider(id2, 500);
          }
          if (best) return best;

          for (const id2 of unassigned) {
            if (id2 === seedId) continue;
            const d = categoryDistance(seedCat, byId[id2].category);
            if (d === 1 && !wouldViolateInitCohesion([seedId], id2)) consider(id2, 250);
          }
          if (best) return best;

          for (const id2 of unassigned) {
            if (id2 === seedId) continue;
            const d = categoryDistance(seedCat, byId[id2].category);
            if (d === 2 && !wouldViolateInitCohesion([seedId], id2)) consider(id2, 50);
          }
          if (best) return best;
        }

        for (const id2 of unassigned) {
          if (id2 === seedId) continue;
          const d = categoryDistance(seedCat, byId[id2].category);
          if (d > 1) continue;
          if (wouldViolateInitCohesion([seedId], id2)) continue;
          consider(id2, 150);
        }
        if (best) return best;

        for (const id2 of unassigned) {
          if (id2 === seedId) continue;
          const d = categoryDistance(seedCat, byId[id2].category);
          if (d > 2) continue;
          if (wouldViolateInitCohesion([seedId], id2)) continue;
          consider(id2, 30);
        }
        if (best) return best;

        for (const id2 of unassigned) {
          if (id2 === seedId) continue;
          const d = categoryDistance(seedCat, byId[id2].category);
          if (d === 3) continue;
          consider(id2, 0);
        }
        if (best) return best;

        for (const id2 of unassigned) {
          if (id2 === seedId) continue;
          consider(id2, 0);
        }
        return best;
      };

      while (unassigned.size > 0) {
        const seed = pickSeed();
        if (!seed) break;

        unassigned.delete(seed);

        const partner = pickBestPartner(seed);
        const group = [seed];

        if (partner) {
          group.push(partner);
          unassigned.delete(partner);
        }

        while (group.length < IDEAL_SIZE && unassigned.size > 0) {
          let bestCand = null;
          let bestFit = -Infinity;

          for (const cand of unassigned) {
            // ã€ä¿®æ­£ã€‘åˆ†é‡ä¸ä¸€è‡´ãªã‚‰ã‚¹ã‚­ãƒƒãƒ—ï¼ˆæœªå…¥åŠ›ã¯è¨±å®¹ï¼‰
            const candCat = byId[cand].category;
            if (!isSameField(byId[group[0]].category, candCat)) continue;

            const avgDist = (() => {
              const c = byId[cand].category;
              let sum = 0;
              group.forEach(m => sum += categoryDistance(c, byId[m].category));
              return sum / group.length;
            })();
            if (avgDist >= 2.5) continue;

            if (wouldViolateInitCohesion(group, cand)) continue;

            const st = groupCategoryStats(group);
            const dom = st.dominantCat || byId[group[0]]?.category;
            const dDom = categoryDistance(dom, byId[cand].category);
            if (dDom > 1) continue;

            const sc = fitScore(cand, group);
            if (sc > bestFit) { bestFit = sc; bestCand = cand; }
          }

          if (!bestCand) {
            for (const cand of unassigned) {
              const candCat = byId[cand].category;
              if (!isSameField(byId[group[0]].category, candCat)) continue;

              const avgDist = (() => {
                const c = byId[cand].category;
                let sum = 0;
                group.forEach(m => sum += categoryDistance(c, byId[m].category));
                return sum / group.length;
              })();
              if (avgDist >= 2.8) continue;

              if (wouldViolateInitCohesion(group, cand)) continue;

              const st = groupCategoryStats(group);
              const dom = st.dominantCat || byId[group[0]]?.category;
              const dDom = categoryDistance(dom, byId[cand].category);

              const rareInGroup = group.some(id => isRareCat(byId[id]?.category));
              const rareCand = isRareCat(byId[cand].category);

              if (dDom > 2) continue;
              if (dDom === 2 && !(rareInGroup || rareCand)) continue;

              const sc = fitScore(cand, group);
              if (sc > bestFit) { bestFit = sc; bestCand = cand; }
            }
          }

          if (!bestCand) {
            for (const cand of unassigned) {
              const candCat = byId[cand].category;
              if (!isSameField(byId[group[0]].category, candCat)) continue;

              if (wouldViolateInitCohesion(group, cand)) continue;
              const sc = fitScore(cand, group);
              if (sc > bestFit) { bestFit = sc; bestCand = cand; }
            }
          }

          if (!bestCand) break;
          group.push(bestCand);
          unassigned.delete(bestCand);
        }

        groups.push(group);
      }

      // Fix sizes: ensure 3-5
      let pool = [];
      for (let i = groups.length - 1; i >= 0; i--) {
        if (groups[i].length < 3) {
          pool.push(...groups[i]);
          groups.splice(i, 1);
        }
      }

      for (const pid of pool) {
        let bestIdx = -1;
        let best = -Infinity;

        for (let i = 0; i < groups.length; i++) {
          if (groups[i].length >= 5) continue;

          // ã€ä¿®æ­£ã€‘ãƒ—ãƒ¼ãƒ«å†é…ç½®æ™‚ã‚‚åˆ†é‡ä¸ä¸€è‡´ç¦æ­¢ï¼ˆæœªå…¥åŠ›ã¯è¨±å®¹ï¼‰
          const candCat = byId[pid]?.category;
          if (groups[i].some(mid => !isSameField(byId[mid]?.category, candCat))) continue;

          const st = groupCategoryStats(groups[i]);
          const nextUniq = (() => {
            const counts = {};
            [...groups[i], pid].forEach(id => {
              const c = byId[id]?.category;
              if (!c) return;
              counts[c] = (counts[c] || 0) + 1;
            });
            return Object.keys(counts).length;
          })();

          const uniqPenalty = Math.max(0, nextUniq - st.uniqCats) * 180;
          const sc = fitScore(pid, groups[i]) - teamCohesionPenalty([...groups[i], pid]) - uniqPenalty;

          if (sc > best) { best = sc; bestIdx = i; }
        }

        if (bestIdx >= 0) groups[bestIdx].push(pid);
        else groups.push([pid]);
      }

      for (let i = groups.length - 1; i >= 0; i--) {
        if (groups[i].length < 3) {
          const small = groups.splice(i, 1)[0];
          let bestIdx = -1;
          let best = -Infinity;
          for (let j = 0; j < groups.length; j++) {
            if (groups[j].length + small.length > 5) continue;

            // ã€ä¿®æ­£ã€‘ãƒãƒ¼ã‚¸æ™‚ã‚‚åˆ†é‡ãƒã‚§ãƒƒã‚¯ï¼ˆæœªå…¥åŠ›ã¯è¨±å®¹ï¼‰
            const canMerge = [...groups[j], ...small].every(id1 =>
              [...groups[j], ...small].every(id2 => isSameField(byId[id1]?.category, byId[id2]?.category))
            );
            if (!canMerge) continue;

            const merged = [...groups[j], ...small];
            const sc = teamObjective(merged);
            if (sc > best) { best = sc; bestIdx = j; }
          }
          if (bestIdx >= 0) groups[bestIdx].push(...small);
          else groups.push(small);
        }
      }

      for (let i = groups.length - 1; i >= 0; i--) {
        if (groups[i].length > 5) {
          const g = groups.splice(i, 1)[0];
          while (g.length > 5) groups.push(g.splice(0, 4));
          if (g.length) groups.push(g);
        }
      }

      // Local search refinement
      let bestGroups = groups.map(g => [...g]);
      let bestObj = totalObjective(bestGroups);

      const MAX_IT = 6500;
      const randInt = (n) => Math.floor(Math.random() * n);

      for (let it = 0; it < MAX_IT; it++) {
        const op = Math.random() < 0.65 ? 0 : 1;

        const gA = randInt(bestGroups.length);
        let gB = randInt(bestGroups.length);
        if (bestGroups.length > 1) while (gB === gA) gB = randInt(bestGroups.length);

        const A = bestGroups[gA];
        const B = bestGroups[gB];
        if (!A || !B || A.length === 0 || B.length === 0) continue;

        let newGroups = bestGroups.map(g => [...g]);

        if (op === 0) {
          const i = randInt(A.length);
          const j = randInt(B.length);
          const aId = A[i], bId = B[j];

          // ã€ä¿®æ­£ã€‘ã‚¹ãƒ¯ãƒƒãƒ—æ™‚ã‚‚åˆ†é‡ãƒã‚§ãƒƒã‚¯ï¼ˆæœªå…¥åŠ›ã¯è¨±å®¹ï¼‰
          const catA = byId[aId]?.category;
          const catB = byId[bId]?.category;

          const conflictA = B.some(mid => mid !== bId && !isSameField(byId[mid]?.category, catA));
          const conflictB = A.some(mid => mid !== aId && !isSameField(byId[mid]?.category, catB));
          if (conflictA || conflictB) continue;

          newGroups[gA][i] = bId;
          newGroups[gB][j] = aId;
        } else {
          if (A.length <= 3) continue;
          if (B.length >= 5) continue;

          const i = randInt(A.length);
          const aId = A[i];

          // ã€ä¿®æ­£ã€‘ç§»å‹•æ™‚ã‚‚åˆ†é‡ãƒã‚§ãƒƒã‚¯ï¼ˆæœªå…¥åŠ›ã¯è¨±å®¹ï¼‰
          const catA = byId[aId]?.category;
          if (B.some(mid => !isSameField(byId[mid]?.category, catA))) continue;

          newGroups[gA].splice(i, 1);
          newGroups[gB].push(aId);

          if (newGroups[gA].length < 3) continue;
        }

        newGroups = newGroups.filter(g => g.length > 0);
        if (newGroups.some(g => g.length < 3 || g.length > 5)) continue;

        const obj = totalObjective(newGroups);
        if (obj > bestObj) {
          bestObj = obj;
          bestGroups = newGroups;
        }
      }

      return bestGroups;
    };

    const generateMockStudents = (count) => {
      const mocks = [];
      const lastNames = ["ä½è—¤", "éˆ´æœ¨", "é«˜æ©‹", "ç”°ä¸­", "æ¸¡è¾º", "ä¼Šè—¤", "å±±æœ¬", "ä¸­æ‘", "å°æ—", "åŠ è—¤", "å‰ç”°", "å±±ç”°", "ä½ã€…æœ¨", "å±±å£", "æ¾æœ¬", "äº•ä¸Š", "æœ¨æ‘", "æ—", "æ–è—¤", "æ¸…æ°´"];
      const firstNames = ["è“®", "é™½ç¿”", "æ¹Š", "çµèœ", "é™½è‘µ", "è‰å­", "å¤§ç¿”", "æ‚ çœŸ", "çµè¡£", "æ¥“", "æ˜¥æ–—", "èŠ½ä¾", "ç¢§", "æœé™½", "è©©", "ç´¬", "å’²è‰¯", "è’¼", "æ¨¹", "ç¾æœˆ"];
      for (let i = 0; i < count; i++) {
        const ln = lastNames[Math.floor(Math.random() * lastNames.length)];
        const fn = firstNames[Math.floor(Math.random() * firstNames.length)];
        const cat = CATEGORIES[Math.floor(Math.random() * CATEGORIES.length)];
        const theme = MOCK_THEMES[Math.floor(Math.random() * MOCK_THEMES.length)];
        const topics = [];
        const numTopics = Math.random() > 0.7 ? 2 : 1;
        for (let j = 0; j < numTopics; j++) topics.push(TOPIC_TAGS[Math.floor(Math.random() * TOPIC_TAGS.length)].id);
        const apps = [];
        const numApps = Math.floor(Math.random() * 3) + 1;
        for (let j = 0; j < numApps; j++) apps.push(APPROACH_TAGS[Math.floor(Math.random() * APPROACH_TAGS.length)].id);
        const sks = [];
        const numSkills = Math.floor(Math.random() * 3) + 2;
        while (sks.length < numSkills) {
          const s = SKILLS[Math.floor(Math.random() * SKILLS.length)];
          if (!sks.includes(s)) sks.push(s);
        }
        const classId = Math.floor(Math.random() * 9) + 1;
        const studentNumber = Math.floor(Math.random() * 40) + 1;

        mocks.push({
          id: `student_${Date.now()}_${i}`,
          name: `${ln} ${fn}`,
          classId, studentNumber, category: cat.id, theme,
          topics: [...new Set(topics)],
          approaches: [...new Set(apps)],
          skills: sks,
          comment: "è‰¯ã„ãƒãƒ¼ãƒ ã‚’ä½œã‚ŠãŸã„ã§ã™ï¼ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ï¼",
          timestamp: Date.now(),
          role: "student"
        });
      }
      return mocks;
    };

    // --- CSV Import Component (skip header + fixed NaN issue) ---
    const DataImporter = ({ onImport }) => {
      const [text, setText] = useState("");

      const handleImport = () => {
        const rows = text.trim().split("\n");
        const data = [];
        rows.forEach((row, idx) => {
          const cols = row.split(",").map(c => c.trim());
          if (cols.length >= 4) {
            // ãƒ˜ãƒƒãƒ€ãƒ¼åˆ¤å®šï¼ˆemailåˆ—ãŒå…¥ã£ã¦ã„ãªã„ã€ã¾ãŸã¯ 'email' æ–‡å­—åˆ—ï¼‰
            const first = (cols[0] || "").toLowerCase();
            if (idx === 0 && (first.includes("email") || cols[0] === "ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹")) return;

            const classId = parseInt(cols[1]);
            const studentNumber = parseInt(cols[2]);

            if (!isNaN(classId) && !isNaN(studentNumber)) {
              data.push({
                id: cols[0], // Email as ID
                email: cols[0],
                classId: classId,
                studentNumber: studentNumber,
                name: cols[3],
                category: cols[4] || "",
                theme: cols[5] || "",
                role: cols[6] || "student"
              });
            }
          }
        });
        if (data.length === 0) {
          alert("ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
          return;
        }
        onImport(data);
        setText("");
      };

      return (
        <div className="bg-gray-800 p-4 rounded-xl border border-gray-700 mt-4">
          <h3 className="font-bold text-gray-300 mb-2 flex items-center gap-2"><Upload size={16}/> ç”Ÿå¾’ãƒ‡ãƒ¼ã‚¿ä¸€æ‹¬ç™»éŒ² (CSV)</h3>
          <p className="text-xs text-gray-500 mb-2">Format: email, class, number, name, categoryID, theme, role</p>
          <textarea
            className="w-full h-32 bg-gray-900 text-xs font-mono text-green-400 p-2 rounded border border-gray-600 mb-2"
            placeholder="student1@example.com, 1, 1, å±±ç”°å¤ªéƒ, NAT_MAT, ç ”ç©¶ãƒ†ãƒ¼ãƒ, student"
            value={text}
            onChange={(e) => setText(e.target.value)}
          />
          <button onClick={handleImport} className="bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded-lg text-xs font-bold w-full">
            ç™»éŒ²ã‚’å®Ÿè¡Œ (ä¸Šæ›¸ãæ›´æ–°)
          </button>
        </div>
      );
    };

    // --- Components ---
    const LoginScreen = ({ onLogin }) => (
      <div className="min-h-screen flex items-center justify-center bg-gray-100 p-4">
        <div className="bg-white p-8 rounded-3xl shadow-xl max-w-md w-full text-center">
          <div className="bg-blue-600 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg shadow-blue-200">
            <Sparkles size={32} className="text-white" />
          </div>
          <h1 className="text-2xl font-black text-gray-800 mb-2">K-MATCH</h1>
          <p className="text-gray-500 mb-8">Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚<br />ç™»éŒ²æ¸ˆã¿ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿åˆ©ç”¨å¯èƒ½ã§ã™ã€‚</p>
          <button onClick={onLogin} className="w-full bg-white border border-gray-300 text-gray-700 font-bold py-3 rounded-xl flex items-center justify-center gap-3 hover:bg-gray-50 transition">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" className="w-5 h-5" /> Googleã§ãƒ­ã‚°ã‚¤ãƒ³
          </button>
        </div>
      </div>
    );

    const RosterStatus = ({ students, onSelectStudent, phase }) => {
      return (
        <div className="mt-8 bg-gray-800 rounded-2xl p-6 border border-gray-700 overflow-x-auto">
          <h3 className="text-sm font-bold text-gray-400 uppercase tracking-widest mb-4 flex items-center gap-2">
            <Users size={16} /> Class Roster Status <span className="text-xs normal-case text-gray-500 ml-2">(ç·‘è‰²ã®ç•ªå·ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°ãƒ»å‰Šé™¤)</span>
          </h3>
          <div className="flex gap-4 min-w-max pb-4">
            {CLASS_LIST.map(cls => (
              <div key={cls} className="bg-gray-900/50 rounded-xl p-3 border border-gray-700 w-32 flex-shrink-0">
                <div className="text-center font-bold text-gray-300 mb-2 border-b border-gray-700 pb-1">{cls}çµ„</div>
                <div className="grid grid-cols-4 gap-1">
                  {STUDENT_NUMBERS.map(num => {
                    const student = students.find(s => s.classId === cls && s.studentNumber === num);
                    const isRegistered = !!student;
                    let isSubmitted = false;

                    // Status Logic:
                    // INPUT: Comment exists or Topics selected
                    // CHECK: 30 or more actions (votes + skips) recorded
                    if (phase === PHASE.INPUT) {
                      isSubmitted = student && (student.comment || (student.topics && student.topics.length > 0));
                    } else if (phase === PHASE.CHECK) {
                      isSubmitted = student && student.votes && Object.keys(student.votes).length >= 30;
                    }

                    return (
                      <button
                        key={num}
                        onClick={() => isRegistered ? onSelectStudent(student) : null}
                        className={`aspect-square flex items-center justify-center text-[9px] font-bold rounded-sm transition-all ${!isRegistered ? "bg-gray-800 text-gray-600 cursor-default" :
                          isSubmitted ? "bg-green-500 text-white shadow-[0_0_8px_rgba(34,197,94,0.6)] scale-105 hover:bg-green-400" :
                            "bg-yellow-600 text-white hover:bg-yellow-500"
                          }`}
                        title={isRegistered ? `${student.name} (${student.email})` : "æœªç™»éŒ²"}
                      >
                        {num}
                      </button>
                    );
                  })}
                </div>
              </div>
            ))}
          </div>
          <div className="flex justify-end gap-4 mt-2 text-xs text-gray-500">
            <div className="flex items-center gap-2"><div className="w-3 h-3 bg-gray-800 rounded-sm"></div> æœªç™»éŒ²</div>
            <div className="flex items-center gap-2"><div className="w-3 h-3 bg-yellow-600 rounded-sm"></div> é€”ä¸­/ç™»éŒ²ã®ã¿</div>
            <div className="flex items-center gap-2">
              <div className="w-3 h-3 bg-green-500 rounded-sm shadow-[0_0_5px_rgba(34,197,94,0.6)]"></div>
              {phase === PHASE.CHECK ? "30ä»¶å®Œäº†" : "å…¥åŠ›å®Œäº†"}
            </div>
          </div>
        </div>
      );
    };

    // ===============================
    // ã€è¿½åŠ ã€‘ãƒãƒ¼ãƒ ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆï¼ˆãƒãƒ¼ãƒ å…±æœ‰ï¼‰ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
    // ä¿å­˜å…ˆ: teamSurveys/{TEAM xx}
    // ===============================
    const TeamSurveyPanel = ({ teamId, currentUser }) => {
      const [loading, setLoading] = useState(true);
      const [saving, setSaving] = useState(false);
      const [meta, setMeta] = useState({ updatedAt: null, updatedBy: "" });

      const [form, setForm] = useState({
        team: teamId || "",
        topic: "",
        question: "",
        metric: "",
        manipulate: "",
        control: "",
        definition: "",
        keywords: ""
      });

      useEffect(() => {
        if (!teamId) { setLoading(false); return; }
        const ref = doc(db, "teamSurveys", teamId);
        const unsub = onSnapshot(ref, (snap) => {
          if (snap.exists()) {
            const d = snap.data() || {};
            setForm(prev => ({
              ...prev,
              team: teamId,
              topic: d.topic || "",
              question: d.question || "",
              metric: d.metric || "",
              manipulate: d.manipulate || "",
              control: d.control || "",
              definition: d.definition || "",
              keywords: d.keywords || ""
            }));
            setMeta({ updatedAt: d.updatedAt || null, updatedBy: d.updatedBy || "" });
          } else {
            setForm(prev => ({ ...prev, team: teamId }));
            setMeta({ updatedAt: null, updatedBy: "" });
          }
          setLoading(false);
        }, (e) => {
          console.error("team survey snapshot error:", e);
          setLoading(false);
        });
        return () => unsub();
      }, [teamId]);

      const save = async () => {
        if (!teamId) return;
        setSaving(true);
        try {
          const ref = doc(db, "teamSurveys", teamId);
          await setDoc(ref, {
            team: teamId,
            topic: form.topic || "",
            question: form.question || "",
            metric: form.metric || "",
            manipulate: form.manipulate || "",
            control: form.control || "",
            definition: form.definition || "",
            keywords: form.keywords || "",
            updatedAt: new Date(),
            updatedBy: currentUser?.email || currentUser?.id || ""
          }, { merge: true });
          alert("ä¿å­˜ã—ã¾ã—ãŸï¼ˆãƒãƒ¼ãƒ å†…ã§å…±æœ‰ã•ã‚Œã¾ã™ï¼‰");
        } catch (e) {
          console.error("team survey save error:", e);
          alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚é€šä¿¡çŠ¶æ³ã‚’ç¢ºèªã—ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚");
        } finally {
          setSaving(false);
        }
      };

      const labelClass = "block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1";
      const inputClass = "w-full p-3 bg-gray-50 rounded-xl text-gray-800 outline-none focus:ring-2 focus:ring-blue-500/20 font-bold text-sm border border-gray-100";
      const helpClass = "text-[11px] text-gray-500 mt-1 leading-relaxed";

      if (loading) {
        return (
          <div className="bg-white rounded-3xl shadow-sm border border-gray-100 p-6 mt-10">
            <div className="flex items-center gap-2 text-gray-500"><BarChart2 size={16}/> ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆèª­ã¿è¾¼ã¿ä¸­...</div>
          </div>
        );
      }

      return (
        <div className="bg-white rounded-3xl shadow-sm border border-gray-100 p-6 mt-10">
          <div className="flex items-center justify-between gap-2 mb-4">
            <h3 className="text-lg font-black text-gray-800 flex items-center gap-2">
              <BarChart2 size={18} className="text-blue-600" /> ãƒãƒ¼ãƒ ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆï¼ˆå…±æœ‰ï¼‰
            </h3>
            <div className="text-[11px] text-gray-400 text-right">
              {meta.updatedAt ? (
                <>
                  <div>æœ€çµ‚æ›´æ–°: {fmtDateTime(meta.updatedAt)}</div>
                  <div>æ›´æ–°è€…: {meta.updatedBy || "â€”"}</div>
                </>
              ) : (
                <div>æœªå…¥åŠ›ï¼ˆæœ€åˆã®ä¿å­˜ã§ãƒãƒ¼ãƒ å›ç­”ãŒä½œæˆã•ã‚Œã¾ã™ï¼‰</div>
              )}
            </div>
          </div>

          <div className="space-y-4">
            {/* TEAM dropdown (è¡¨ç¤ºã¯ã™ã‚‹ãŒã€ãƒãƒ¼ãƒ å…±æœ‰ã®æ•´åˆæ€§ã®ãŸã‚åŸºæœ¬ã¯å›ºå®š) */}
            <div>
              <label className={labelClass}>ãƒãƒ¼ãƒ ï¼ˆå›ºå®šï¼‰</label>
              <select
                className={inputClass}
                value={teamId || ""}
                disabled
                onChange={() => {}}
              >
                <option value="">ï¼ˆãƒãƒ¼ãƒ ãŒç¢ºå®šã—ã¦ã„ã¾ã›ã‚“ï¼‰</option>
                {TEAM_SURVEY_TEAMS.map(t => <option key={t} value={t}>{t}</option>)}
              </select>
              <div className={helpClass}>â€»ãƒãƒ¼ãƒ å›ç­”ã¨ã—ã¦ä¿å­˜ã™ã‚‹ãŸã‚ã€æ‰€å±ãƒãƒ¼ãƒ ã«å›ºå®šã•ã‚Œã¦ã„ã¾ã™ã€‚</div>
            </div>

            <div>
              <label className={labelClass}>é¡Œæï¼ˆçŸ­æ–‡å›ç­”ï¼‰</label>
              <input
                className={inputClass}
                value={form.topic}
                onChange={(e) => setForm(prev => ({ ...prev, topic: e.target.value }))}
                placeholder="ä¾‹ï¼šæ—¥ç„¼ã‘æ­¢ã‚ã®åŠ¹æœçš„ãªä½¿ã„æ–¹"
              />
            </div>

            <div>
              <label className={labelClass}>å•ã„ï¼ˆçŸ­æ–‡å›ç­”ï¼‰</label>
              <input
                className={inputClass}
                value={form.question}
                onChange={(e) => setForm(prev => ({ ...prev, question: e.target.value }))}
                placeholder="ä¾‹ï¼šâ—‹â—‹ã™ã‚‹ã¨â–³â–³ã¯ã©ã‚Œãã‚‰ã„å¤‰åŒ–ã™ã‚‹ã‹ï¼Ÿ"
              />
              <div className={helpClass}>
                â€»å•ã„ã¯ã€Œä½•ã‚’æ¯”ã¹ã‚‹ã‹ã€ã€Œä½•ãŒå¤‰åŒ–ã™ã‚‹ã‹ã€ãŒåˆ†ã‹ã‚‹å½¢ã«ã€‚ã§ãã‚Œã° â€œæ“ä½œã™ã‚‹æ¡ä»¶â€ ã¨ â€œæ¸¬ã‚‹æŒ‡æ¨™â€ ãŒèª­ã¿å–ã‚Œã‚‹æ–‡ç« ã«ã€‚
              </div>
            </div>

            <div>
              <label className={labelClass}>æ¸¬ã‚‹æŒ‡æ¨™ãƒ»æ•°ï¼ˆçŸ­æ–‡å›ç­”ï¼‰</label>
              <input
                className={inputClass}
                value={form.metric}
                onChange={(e) => setForm(prev => ({ ...prev, metric: e.target.value }))}
                placeholder="ä¾‹ï¼šUVé€éç‡(%), çš®è†šæ¸©(â„ƒ), å›æ•°(å›/åˆ†) ãªã©"
              />
            </div>

            <div>
              <label className={labelClass}>æ“ä½œã™ã‚‹æ¡ä»¶ï¼ˆçŸ­æ–‡å›ç­”ï¼‰</label>
              <input
                className={inputClass}
                value={form.manipulate}
                onChange={(e) => setForm(prev => ({ ...prev, manipulate: e.target.value }))}
                placeholder="ä¾‹ï¼šå¡—å¸ƒé‡, å¡—ã‚‹å›æ•°, æ™‚é–“, è§’åº¦, é€Ÿåº¦ ãªã©"
              />
            </div>

            <div>
              <label className={labelClass}>æƒãˆã‚‹ã¹ãæ¡ä»¶ï¼ˆé‡ãƒ»æ™‚é–“ãƒ»ç’°å¢ƒç­‰ï¼‰ï¼ˆçŸ­æ–‡å›ç­”ï¼‰</label>
              <input
                className={inputClass}
                value={form.control}
                onChange={(e) => setForm(prev => ({ ...prev, control: e.target.value }))}
                placeholder="ä¾‹ï¼šåŒã˜å ´æ‰€/åŒã˜ç…§åº¦/åŒã˜æ¸©åº¦, åŒã˜è¢«é¨“è€…æ¡ä»¶ ãªã©"
              />
            </div>

            <div>
              <label className={labelClass}>ç”¨èªã®å®šç¾©ï¼ˆé•·æ–‡å›ç­”ï¼‰</label>
              <textarea
                className={inputClass}
                rows="5"
                value={form.definition}
                onChange={(e) => setForm(prev => ({ ...prev, definition: e.target.value }))}
                placeholder="ä¾‹ï¼šã€ŒåŠ¹æœã€ã¨ã¯â—‹â—‹ã‚’â–³â–³ã—ãŸã¨ãã®æŒ‡æ¨™ãŒâ–¡â–¡ä»¥ä¸Šæ”¹å–„ã™ã‚‹ã“ã¨ã€ãªã©"
              />
              <div className={helpClass}>
                â€»ã€ŒåŠ¹æœã€ã€ŒæˆåŠŸã€ã€Œè‰¯ã„ã€ãªã©æ›–æ˜§ãªè¨€è‘‰ã¯ç¦æ­¢ï¼<br/>
                ä½•ã‚’ã©ã®å€¤ã§åˆ¤å®šã™ã‚‹ã‹ï¼ˆé–¾å€¤ãƒ»æ¡ä»¶ãƒ»æ¯”è¼ƒå¯¾è±¡ï¼‰ã‚’å®šç¾©ã—ã¦ãã ã•ã„ã€‚
              </div>
            </div>

            <div>
              <label className={labelClass}>ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆçŸ­æ–‡å›ç­”ï¼‰</label>
              <input
                className={inputClass}
                value={form.keywords}
                onChange={(e) => setForm(prev => ({ ...prev, keywords: e.target.value }))}
                placeholder="ä¾‹ï¼šsunscreen, UV, SPF, application amount, ...ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰"
              />
              <div className={helpClass}>
                â€»å…ˆè¡Œç ”ç©¶ã‚’èª¿ã¹ã‚‹ãŸã‚ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ã€ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
              </div>
            </div>

            <button
              onClick={save}
              disabled={saving || !teamId}
              className="w-full bg-blue-600 hover:bg-blue-500 text-white font-black py-4 rounded-2xl shadow-lg disabled:opacity-50 transition flex items-center justify-center gap-2"
            >
              <Download size={18} /> {saving ? "ä¿å­˜ä¸­..." : "ä¿å­˜ï¼ˆãƒãƒ¼ãƒ å…±æœ‰ï¼‰"}
            </button>
          </div>
        </div>
      );
    };

    // ===============================
    // ã€è¿½åŠ ã€‘æ•™å“¡ç”¨ï¼šã‚¢ãƒ³ã‚±ãƒ¼ãƒˆçŠ¶æ³ãƒ‘ãƒãƒ«
    // ===============================
    const TeacherSurveyDashboard = ({ teamSurveyMap }) => {
      const answered = TEAM_SURVEY_TEAMS.filter(t => !!teamSurveyMap?.[t]).length;
      return (
        <div className="max-w-6xl mx-auto px-4 pb-10">
          <div className="bg-white rounded-2xl shadow-lg border border-gray-100 p-5 mt-10">
            <div className="flex items-center justify-between gap-3 mb-3">
              <h3 className="font-black text-lg text-gray-800 flex items-center gap-2">
                <BarChart2 size={18} className="text-blue-600" /> ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”çŠ¶æ³ï¼ˆãƒãƒ¼ãƒ å…±æœ‰ï¼‰
              </h3>
              <div className="text-sm font-bold text-gray-500">
                å›ç­”æ¸ˆã¿: {answered} / {TEAM_SURVEY_TEAMS.length}
              </div>
            </div>

            <div className="overflow-x-auto">
              <table className="w-full text-xs">
                <thead>
                  <tr className="text-gray-500 border-b">
                    <th className="text-left py-2 pr-2">TEAM</th>
                    <th className="text-left py-2 pr-2">é¡Œæ</th>
                    <th className="text-left py-2 pr-2">æœ€çµ‚æ›´æ–°</th>
                    <th className="text-left py-2 pr-2">æ›´æ–°è€…</th>
                    <th className="text-left py-2 pr-2">çŠ¶æ…‹</th>
                  </tr>
                </thead>
                <tbody>
                  {TEAM_SURVEY_TEAMS.map(t => {
                    const d = teamSurveyMap?.[t] || null;
                    const updated = d?.updatedAt ? fmtDateTime(d.updatedAt) : "";
                    const status = d ? "å›ç­”ã‚ã‚Š" : "æœªå›ç­”";
                    return (
                      <tr key={t} className="border-b last:border-b-0">
                        <td className="py-2 pr-2 font-bold text-gray-800 whitespace-nowrap">{t}</td>
                        <td className="py-2 pr-2 text-gray-700">{d?.topic || ""}</td>
                        <td className="py-2 pr-2 text-gray-500 whitespace-nowrap">{updated}</td>
                        <td className="py-2 pr-2 text-gray-500">{d?.updatedBy || ""}</td>
                        <td className={`py-2 pr-2 font-bold ${d ? "text-green-600" : "text-gray-400"}`}>{status}</td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>

            <div className="text-[11px] text-gray-400 mt-3">
              â€»ã“ã®ä¸€è¦§ã¯ <code className="px-1 bg-gray-100 rounded">teamSurveys</code> ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®å†…å®¹ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚
            </div>
          </div>
        </div>
      );
    };

    const TeacherPanel = ({
      phase, studentCount, handleMatching, handlePublish, reset,
      onExport, onExportSurvey, onImportData, students,
      onDeleteStudent, onDeleteAll, isDemoMode, setIsDemoMode, onGenerateDemo, onSelectStudent,
      surveyAnsweredCount
    }) => {
      const updatePhase = async (newPhase) => { await setDoc(doc(db, "system", "config"), { phase: newPhase }, { merge: true }); };

      return (
        <div className="bg-gray-900 text-white p-4 shadow-inner">
          <div className="max-w-6xl mx-auto">
            <div className="flex flex-col md:flex-row justify-between items-center gap-4 mb-4">
              <div>
                <h2 className="text-sm font-bold text-gray-400 uppercase tracking-widest mb-1">Control Panel</h2>
                <div className="text-2xl font-bold flex items-center gap-3"><span>ç™»éŒ²è€…æ•°: {studentCount}å</span></div>
                {/* ã€è¿½åŠ ã€‘ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”æ•°è¡¨ç¤ºï¼ˆæ•™å“¡ã®ã¿è¦–èªç”¨ï¼‰ */}
                {typeof surveyAnsweredCount === "number" && (
                  <div className="text-xs text-gray-400 mt-1">ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”ï¼ˆãƒãƒ¼ãƒ ï¼‰: {surveyAnsweredCount} / {TEAM_SURVEY_TEAMS.length}</div>
                )}
              </div>

              <div className="flex items-center gap-2 bg-gray-800 p-2 rounded-lg border border-gray-700">
                <button onClick={() => setIsDemoMode(!isDemoMode)} className="flex items-center gap-2 text-xs font-bold px-2">
                  {isDemoMode ? <ToggleRight size={24} className="text-green-400" /> : <ToggleLeft size={24} className="text-gray-500" />}
                  Demo Mode
                </button>
                {isDemoMode && phase === PHASE.INPUT && (
                  <button onClick={onGenerateDemo} className="bg-gray-700 hover:bg-gray-600 text-xs px-3 py-1 rounded border border-gray-600 flex items-center gap-1">
                    <Database size={12} /> +50 Mock
                  </button>
                )}
              </div>
              <div className="flex gap-2">
                {phase === PHASE.INPUT && (
                  <button onClick={() => updatePhase(PHASE.CHECK)} className="bg-gradient-to-r from-green-500 to-emerald-600 px-6 py-3 rounded-xl font-bold shadow-lg hover:scale-105 transition flex items-center gap-2">
                    å…¥åŠ›ç· åˆ‡ â†’ ãƒã‚§ãƒƒã‚¯ã¸ <ArrowRight size={18} />
                  </button>
                )}
                {phase === PHASE.CHECK && (
                  <>
                    <button onClick={() => updatePhase(PHASE.INPUT)} className="bg-gray-700 hover:bg-gray-600 px-4 py-3 rounded-xl font-bold transition flex items-center gap-2">
                      <ArrowLeft size={18} /> æˆ»ã‚‹
                    </button>
                    <button onClick={handleMatching} className="bg-gradient-to-r from-purple-500 to-indigo-600 px-6 py-3 rounded-xl font-bold shadow-lg hover:scale-105 transition flex items-center gap-2">
                      <Layers size={18} /> ãƒãƒƒãƒãƒ³ã‚°å®Ÿè¡Œ
                    </button>
                  </>
                )}
                {phase === PHASE.MATCHING && (
                  <>
                    <button onClick={() => updatePhase(PHASE.CHECK)} className="bg-gray-700 hover:bg-gray-600 px-4 py-3 rounded-xl font-bold transition flex items-center gap-2">
                      <ArrowLeft size={18} /> æˆ»ã‚‹
                    </button>
                    <button onClick={handleMatching} className="bg-gray-700 hover:bg-gray-600 px-4 py-3 rounded-xl font-bold transition flex items-center gap-2">
                      <RefreshCw size={18} /> å†ç”Ÿæˆ
                    </button>
                    <button onClick={handlePublish} className="bg-gradient-to-r from-orange-500 to-red-500 px-6 py-3 rounded-xl font-bold shadow-lg hover:scale-105 transition flex items-center gap-2">
                      <Star size={18} fill="white" /> å…¬é–‹ã™ã‚‹
                    </button>
                  </>
                )}
                {phase === PHASE.PUBLISH && (
                  <>
                    <button onClick={() => updatePhase(PHASE.MATCHING)} className="bg-gray-700 hover:bg-gray-600 px-4 py-3 rounded-xl font-bold transition flex items-center gap-2">
                      <ArrowLeft size={18} /> æˆ»ã‚‹
                    </button>
                    <button onClick={onExport} className="bg-blue-600 hover:bg-blue-500 px-6 py-3 rounded-xl font-bold shadow-lg transition flex items-center gap-2">
                      <Download size={18} /> CSVå‡ºåŠ›
                    </button>
                    {/* ã€è¿½åŠ ã€‘ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆCSVå‡ºåŠ› */}
                    <button onClick={onExportSurvey} className="bg-emerald-600 hover:bg-emerald-500 px-6 py-3 rounded-xl font-bold shadow-lg transition flex items-center gap-2">
                      <BarChart2 size={18} /> ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆCSV
                    </button>
                    <div className="flex flex-col gap-1">
                      <button onClick={reset} className="border border-red-500/50 text-red-400 hover:bg-red-500/10 px-4 py-2 rounded-lg font-bold text-xs transition">
                        ãƒªã‚»ãƒƒãƒˆ
                      </button>
                      <button onClick={onDeleteAll} className="bg-red-900/30 text-red-500 hover:bg-red-900/50 px-4 py-1 rounded-lg font-bold text-[10px] transition border border-red-900">
                        å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
                      </button>
                    </div>
                  </>
                )}
              </div>
            </div>

            {phase === PHASE.INPUT && <DataImporter onImport={onImportData} />}
            {(phase === PHASE.INPUT || phase === PHASE.CHECK) && <RosterStatus students={students} onSelectStudent={onSelectStudent} phase={phase} />}
          </div>
        </div>
      );
    };

    const ModernInputForm = ({ currentUser, onSave }) => {
      const [isSubmitted, setIsSubmitted] = useState(false);
      const [formData, setFormData] = useState({ classId: 1, studentNumber: 1, name: "", category: "", theme: "", topics: [], approaches: [], skills: [], comment: "" });

      useEffect(() => {
        if (currentUser) {
          setFormData(prev => ({ ...prev, ...currentUser }));
          if (currentUser.comment) setIsSubmitted(true);
        }
      }, [currentUser]);

      const handleSubmit = () => { onSave(formData); setIsSubmitted(true); };

      const toggleSelection = (field, value) => {
        setFormData(prev => {
          const current = prev[field] || [];
          if (current.includes(value)) return { ...prev, [field]: current.filter(v => v !== value) };
          if (field === "topics" && current.length >= 5) return prev;
          return { ...prev, [field]: [...current, value] };
        });
      };

      const currentCategory = getCategoryMeta(formData.category);
      const isCategoryLocked = !!currentUser.category;
      const isThemeLocked = !!currentUser.theme;
      const sectionTitleClass = "text-lg font-bold text-gray-800 mb-4 flex items-center gap-2 border-b-2 border-gray-100 pb-2";

      if (isSubmitted) {
        return (
          <div className="flex flex-col items-center justify-center min-h-[70vh] p-6 text-center">
            <div className="bg-blue-50 p-6 rounded-full mb-6 animate-pulse"><CheckCircle size={64} className="text-blue-500" /></div>
            <h2 className="text-3xl font-black text-gray-800 mb-2">ç™»éŒ²å®Œäº†ï¼</h2>
            <p className="text-gray-500 mb-8">å…ˆç”Ÿã‹ã‚‰ã®åˆå›³ãŒã‚ã‚‹ã¾ã§ã€ã“ã®ã¾ã¾ãŠå¾…ã¡ãã ã•ã„ã€‚</p>
            <button onClick={() => setIsSubmitted(false)} className="flex items-center gap-2 text-gray-400 hover:text-gray-600 font-bold transition">
              <Edit3 size={16} /> ä¿®æ­£ã™ã‚‹
            </button>
          </div>
        );
      }

      return (
        <div className="max-w-xl mx-auto p-6 pb-24">
          <div className="text-center mb-8">
            <h2 className="text-3xl font-black text-gray-800 mb-2">My Profile</h2>
            <p className="text-gray-500">ã‚ãªãŸã®ã€Œå¾—æ„ã€ã‚„ã€Œèˆˆå‘³ã€ã‚’æ•™ãˆã¦ãã ã•ã„</p>
          </div>

          <div className="space-y-8">
            <section className="bg-white p-6 rounded-3xl shadow-sm border border-gray-100 relative overflow-hidden">
              <div className="absolute top-0 right-0 bg-gray-100 px-3 py-1 rounded-bl-xl text-xs text-gray-500 font-bold flex items-center gap-1"><Lock size={10} /> å›ºå®šæƒ…å ±</div>
              <div className="flex gap-4 mb-4">
                <div className="w-1/3">
                  <label className="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Class</label>
                  <div className="w-full p-3 bg-gray-100 rounded-xl font-bold text-gray-700">{formData.classId}çµ„</div>
                </div>
                <div className="w-1/3">
                  <label className="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">No.</label>
                  <div className="w-full p-3 bg-gray-100 rounded-xl font-bold text-gray-700">{formData.studentNumber}ç•ª</div>
                </div>
              </div>

              <div className="mb-4">
                <label className="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Name</label>
                <div className="w-full text-xl font-bold border-b-2 border-gray-200 py-1 bg-transparent text-gray-800">{formData.name}</div>
              </div>

              <div className="mb-4">
                <label className="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2 flex justify-between">
                  Category {isCategoryLocked ? <Lock size={12} /> : <Unlock size={12} className="text-green-500" />}
                </label>
                {isCategoryLocked ? (
                  <div className={`p-3 rounded-xl bg-gradient-to-r ${currentCategory.color} text-white shadow-sm`}>
                    <div className="text-[10px] opacity-80">{currentCategory.group}</div>
                    <div className="font-bold">{currentCategory.name}</div>
                  </div>
                ) : (
                  <select className="w-full p-3 bg-gray-50 rounded-xl font-bold text-gray-700 outline-none focus:ring-2 focus:ring-blue-500/50" value={formData.category} onChange={(e) => setFormData({ ...formData, category: e.target.value })}>
                    <option value="">ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                    {CATEGORIES.map(c => (<option key={c.id} value={c.id}>{c.group} : {c.name}</option>))}
                  </select>
                )}
              </div>

              <div>
                <label className="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2 flex justify-between">
                  Research Theme {isThemeLocked ? <Lock size={12} /> : <Unlock size={12} className="text-green-500" />}
                </label>
                {isThemeLocked ? (
                  <div className="w-full p-3 bg-gray-100 rounded-xl font-bold text-gray-700 text-sm leading-snug">{formData.theme}</div>
                ) : (
                  <textarea className="w-full p-3 bg-gray-50 rounded-xl text-gray-700 outline-none focus:ring-2 focus:ring-blue-500/20 font-bold text-sm" rows="2"
                    value={formData.theme} onChange={(e) => setFormData({ ...formData, theme: e.target.value })} placeholder="ç¾åœ¨è€ƒãˆã¦ã„ã‚‹æ¢ç©¶ã®ãƒ†ãƒ¼ãƒã‚’å…¥åŠ›" />
                )}
              </div>
            </section>

            <section>
              <label className={sectionTitleClass}>
                <Sparkles size={20} className="text-purple-500" /> ãƒˆãƒ”ãƒƒã‚¯ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠï¼ˆæœ€å¤§5ã¤ï¼‰
                <span className="ml-auto text-xs font-bold text-blue-500 bg-blue-50 px-2 py-1 rounded-full">{(formData.topics || []).length}/5</span>
              </label>
              <div className="flex flex-wrap gap-2">
                {TOPIC_TAGS.map(t => (
                  <button key={t.id} onClick={() => toggleSelection("topics", t.id)}
                    className={`text-xs px-4 py-2 rounded-lg border font-bold transition-all duration-200 ${(formData.topics || []).includes(t.id) ? getTagStyle(t.id, true) : getTagStyle(t.id, false)}`}>
                    {t.name}
                  </button>
                ))}
              </div>
            </section>

            <section>
              <label className={sectionTitleClass}><Settings size={20} className="text-green-500" /> ã‚¢ãƒ—ãƒ­ãƒ¼ãƒï¼ˆè¤‡æ•°å¯ï¼‰</label>
              <div className="flex flex-wrap gap-2">
                {APPROACH_TAGS.map(a => (
                  <button key={a.id} onClick={() => toggleSelection("approaches", a.id)}
                    className={`text-xs px-4 py-2 rounded-lg border font-bold transition-all duration-200 flex items-center gap-2 ${(formData.approaches || []).includes(a.id) ? "bg-green-600 border-green-600 text-white shadow-md transform scale-105" : "bg-white border-gray-200 text-gray-600 hover:border-green-300 hover:bg-gray-50"}`}>
                    <span>{a.icon}</span><span>{a.name}</span>
                  </button>
                ))}
              </div>
            </section>

            <section>
              <label className={sectionTitleClass}><Zap size={20} className="text-orange-500" /> ã‚¹ã‚­ãƒ«ï¼ˆè¤‡æ•°å¯ï¼‰</label>
              <div className="flex flex-wrap gap-2">
                {SKILLS.map(s => (
                  <button key={s} onClick={() => toggleSelection("skills", s)}
                    className={`text-xs px-4 py-2 rounded-lg border font-bold transition-all duration-200 ${(formData.skills || []).includes(s) ? "bg-purple-600 border-purple-600 text-white shadow-md transform scale-105" : "bg-white border-gray-200 text-gray-600 hover:border-purple-300 hover:bg-gray-50"}`}>
                    {s}
                  </button>
                ))}
              </div>
            </section>

            <section className="bg-white p-6 rounded-3xl shadow-sm border border-gray-100">
              <label className={sectionTitleClass}><Smile size={20} className="text-pink-500" /> ã²ã¨ã“ã¨</label>
              <textarea className="w-full p-4 bg-gray-50 rounded-2xl text-gray-700 outline-none focus:ring-2 focus:ring-blue-500/20" rows="3"
                value={formData.comment} onChange={(e) => setFormData({ ...formData, comment: e.target.value })}
                placeholder="ç‰¹ã«ã‚„ã‚ŠãŸã„ã“ã¨ã€ã“ã‚“ãªäººï¼ˆã‚„ã‚‹æ°—ã‚„ã‚¹ã‚­ãƒ«ï¼‰ã‚’å‹Ÿé›†ï¼ãªã©ã‚’è¨˜è¿°ã€‚" />
            </section>

            <button onClick={handleSubmit} className="w-full bg-gray-900 text-white font-bold text-lg py-4 rounded-2xl shadow-xl hover:bg-gray-800 hover:scale-[1.02] transition-all">
              ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç™»éŒ²å®Œäº†
            </button>
          </div>
        </div>
      );
    };

    // --- Logic: Candidate Recommendation ---
    const getRecommendedCandidates = (currentUser, allStudents) => {
      if (!currentUser || !allStudents) return [];

      const votedIds = Object.keys(currentUser.votes || {});
      const candidates = allStudents.filter(s => s.id !== currentUser.id && !votedIds.includes(s.id));

      const scoredCandidates = candidates.map(student => {
        let score = 0;
        if (student.category && student.category === currentUser.category) score += 3;

        const cTopics = student.topics || [];
        const myTopics = currentUser.topics || [];
        score += cTopics.filter(t => myTopics.includes(t)).length * 5;

        const cApps = student.approaches || [];
        const myApps = currentUser.approaches || [];
        score += cApps.filter(a => myApps.includes(a)).length * 2;

        return { ...student, affinityScore: score };
      });

      scoredCandidates.sort((a, b) => b.affinityScore - a.affinityScore);

      const currentVoteCount = votedIds.length;
      const remainingCount = Math.max(0, 30 - currentVoteCount);

      const topSlice = Math.min(remainingCount, scoredCandidates.length);
      return scoredCandidates.slice(0, topSlice);
    };

    // --- CardStack (CHECK) ---
    // ã€ä¿®æ­£ã€‘é€šä¿¡å›æ•°å‰Šæ¸›ï¼šæŠ•ç¥¨ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã«æºœã‚ã€30ä»¶åˆ°é”ã§ã¾ã¨ã‚ã¦ä¿å­˜ã™ã‚‹ï¼ˆAppå´ã§flushï¼‰
    // ãã®ãŸã‚ã€ã‚«ãƒ¼ãƒ‰å€™è£œã¯ã€Œé–‹å§‹æ™‚ç‚¹ã€ã§å›ºå®šã—ã¦é€²è¡Œï¼ˆé€”ä¸­ã§voteså¤‰åŒ–ã—ã¦ã‚‚å€™è£œãŒã‚ºãƒ¬ãªã„ã‚ˆã†ã«ã™ã‚‹ï¼‰
    const CardStack = ({ currentUser, students, onVote }) => {
      const [currentIndex, setCurrentIndex] = useState(0);
      const [direction, setDirection] = useState(null);
      const [selections, setSelections] = useState({ direction: false, skill: false, love: false });
      const [candidates, setCandidates] = useState([]);
      const initializedRef = useRef(false);

      const currentStudent = candidates[currentIndex];

      useEffect(() => { setSelections({ direction: false, skill: false, love: false }); }, [currentIndex]);

      // å€™è£œã¯ã€ŒCHECKé–‹å§‹æ™‚ç‚¹ã€ã§å›ºå®šï¼ˆcurrentUser.votes ã¯ App å´ã§ base+pending ã‚’åˆæˆã—ã¦æ¸¡ã•ã‚Œã‚‹ï¼‰
      useEffect(() => {
        if (!currentUser || !students) return;
        if (initializedRef.current) return;

        initializedRef.current = true;

        // getRecommendedCandidates ã¨åŒç­‰ã®ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆãŸã ã—ã€Œé–‹å§‹æ™‚ã®æ®‹æ•°ã€ã§å›ºå®šï¼‰
        const votedIds = Object.keys(currentUser.votes || {});
        const baseCandidates = students.filter(s => s.id !== currentUser.id && !votedIds.includes(s.id));

        const scored = baseCandidates.map(student => {
          let score = 0;
          if (student.category && student.category === currentUser.category) score += 3;

          const cTopics = student.topics || [];
          const myTopics = currentUser.topics || [];
          score += cTopics.filter(t => myTopics.includes(t)).length * 5;

          const cApps = student.approaches || [];
          const myApps = currentUser.approaches || [];
          score += cApps.filter(a => myApps.includes(a)).length * 2;

          return { ...student, affinityScore: score };
        });

        scored.sort((a, b) => b.affinityScore - a.affinityScore);

        const remainingCount = Math.max(0, 30 - votedIds.length);
        const topSlice = Math.min(remainingCount, scored.length);

        setCandidates(scored.slice(0, topSlice));
        setCurrentIndex(0);
      }, [students, currentUser?.id]);

      const toggleSelection = (type) => setSelections(prev => ({ ...prev, [type]: !prev[type] }));
      const hasSelection = useMemo(() => Object.values(selections).some(v => v), [selections]);

      const handleSwipe = (dir) => {
        if (!currentStudent || direction || (dir === "right" && !hasSelection)) return;
        setDirection(dir);

        // Always record vote (even skip)
        const voteData = dir === "right" ? selections : { skipped: true };
        onVote(currentStudent.id, voteData);

        setTimeout(() => { setDirection(null); setCurrentIndex(prev => prev + 1); }, 400);
      };

      if (currentIndex >= candidates.length) {
        return (
          <div className="flex flex-col items-center justify-center h-[70vh] text-center p-6">
            <div className="bg-green-100 p-6 rounded-full mb-6 animate-bounce"><CheckCircle size={64} className="text-green-600" /></div>
            <h2 className="text-2xl font-bold text-gray-800 mb-2">ãƒã‚§ãƒƒã‚¯å®Œäº†ï¼</h2>
            <p className="text-gray-500">å…ˆç”Ÿã®ãƒãƒƒãƒãƒ³ã‚°é–‹å§‹ã‚’ãŠå¾…ã¡ãã ã•ã„ã€‚</p>
          </div>
        );
      }

      const categoryData = getCategoryMeta(currentStudent?.category);
      let cardClass = "absolute inset-0 bg-white rounded-3xl shadow-2xl border border-gray-100 overflow-hidden flex flex-col transition-all duration-500 ease-out";
      if (direction === "left") cardClass += " transform -translate-x-[150%] -rotate-12 opacity-0";
      else if (direction === "right") cardClass += " transform translate-x-[150%] rotate-12 opacity-0";

      return (
        <div className="flex flex-col items-center justify-center min-h-[85vh] p-4 overflow-hidden relative">
          <div className="w-full max-w-md aspect-[3/4] relative">
            {currentIndex + 1 < candidates.length && (
              <div className="absolute top-4 left-4 right-4 bottom-4 bg-gray-50 rounded-3xl border border-gray-200 shadow-sm -z-10 transform scale-95 opacity-50"></div>
            )}

            <div className={cardClass}>
              <div className={`h-32 bg-gradient-to-br ${categoryData.color} p-6 flex flex-col justify-end text-white relative`}>
                <div className="absolute top-4 right-4 bg-white/20 backdrop-blur px-3 py-1 rounded-full text-xs font-bold">ID: {String(currentStudent.id).slice(-4)}</div>
                <div className="absolute top-4 left-4 bg-black/20 backdrop-blur px-2 py-1 rounded text-[10px] font-mono">Match: {currentStudent.affinityScore}pt</div>
                <div className="font-bold text-sm opacity-90">{categoryData.group}</div>
                <div className="text-2xl font-black leading-none shadow-black/10 drop-shadow-md">{categoryData.name}</div>
              </div>

              <div className="flex-1 p-6 flex flex-col gap-4 overflow-y-auto pb-32">
                {currentStudent.theme && (
                  <div className="mb-2">
                    <h4 className="text-sm font-bold text-gray-800 mb-2 flex items-center gap-2 border-b border-gray-100 pb-1">
                      <Lightbulb size={16} className="text-yellow-500" /> ä»Šè€ƒãˆã¦ã„ã‚‹é¡Œæ
                    </h4>
                    <div className="bg-yellow-50/50 p-4 rounded-xl border border-yellow-100 font-bold text-gray-800 leading-snug shadow-sm">{currentStudent.theme}</div>
                  </div>
                )}

                <div>
                  <h4 className="text-sm font-bold text-gray-800 mb-2 flex items-center gap-2 border-b border-gray-100 pb-1">
                    <Sparkles size={16} className="text-purple-500" /> ãƒˆãƒ”ãƒƒã‚¯
                  </h4>
                  <div className="flex flex-wrap gap-2">
                    {currentStudent.topics?.map(tid => (
                      <span key={tid} className={`px-2 py-1 rounded-lg text-xs font-bold border ${getTagStyle(tid, false)}`}>
                        {TOPIC_TAGS.find(t => t.id === tid)?.name}
                      </span>
                    ))}
                  </div>
                </div>

                <div>
                  <h4 className="text-sm font-bold text-gray-800 mb-2 flex items-center gap-2 border-b border-gray-100 pb-1">
                    <Settings size={16} className="text-green-500" /> ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ
                  </h4>
                  <div className="flex flex-wrap gap-2">
                    {currentStudent.approaches?.map(aid => {
                      const a = APPROACH_TAGS.find(t => t.id === aid);
                      return a ? (
                        <div key={aid} className="bg-green-50 text-green-700 px-2 py-1 rounded-lg text-xs font-bold border border-green-100 flex items-center gap-1">
                          <span>{a.icon}</span><span>{a.name}</span>
                        </div>
                      ) : null;
                    })}
                  </div>
                </div>

                <div>
                  <h4 className="text-sm font-bold text-gray-800 mb-2 flex items-center gap-2 border-b border-gray-100 pb-1">
                    <Zap size={16} className="text-orange-500" /> ã‚¹ã‚­ãƒ«
                  </h4>
                  <div className="flex flex-wrap gap-2">
                    {currentStudent.skills?.map(s => (
                      <span key={s} className="bg-purple-50 text-purple-700 px-2 py-1 rounded-lg text-xs font-bold border border-purple-100">{s}</span>
                    ))}
                  </div>
                </div>

                <div className="mt-2">
                  <div className="text-sm font-bold text-gray-800 mb-2 flex items-center gap-2 border-b border-gray-100 pb-1">
                    <Smile size={16} className="text-pink-500" /> ã²ã¨ã“ã¨
                  </div>
                  <div className="bg-gray-50 p-4 rounded-xl border border-gray-100 relative">
                    <p className="text-sm text-gray-600 italic">"{currentStudent.comment}"</p>
                  </div>
                </div>
              </div>

              <div className="absolute bottom-0 left-0 right-0 bg-white/95 backdrop-blur-sm border-t p-4 pb-6 flex gap-2 justify-center">
                <button onClick={() => handleSwipe("left")} className="flex-1 py-3 rounded-xl flex flex-col items-center transition border-2 border-gray-200 text-gray-400 hover:bg-red-50 hover:text-red-500 hover:border-red-200">
                  <X size={20} /><span className="text-[10px] font-bold mt-1">ã‚¹ã‚­ãƒƒãƒ—</span>
                </button>

                <button onClick={() => toggleSelection("direction")} className={`flex-1 py-3 rounded-xl flex flex-col items-center transition border-2 ${selections.direction ? "bg-green-50 border-green-500 text-green-700" : "bg-gray-50 border-transparent text-gray-400 hover:bg-gray-100"}`}>
                  <CheckCircle size={20} className={selections.direction ? "fill-current" : ""} /><span className="text-[10px] font-bold mt-1">æ–¹å‘æ€§</span>
                </button>

                <button onClick={() => toggleSelection("skill")} className={`flex-1 py-3 rounded-xl flex flex-col items-center transition border-2 ${selections.skill ? "bg-blue-50 border-blue-500 text-blue-700" : "bg-gray-50 border-transparent text-gray-400 hover:bg-gray-100"}`}>
                  <Zap size={20} className={selections.skill ? "fill-current" : ""} /><span className="text-[10px] font-bold mt-1">ã‚¹ã‚­ãƒ«</span>
                </button>

                <button onClick={() => toggleSelection("love")} className={`flex-1 py-3 rounded-xl flex flex-col items-center transition border-2 ${selections.love ? "bg-pink-50 border-pink-500 text-pink-700" : "bg-gray-50 border-transparent text-gray-400 hover:bg-gray-100"}`}>
                  <Heart size={20} className={selections.love ? "fill-current" : ""} /><span className="text-[10px] font-bold mt-1">çµ„ã¿ãŸã„</span>
                </button>

                <button onClick={() => handleSwipe("right")} disabled={!hasSelection} className={`flex-1 py-3 rounded-xl flex flex-col items-center transition border-2 ${hasSelection ? "bg-blue-600 text-white border-blue-600" : "bg-gray-200 text-gray-400 border-gray-200"}`}>
                  <ThumbsUp size={20} /><span className="text-[10px] font-bold mt-1">é€ä¿¡</span>
                </button>
              </div>
            </div>
          </div>

          <div className="text-xs text-gray-400 mt-4 font-mono">{currentIndex + 1} / {candidates.length} Cards</div>
        </div>
      );
    };

    const ModernResultView = ({ currentUser, students, groups, isPublished }) => {
      const [selectedMember, setSelectedMember] = useState(null);

      if (!isPublished) {
        return (
          <div className="flex flex-col items-center justify-center min-h-[60vh] p-8 text-center">
            <h2 className="text-3xl font-black text-gray-800 mb-2">Analyzing...</h2>
            <p className="text-gray-500">å…ˆç”ŸãŒæœ€é©ãªãƒãƒ¼ãƒ ã‚’æ§‹æˆä¸­ã§ã™ã€‚<br />ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚</p>
          </div>
        );
      }

      const myGroupIndex = groups.findIndex(g => (g.members ? g.members.includes(currentUser.id) : g.includes(currentUser.id)));
      const myGroupData = groups[myGroupIndex];
      const myGroupMemberIds = myGroupData ? (myGroupData.members || myGroupData) : [];
      const myGroupMembers = myGroupMemberIds.map(id => students.find(s => s.id === id)).filter(Boolean);

      // ã€è¿½åŠ ã€‘è‡ªåˆ†ã®TEAMãƒ©ãƒ™ãƒ«ï¼ˆTEAM 01å½¢å¼ï¼‰ã‚’ç®—å‡ºã—ã¦ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆä¿å­˜å…ˆã«ä½¿ã†
      const myTeamIdLabel = (myGroupIndex !== -1) ? `TEAM ${String(myGroupIndex + 1).padStart(2, "0")}` : "";

      return (
        <div className="min-h-screen bg-gradient-to-b from-blue-50 to-white p-6 pt-12 relative">
          <div className="max-w-2xl mx-auto">
            <div className="text-center mb-10">
              <div className="inline-block bg-yellow-400 text-yellow-900 font-black text-xs px-3 py-1 rounded-full uppercase tracking-widest mb-4 shadow-lg transform -rotate-2">Team Matched!</div>
              {myGroupIndex !== -1 && <h1 className="text-5xl font-black text-blue-600 mb-2 tracking-tight drop-shadow-sm">TEAM {myGroupIndex + 1}</h1>}
              <h2 className="text-2xl font-bold text-gray-900 mb-2">ã‚ãªãŸã®ãƒãƒ¼ãƒ </h2>
            </div>

            <div className="grid gap-4">
              {myGroupMembers.map((member) => {
                const isMe = member.id === currentUser.id;
                const cat = getCategoryMeta(member.category);
                return (
                  <div
                    key={member.id}
                    onClick={() => setSelectedMember(member)}
                    className="bg-white rounded-2xl p-4 shadow-xl border border-gray-100 flex items-center gap-4 transform hover:scale-[1.02] transition duration-300 cursor-pointer hover:bg-gray-50"
                  >
                    <div className={`w-14 h-14 rounded-2xl bg-gradient-to-br ${cat.color} flex items-center justify-center text-white font-bold text-xl shadow-md`}>
                      {member.name.charAt(0)}
                    </div>
                    <div className="flex-1">
                      <div className="flex justify-between items-center mb-1">
                        <h3 className="font-bold text-lg text-gray-800 flex items-center gap-2">
                          {member.name}{isMe && <span className="bg-gray-900 text-white text-[10px] px-2 py-0.5 rounded-full">YOU</span>}
                        </h3>
                        <div className="text-xs font-bold text-gray-400">{cat.name}</div>
                      </div>
                      <div className="flex gap-2 mb-1">
                        <span className="bg-gray-50 text-gray-500 px-2 py-0.5 rounded text-[10px] font-bold">{member.classId}çµ„ {member.studentNumber}ç•ª</span>
                      </div>
                      <div className="flex flex-wrap gap-1">
                        {member.skills?.slice(0, 3).map(s => (
                          <span key={s} className="bg-purple-50 text-purple-700 px-2 py-1 rounded-lg text-xs font-bold border border-purple-100">{s}</span>
                        ))}
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>

            {/* ã€è¿½åŠ ã€‘ãƒãƒ¼ãƒ ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆï¼ˆãƒãƒ¼ãƒ å…±æœ‰ãƒ»ç·¨é›†ï¼‰ */}
            <TeamSurveyPanel teamId={myTeamIdLabel} currentUser={currentUser} />
          </div>

          {selectedMember && (
            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={() => setSelectedMember(null)}>
              <div className="bg-white text-gray-800 p-0 rounded-3xl shadow-2xl max-w-sm w-full overflow-hidden" onClick={(e) => e.stopPropagation()}>
                {(() => {
                  const cat = getCategoryMeta(selectedMember.category);
                  return (
                    <>
                      <div className={`h-24 bg-gradient-to-br ${cat.color} p-6 flex flex-col justify-end text-white relative`}>
                        <div className="absolute top-4 right-4 bg-white/20 backdrop-blur px-3 py-1 rounded-full text-xs font-bold">ID: {String(selectedMember.id).slice(-4)}</div>
                        <div className="font-bold text-sm opacity-90">{cat.group}</div>
                        <div className="text-xl font-black leading-none shadow-black/10 drop-shadow-md">{cat.name}</div>
                      </div>

                      <div className="p-6 max-h-[60vh] overflow-y-auto">
                        <h3 className="text-xl font-bold mb-1">
                          {selectedMember.name}
                          <span className="text-sm text-gray-500 font-normal ml-2">{selectedMember.classId}çµ„ {selectedMember.studentNumber}ç•ª</span>
                        </h3>

                        {selectedMember.theme && (
                          <div className="mb-4 mt-4">
                            <h4 className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1 flex items-center gap-1"><Lightbulb size={12} /> ä»Šè€ƒãˆã¦ã„ã‚‹é¡Œæ</h4>
                            <div className="bg-yellow-50 p-3 rounded-xl border border-yellow-100 font-bold text-gray-800 text-sm">{selectedMember.theme}</div>
                          </div>
                        )}

                        <div className="space-y-4 mt-4">
                          <div>
                            <h4 className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1 flex items-center gap-1"><Sparkles size={12} /> ãƒˆãƒ”ãƒƒã‚¯</h4>
                            <div className="flex flex-wrap gap-1">
                              {selectedMember.topics?.map(tid => (
                                <span key={tid} className={`px-2 py-1 rounded-md text-xs font-bold border ${getTagStyle(tid, false)}`}>{TOPIC_TAGS.find(t => t.id === tid)?.name}</span>
                              ))}
                            </div>
                          </div>

                          <div>
                            <h4 className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1 flex items-center gap-1"><Settings size={12} /> ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ</h4>
                            <div className="flex flex-wrap gap-1">
                              {selectedMember.approaches?.map(aid => {
                                const a = APPROACH_TAGS.find(t => t.id === aid);
                                return a ? <span key={aid} className="bg-green-50 text-green-700 px-2 py-1 rounded-md text-xs font-bold border border-green-100">{a.icon} {a.name}</span> : null;
                              })}
                            </div>
                          </div>

                          <div>
                            <h4 className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1 flex items-center gap-1"><Zap size={12} /> ã‚¹ã‚­ãƒ«</h4>
                            <div className="flex flex-wrap gap-1">
                              {selectedMember.skills?.map(s => (
                                <span key={s} className="bg-purple-50 text-purple-700 px-2 py-1 rounded-md text-xs font-bold border border-purple-100">{s}</span>
                              ))}
                            </div>
                          </div>

                          <div>
                            <h4 className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1 flex items-center gap-1"><Smile size={12} /> ã²ã¨ã“ã¨</h4>
                            <div className="bg-gray-50 p-3 rounded-xl border border-gray-100 text-sm text-gray-600 italic">"{selectedMember.comment}"</div>
                          </div>
                        </div>
                      </div>

                      <div className="p-4 border-t border-gray-100 bg-gray-50 text-center">
                        <button onClick={() => setSelectedMember(null)} className="bg-gray-800 text-white px-8 py-2 rounded-full font-bold text-sm hover:bg-gray-700 transition">é–‰ã˜ã‚‹</button>
                      </div>
                    </>
                  );
                })()}
              </div>
            </div>
          )}
        </div>
      );
    };

    const App = () => {
      const [user, setUser] = useState(null);
      const [currentUserData, setCurrentUserData] = useState(null);
      const [students, setStudents] = useState([]);
      const [phase, setPhase] = useState(PHASE.INPUT);
      const [groups, setGroups] = useState([]);
      const [errorMsg, setErrorMsg] = useState("");
      const [isDemoMode, setIsDemoMode] = useState(false);
      const [selectedStudent, setSelectedStudent] = useState(null);
      const [moveTargetGroup, setMoveTargetGroup] = useState("");

      // ã€è¿½åŠ ã€‘CHECKæŠ•ç¥¨ã®ãƒãƒƒãƒ•ã‚¡ï¼ˆ30ä»¶ã¾ã¨ã‚ã¦ä¿å­˜ï¼‰
      const [pendingVotes, setPendingVotes] = useState({});
      const [pendingLoaded, setPendingLoaded] = useState(false);
      const [isFlushingVotes, setIsFlushingVotes] = useState(false);

      const NEW_TEAM_VALUE = "__NEW_TEAM__"; // ã€è¿½åŠ ã€‘ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã§ã€Œæ–°ã—ã„ç­ã‚’ä½œæˆã€ç”¨

      // ã€è¿½åŠ ã€‘æ•™å“¡ç”¨ï¼šãƒãƒ¼ãƒ ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå…¨ä½“
      const [teamSurveyMap, setTeamSurveyMap] = useState({});

      useEffect(() => {
        const timer = setTimeout(() => {
          console.log("Auto reloading...");
          window.location.reload();
        }, 3600000);
        return () => clearTimeout(timer);
      }, []);

      // Auth Listener
      useEffect(() => {
        const unsubscribe = onAuthStateChanged(auth, (u) => {
          setUser(u);
        });
        return () => unsubscribe();
      }, []);

      // User Data Listener
      useEffect(() => {
        if (!user) {
          setCurrentUserData(null);
          return;
        }
        const unsubUser = onSnapshot(doc(db, "users", user.email), (docSnap) => {
          if (docSnap.exists()) {
            setCurrentUserData(docSnap.data());
          } else {
            setErrorMsg("ã“ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ç®¡ç†è€…ã«å•ã„åˆã‚ã›ã¦ãã ã•ã„ã€‚");
            signOut(auth);
          }
        }, (error) => {
          console.error("User listener error:", error);
        });
        return () => unsubUser();
      }, [user]);

      useEffect(() => {
        if (!user) return;

        const unsubSystem = onSnapshot(doc(db, "system", "config"), (docSnap) => {
          if (docSnap.exists()) setPhase(docSnap.data().phase || PHASE.INPUT);
        });

        const unsubStudents = onSnapshot(collection(db, "users"), (snapshot) => {
          const loadedStudents = snapshot.docs
            .map(d => ({ id: d.id, ...d.data() }))
            .filter(u => u.role !== "teacher" && u.role !== "admin");
          setStudents(loadedStudents);
        });

        const unsubGroups = onSnapshot(doc(db, "system", "groups"), (docSnap) => {
          if (docSnap.exists()) {
            const rawList = docSnap.data().list || [];
            const formattedGroups = rawList.map(item => Array.isArray(item) ? { members: item, metrics: {} } : item);
            setGroups(formattedGroups);
          } else {
            setGroups([]);
          }
        });

        return () => { unsubSystem(); unsubStudents(); unsubGroups(); };
      }, [user]);

      // ã€è¿½åŠ ã€‘æ•™å“¡ï¼šteamSurveys ã‚’è³¼èª­ï¼ˆå›ç­”çŠ¶æ³ç¢ºèªï¼†CSVç”¨ï¼‰
      useEffect(() => {
        if (!user || !currentUserData) { setTeamSurveyMap({}); return; }
        const isTeacher = currentUserData.role === "teacher" || currentUserData.role === "admin";
        if (!isTeacher) { setTeamSurveyMap({}); return; }

        const unsub = onSnapshot(collection(db, "teamSurveys"), (snap) => {
          const map = {};
          snap.docs.forEach(d => { map[d.id] = d.data(); });
          setTeamSurveyMap(map);
        }, (e) => console.error("teamSurveys snapshot error:", e));

        return () => unsub();
      }, [user, currentUserData?.role]);

      // ã€è¿½åŠ ã€‘pendingVotesã‚’localStorageã‹ã‚‰å¾©å…ƒï¼ˆCHECKä¸­ã®é€šä¿¡å‰Šæ¸›ã®ãŸã‚ï¼‰
      useEffect(() => {
        if (!user) { setPendingVotes({}); setPendingLoaded(false); return; }
        setPendingLoaded(false);
        try {
          const key = `kmatch_pendingVotes_${user.email}`;
          const raw = localStorage.getItem(key);
          setPendingVotes(raw ? (JSON.parse(raw) || {}) : {});
        } catch (e) {
          setPendingVotes({});
        } finally {
          setPendingLoaded(true);
        }
      }, [user?.email]);

      const handleLogin = async () => {
        try {
          await signInWithPopup(auth, new GoogleAuthProvider());
          setErrorMsg("");
        } catch (error) {
          console.error(error);
          if (error.code === "auth/unauthorized-domain") setErrorMsg(`ã€è¨­å®šã‚¨ãƒ©ãƒ¼ã€‘ã“ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ (${window.location.hostname}) ã¯Firebaseã§è¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚Firebaseã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã® Authentication > è¨­å®š > æ‰¿èªæ¸ˆã¿ãƒ‰ãƒ¡ã‚¤ãƒ³ ã«ã“ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚`);
          else if (error.code === "auth/api-key-not-valid" || String(error.message).includes("api-key-not-valid")) setErrorMsg("ã€è¨­å®šã‚¨ãƒ©ãƒ¼ã€‘APIã‚­ãƒ¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚index.htmlå†…ã® firebaseConfig ã‚’ã€Firebaseã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ã‚³ãƒ”ãƒ¼ã—ãŸæœ¬ç‰©ã®å€¤ã«æ›¸ãæ›ãˆã¦ãã ã•ã„ã€‚");
          else if (error.code === "auth/popup-closed-by-user") setErrorMsg("ãƒ­ã‚°ã‚¤ãƒ³æ“ä½œãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸã€‚");
          else setErrorMsg("ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message);
        }
      };

      const handleLogout = () => signOut(auth);

      const handleSaveProfile = async (data) => {
        if (!user) return;
        if (currentUserData.role === "teacher" || currentUserData.role === "admin") {
          alert("ã€ç¢ºèªã€‘ç®¡ç†è€…ã®ãŸã‚ã€ãƒ‡ãƒ¼ã‚¿ã¯ä¿å­˜ã•ã‚Œã¾ã›ã‚“ï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰ï¼‰");
          return;
        }
        await updateDoc(doc(db, "users", user.email), { ...data, updatedAt: new Date() });
      };

      // Vote Handling:
      // ã€ä¿®æ­£ã€‘CHECKä¸­ã¯ 1æŠ•ç¥¨ã”ã¨ã«Firestoreã¸æ›¸ãè¾¼ã¾ãšã€ãƒ­ãƒ¼ã‚«ãƒ«ã«ãƒãƒƒãƒ•ã‚¡ã—ã¦30ä»¶åˆ°é”ã§ã¾ã¨ã‚ã¦ä¿å­˜
      const handleVote = async (targetId, selections) => {
        if (!user) return;
        if (currentUserData.role === "teacher" || currentUserData.role === "admin") { console.log("Teacher vote ignored"); return; }

        setPendingVotes(prev => {
          const next = { ...(prev || {}), [targetId]: selections };
          try {
            const key = `kmatch_pendingVotes_${user.email}`;
            localStorage.setItem(key, JSON.stringify(next));
          } catch (e) {}
          return next;
        });
      };

      // ã€è¿½åŠ ã€‘30ä»¶åˆ°é”ã§ã¾ã¨ã‚ã¦Firestoreã¸åæ˜ ï¼ˆRosterStatusãŒé»„â†’ç·‘ã«ãªã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ï¼‰
      useEffect(() => {
        if (!user || !currentUserData) return;
        if (phase !== PHASE.CHECK) return;
        if (currentUserData.role === "teacher" || currentUserData.role === "admin") return;
        if (isFlushingVotes) return;

        const baseCount = Object.keys(currentUserData.votes || {}).length;
        const pendingCount = Object.keys(pendingVotes || {}).length;

        if (pendingCount === 0) return;
        if (baseCount + pendingCount < 30) return;

        (async () => {
          setIsFlushingVotes(true);
          try {
            const userRef = doc(db, "users", user.email);
            // setDoc merge: mapã‚­ãƒ¼ã«ãƒ‰ãƒƒãƒˆãŒå«ã¾ã‚Œã¦ã‚‚å®‰å…¨ï¼ˆæ—¢å­˜è¨­è¨ˆã‚’ç¶­æŒï¼‰
            await setDoc(userRef, { votes: pendingVotes, updatedAt: new Date() }, { merge: true });

            setPendingVotes({});
            try {
              const key = `kmatch_pendingVotes_${user.email}`;
              localStorage.removeItem(key);
            } catch (e) {}
          } catch (e) {
            console.error("Flush votes error:", e);
            alert("æŠ•ç¥¨ãƒ‡ãƒ¼ã‚¿ã®ã¾ã¨ã‚ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚é€šä¿¡çŠ¶æ³ã‚’ç¢ºèªã—ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚");
          } finally {
            setIsFlushingVotes(false);
          }
        })();
      }, [pendingVotes, phase, user, currentUserData, isFlushingVotes]);

      const handleGenerateMock = () => {
        const mocks = generateMockStudents(50);
        const batch = writeBatch(db);
        mocks.forEach(data => {
          const ref = doc(db, "users", `mock_${data.id}`);
          batch.set(ref, { ...data, email: `mock_${data.id}@example.com` });
        });
        batch.commit().then(() => alert("ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿50ä»¶ã‚’è¿½åŠ ã—ã¾ã—ãŸ"));
      };

      const handleImportData = async (dataList) => {
        const batch = writeBatch(db);
        dataList.forEach(data => {
          const ref = doc(db, "users", data.email);
          batch.set(ref, data, { merge: true });
        });
        await batch.commit();
        alert(`${dataList.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç™»éŒ²ã—ã¾ã—ãŸã€‚æ—¢å­˜ã®ç”Ÿå¾’å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã¯ä¿æŒã•ã‚Œã¾ã™ã€‚`);
      };

      const handleDeleteStudent = async (studentId) => {
        if (!confirm("æœ¬å½“ã«ã“ã®ç”Ÿå¾’ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚")) return;
        await deleteDoc(doc(db, "users", studentId));
      };

      const handleDeleteAll = async () => {
        if (!confirm("ã€è­¦å‘Šã€‘å…¨ç”Ÿå¾’ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nCSVã«ã‚ˆã‚‹å†ç™»éŒ²ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚\næœ¬å½“ã«ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
        if (!confirm("æœ€çµ‚ç¢ºèªï¼šæœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
        const batch = writeBatch(db);
        students.forEach(s => { batch.delete(doc(db, "users", s.id)); });
        await batch.commit();
        alert("å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚");
      };

      // ã€ä¿®æ­£ã€‘ç®¡ç†ç”»é¢ã§ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼å¤‰æ›´
      const handleUpdateCategory = async (studentId, newCategory) => {
        await updateDoc(doc(db, "users", studentId), { category: newCategory });
        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒ†ãƒ¼ãƒˆã‚‚å³åº§ã«åæ˜ ï¼ˆRosterStatusã®è¡¨ç¤ºæ›´æ–°ç”¨ï¼‰
        setStudents(prev => prev.map(s => s.id === studentId ? { ...s, category: newCategory } : s));
      };

      // ã€ä¿®æ­£ã€‘ç®¡ç†ç”»é¢ã§ã®ãƒãƒ¼ãƒ ç§»å‹•ï¼†å†è¨ˆç®—ï¼ˆï¼‹æ–°è¦TEAMä½œæˆã‚’ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã§å¯¾å¿œï¼‰
      const handleMoveStudent = async (studentId, targetGroupIdx) => {
        if (targetGroupIdx === "") return;

        // æ–°è¦TEAMä½œæˆã®å ´åˆï¼šæœ«å°¾ã«ç©ºãƒãƒ¼ãƒ ã‚’è¿½åŠ ã—ã¦ãã“ã¸ç§»å‹•
        let idx = null;
        const newGroups = [...groups].map(g => Array.isArray(g)
          ? [...g]
          : ({ ...g, members: [...(g.members || [])], metrics: { ...(g.metrics || {}) } })
        );

        if (targetGroupIdx === "__NEW_TEAM__") {
          // æ–°è¦ãƒãƒ¼ãƒ ã‚’æœ«å°¾ã«è¿½åŠ 
          newGroups.push({ members: [], metrics: {} });
          idx = newGroups.length - 1;
        } else {
          idx = parseInt(targetGroupIdx);
        }

        if (isNaN(idx) || idx < 0 || idx >= newGroups.length) return;

        // åˆ†é‡ä¸ä¸€è‡´ãƒã‚§ãƒƒã‚¯
        const targetGroup = (newGroups[idx].members || newGroups[idx]);
        const student = students.find(s => s.id === studentId);

        const isCompatible = targetGroup.every(mid => {
          const m = students.find(s => s.id === mid);
          return isSameField(m?.category, student?.category);
        });

        if (!isCompatible && !confirm("ã€è­¦å‘Šã€‘ç§»å‹•å…ˆã®ãƒãƒ¼ãƒ ã¨ã¯ã€Œåˆ†é‡ã€ãŒç•°ãªã‚Šã¾ã™ï¼\nåŸºæœ¬ãƒ«ãƒ¼ãƒ«ã§ã¯ç¦æ­¢ã•ã‚Œã¦ã„ã¾ã™ãŒã€å¼·åˆ¶çš„ã«ç§»å‹•ã—ã¾ã™ã‹ï¼Ÿ")) {
          return;
        }

        // å…ƒã®ã‚°ãƒ«ãƒ¼ãƒ—ã‹ã‚‰å‰Šé™¤
        newGroups.forEach(g => {
          if (Array.isArray(g)) {
            const i = g.indexOf(studentId);
            if (i !== -1) g.splice(i, 1);
          } else {
            const i = (g.members || []).indexOf(studentId);
            if (i !== -1) g.members.splice(i, 1);
          }
        });

        // æ–°ã—ã„ã‚°ãƒ«ãƒ¼ãƒ—ã«è¿½åŠ 
        if (Array.isArray(newGroups[idx])) newGroups[idx].push(studentId);
        else newGroups[idx].members.push(studentId);

        // å…¨ã‚°ãƒ«ãƒ¼ãƒ—ã®Metricså†è¨ˆç®—
        const allVotes = {};
        students.forEach(s => { if (s.votes) allVotes[s.id] = s.votes; });

        const updatedFirestoreData = newGroups.map(g => {
          const members = Array.isArray(g) ? g : g.members;
          const memberObjs = members.map(mid => students.find(s => s.id === mid)).filter(Boolean);
          const metrics = calculateTeamMetrics(memberObjs, students, allVotes);
          return { members, metrics };
        });

        await setDoc(doc(db, "system", "groups"), { list: updatedFirestoreData });
        setMoveTargetGroup("");
        setSelectedStudent(null);
        alert("ç§»å‹•å®Œäº†ã€‚ãƒãƒ¼ãƒ ã‚¹ã‚³ã‚¢ã‚’å†è¨ˆç®—ã—ã¾ã—ãŸã€‚");
      };

      const handleMatching = async () => {
        await updateDoc(doc(db, "system", "config"), { phase: PHASE.MATCHING });

        const allVotes = {};
        students.forEach(s => { if (s.votes) allVotes[s.id] = s.votes; });

        const result = runWeightedMatchingAlgorithm(students, allVotes);

        const firestoreData = result.map(group => {
          const members = group;
          const memberObjs = members.map(mid => students.find(s => s.id === mid)).filter(Boolean);
          const metrics = calculateTeamMetrics(memberObjs, students, allVotes);
          return { members, metrics };
        });

        await setDoc(doc(db, "system", "groups"), { list: firestoreData });
      };

      const handlePublish = async () => { await updateDoc(doc(db, "system", "config"), { phase: PHASE.PUBLISH }); };

      const handleReset = async () => {
        if (!confirm("æœ¬å½“ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) return;
        await updateDoc(doc(db, "system", "config"), { phase: PHASE.INPUT });
        await setDoc(doc(db, "system", "groups"), { list: [] });
      };

      const handleExportCSV = () => {
        const studentHeaders = ["Team ID", "Class", "Number", "Name", "Email", "Category", "Theme", "Topics", "Approaches", "Skills", "Comment"];
        const teamHeaders = ["", "", "Team ID (List)", "Member Emails", "Team Score", "Mutual Pairs", "Connection Score", "Interest Score", "Diversity Score"];

        const studentRows = [];
        const teamRows = [];

        groups.forEach((groupData, groupIdx) => {
          const teamName = `TEAM ${groupIdx + 1}`;
          const groupMembers = groupData.members || groupData;
          const metrics = groupData.metrics || {};

          const teamEmails = groupMembers.map(sid => {
            const s = students.find(st => st.id === sid);
            return s ? s.email : "";
          }).filter(e => e).join(", ");

          teamRows.push([
            teamName,
            `"${teamEmails}"`,
            metrics.score || 0,
            metrics.mutualPairs || 0,
            metrics.connection || 0,
            metrics.interest || 0,
            metrics.diversity || 0
          ]);

          groupMembers.forEach(studentId => {
            const student = students.find(s => s.id === studentId);
            if (student) {
              const catName = CATEGORIES.find(c => c.id === student.category)?.name || "";
              const topicNames = (student.topics || []).map(tid => TOPIC_TAGS.find(t => t.id === tid)?.name).join("|");
              const approachNames = (student.approaches || []).map(aid => APPROACH_TAGS.find(a => a.id === aid)?.name).join("|");
              const skillNames = (student.skills || []).join("|");
              studentRows.push([
                teamName,
                student.classId,
                student.studentNumber,
                student.name,
                student.email,
                catName,
                `"${student.theme || ""}"`,
                `"${topicNames}"`,
                `"${approachNames}"`,
                `"${skillNames}"`,
                `"${student.comment || ""}"`
              ]);
            }
          });
        });

        const maxRows = Math.max(studentRows.length, teamRows.length);
        const combinedRows = [];
        combinedRows.push([...studentHeaders, ...teamHeaders].join(","));

        for (let i = 0; i < maxRows; i++) {
          const left = studentRows[i] ? studentRows[i].join(",") : new Array(studentHeaders.length).fill("").join(",");
          const rightData = teamRows[i] ? teamRows[i].join(",") : ",";
          const right = teamRows[i] ? `, ,${rightData}` : ", , , , , , ,";
          combinedRows.push(`${left}${right}`);
        }

        const csvContent = combinedRows.join("\n");
        const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
        const blob = new Blob([bom, csvContent], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.setAttribute("download", "teams_and_emails.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      };

      // ã€è¿½åŠ ã€‘ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆCSVå‡ºåŠ›ï¼ˆteamSurveysï¼‰
      const handleExportSurveyCSV = () => {
        const headers = ["TEAM", "é¡Œæ", "å•ã„", "æ¸¬ã‚‹æŒ‡æ¨™ãƒ»æ•°", "æ“ä½œã™ã‚‹æ¡ä»¶", "æƒãˆã‚‹ã¹ãæ¡ä»¶", "ç”¨èªã®å®šç¾©", "ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰", "æœ€çµ‚æ›´æ–°", "æ›´æ–°è€…"];
        const rows = [headers.map(escapeCsv).join(",")];

        TEAM_SURVEY_TEAMS.forEach(teamId => {
          const d = teamSurveyMap?.[teamId] || {};
          rows.push([
            escapeCsv(teamId),
            escapeCsv(d.topic || ""),
            escapeCsv(d.question || ""),
            escapeCsv(d.metric || ""),
            escapeCsv(d.manipulate || ""),
            escapeCsv(d.control || ""),
            escapeCsv(d.definition || ""),
            escapeCsv(d.keywords || ""),
            escapeCsv(d.updatedAt ? fmtDateTime(d.updatedAt) : ""),
            escapeCsv(d.updatedBy || "")
          ].join(","));
        });

        const csvContent = rows.join("\n");
        const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
        const blob = new Blob([bom, csvContent], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.setAttribute("download", "team_survey_answers.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      };

      if (!user) return <LoginScreen onLogin={handleLogin} />;
      if (errorMsg) {
        return (
          <div className="min-h-screen flex items-center justify-center p-4">
            <div className="bg-red-50 text-red-600 p-6 rounded-xl border border-red-200 text-center">
              <AlertCircle className="mx-auto mb-2" />{errorMsg}
            </div>
          </div>
        );
      }
      if (!currentUserData) return <div className="min-h-screen flex items-center justify-center">Loading...</div>;

      const isTeacher = currentUserData.role === "teacher" || currentUserData.role === "admin";

      // ã€è¿½åŠ ã€‘CHECKè¡¨ç¤ºç”¨ï¼šFirestoreã®votes + pendingVotes ã‚’åˆæˆã—ã¦ CardStack ã¸æ¸¡ã™
      const mergedVotesForCheck = { ...(currentUserData.votes || {}), ...(pendingVotes || {}) };
      const currentUserForCheck = (phase === PHASE.CHECK)
        ? ({ ...currentUserData, votes: mergedVotesForCheck })
        : currentUserData;

      const surveyAnsweredCount = TEAM_SURVEY_TEAMS.filter(t => !!teamSurveyMap?.[t]).length;

      return (
        <div className="min-h-screen bg-gray-50 font-sans text-gray-800 selection:bg-blue-200">
          <header className="bg-white/80 backdrop-blur-md border-b border-gray-200 sticky top-0 z-50">
            <div className="max-w-4xl mx-auto px-4 h-16 flex justify-between items-center">
              <div className="flex items-center gap-2">
                <div className="bg-gradient-to-tr from-blue-500 to-purple-500 text-white p-2 rounded-xl shadow-lg">
                  <Sparkles size={20} fill="white" />
                </div>
                <div><h1 className="font-bold text-gray-800 leading-tight">K-MATCH</h1></div>
              </div>
              <div className="flex items-center gap-3">
                <span className="text-xs font-bold px-3 py-1 bg-gray-100 rounded-full text-gray-600">{phase}</span>
                <button onClick={handleLogout} className="text-gray-400 hover:text-gray-600"><LogOut size={20} /></button>
              </div>
            </div>
          </header>

          {isTeacher && (
            <TeacherPanel
              phase={phase}
              students={students}
              studentCount={students.length}
              handleMatching={handleMatching}
              handlePublish={handlePublish}
              onExport={handleExportCSV}
              onExportSurvey={handleExportSurveyCSV}
              reset={handleReset}
              onImportData={handleImportData}
              onDeleteStudent={handleDeleteStudent}
              onDeleteAll={handleDeleteAll}
              isDemoMode={isDemoMode}
              setIsDemoMode={setIsDemoMode}
              onGenerateDemo={handleGenerateMock}
              onSelectStudent={setSelectedStudent}
              surveyAnsweredCount={surveyAnsweredCount}
            />
          )}

          <main>
            {((!isTeacher) || (isTeacher && phase !== PHASE.MATCHING && phase !== PHASE.PUBLISH)) && (
              <div className={isTeacher ? "border-4 border-green-500 rounded-xl m-4 relative overflow-hidden bg-gray-100" : ""}>
                {isTeacher && (
                  <div className="absolute top-0 left-0 bg-green-500 text-white px-3 py-1 text-xs font-bold rounded-br-xl z-50 flex items-center gap-1">
                    <Eye size={12} /> ç”Ÿå¾’ç”»é¢ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ (æ“ä½œç„¡åŠ¹)
                  </div>
                )}
                {phase === PHASE.INPUT && <ModernInputForm currentUser={currentUserData} onSave={handleSaveProfile} />}
                {phase === PHASE.CHECK && (
                  (!pendingLoaded && !isTeacher)
                    ? <div className="min-h-[60vh] flex items-center justify-center text-gray-500">Loading...</div>
                    : <CardStack currentUser={currentUserForCheck} students={students} onVote={handleVote} />
                )}
              </div>
            )}

            {/* Hide preview for teacher completely during MATCHING and PUBLISH phases */}
            {!isTeacher && (phase === PHASE.MATCHING || phase === PHASE.PUBLISH) && (
              <ModernResultView currentUser={currentUserData} students={students} groups={groups} isPublished={phase === PHASE.PUBLISH} />
            )}

            {isTeacher && (phase === PHASE.MATCHING || phase === PHASE.PUBLISH) && (
              <div className="max-w-6xl mx-auto p-8 border-t border-gray-200 mt-8">
                <h3 className="font-black text-2xl mb-6 text-gray-800">å…¨ãƒãƒ¼ãƒ ä¸€è¦§ (ç®¡ç†è€…ç”¨)</h3>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                  {groups.map((groupData, idx) => {
                    const group = groupData.members || groupData;
                    const metrics = groupData.metrics || {};
                    return (
                      <div key={idx} className="bg-white rounded-2xl shadow-lg border border-gray-100 p-5 relative overflow-hidden">
                        <div className="absolute top-0 right-0 bg-gray-100 px-3 py-1 rounded-bl-xl text-xs font-bold text-gray-500 flex items-center gap-2">
                          <span>Score: {metrics.score}</span>
                          {metrics.mutualPairs > 0 && <span className="text-pink-500 flex items-center gap-0.5"><Heart size={10} fill="currentColor" />{metrics.mutualPairs}</span>}
                        </div>

                        <div className="flex justify-between items-center mb-4 pb-2 border-b border-gray-100">
                          <h4 className="font-bold text-gray-700">TEAM {idx + 1}</h4>
                          <span className="bg-blue-100 text-blue-700 text-xs font-bold px-2 py-1 rounded-md">{group.length} Members</span>
                        </div>

                        <ul className="space-y-3">
                          {group.map(sid => {
                            const s = students.find(st => st.id === sid);
                            const cat = getCategoryMeta(s?.category);
                            return (
                              <li key={sid}
                                  className="flex items-center gap-3 cursor-pointer hover:bg-gray-50 p-1 rounded transition"
                                  onClick={() => setSelectedStudent(s)} // ã€ä¿®æ­£ã€‘ç”Ÿå¾’ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°è¡¨ç¤º
                              >
                                <div className={`w-8 h-8 rounded-full bg-gradient-to-br ${cat?.color} flex items-center justify-center text-white text-xs font-bold`}>{s?.name?.charAt(0) || "?"}</div>
                                <div>
                                  <div className="font-bold text-sm text-gray-800">{s?.name}</div>
                                  <div className="text-[10px] text-gray-400">{cat?.name}</div>
                                </div>
                              </li>
                            );
                          })}
                        </ul>

                        <div className="mt-4 pt-3 border-t border-gray-50 flex justify-between text-[10px] text-gray-400">
                          <div title="çµæŸåŠ›">Con: {metrics.connection}</div>
                          <div title="å…±é€šé–¢å¿ƒ">Int: {metrics.interest}</div>
                          <div title="å¤šæ§˜æ€§">Div: {metrics.diversity}</div>
                          <div title="ã‚«ãƒ†ã‚´ãƒªç´”åº¦ (dominant/size)">Pur: {metrics.purity}</div>
                          <div title="ã‚«ãƒ†ã‚´ãƒªè·é›¢å¹³å‡ (0ãŒç†æƒ³)">dÌ„: {metrics.avgCatDistance}</div>
                          {metrics.crossFieldPairs > 0 && <div title="åˆ¥åˆ†é‡ãƒšã‚¢æ•°" className="text-red-500 font-bold">XField: {metrics.crossFieldPairs}</div>}
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            )}

            {/* ã€è¿½åŠ ã€‘æ•™å“¡ï¼šã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”çŠ¶æ³ãƒ‘ãƒãƒ«ï¼ˆPUBLISHæ™‚ï¼‰ */}
            {isTeacher && phase === PHASE.PUBLISH && (
              <TeacherSurveyDashboard teamSurveyMap={teamSurveyMap} />
            )}
          </main>

          {/* Teacher Admin Modal (Shared for Input/Match phases) */}
          {selectedStudent && (
            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={() => setSelectedStudent(null)}>
              <div className="bg-white text-gray-800 p-6 rounded-2xl shadow-xl max-w-sm w-full overflow-y-auto max-h-[90vh]" onClick={(e) => e.stopPropagation()}>
                <h3 className="font-bold text-lg mb-2">{selectedStudent.classId}çµ„ {selectedStudent.studentNumber}ç•ª</h3>
                <div className="text-xl font-bold mb-4">{selectedStudent.name}</div>
                <div className="text-sm text-gray-500 mb-4 font-mono bg-gray-100 p-2 rounded">{selectedStudent.email}</div>

                <div className="text-sm mb-6 space-y-2">
                  <div>
                    <strong>ã‚«ãƒ†ã‚´ãƒªãƒ¼:</strong>
                    {/* ã€ä¿®æ­£ã€‘ç®¡ç†ç”»é¢ã§ã‚«ãƒ†ã‚´ãƒªãƒ¼å¤‰æ›´å¯èƒ½ã«ï¼ˆç©ºæ¬„ã‚‚é¸æŠå¯èƒ½ï¼‰ */}
                    {isTeacher ? (
                      <select
                        className="ml-2 border border-gray-300 rounded p-1 text-xs"
                        value={selectedStudent.category || ""}
                        onChange={(e) => handleUpdateCategory(selectedStudent.id, e.target.value)}
                      >
                        <option value="">ï¼ˆç©ºæ¬„ï¼‰</option>
                        {CATEGORIES.map(c => <option key={c.id} value={c.id}>{c.group} : {c.name}</option>)}
                      </select>
                    ) : (
                      <span className="ml-2">{CATEGORIES.find(c => c.id === selectedStudent.category)?.name || selectedStudent.category}</span>
                    )}
                  </div>
                  <p><strong>ãƒ†ãƒ¼ãƒ:</strong> {selectedStudent.theme}</p>

                  {/* è©³ç´°æƒ…å ±è¡¨ç¤ºï¼ˆãƒãƒƒãƒãƒ³ã‚°å¾Œç¢ºèªç”¨ï¼‰ */}
                  <div className="bg-gray-50 p-2 rounded text-xs text-gray-600 mt-2">
                    <div className="mb-1 font-bold">Topics:</div>
                    <div className="flex flex-wrap gap-1 mb-2">
                      {selectedStudent.topics?.map(tid => <span key={tid} className="bg-white border px-1 rounded">{TOPIC_TAGS.find(t=>t.id===tid)?.name}</span>)}
                    </div>
                    <div className="mb-1 font-bold">Skills:</div>
                    <div className="flex flex-wrap gap-1">
                      {selectedStudent.skills?.map(s => <span key={s} className="bg-white border px-1 rounded">{s}</span>)}
                    </div>
                  </div>

                  {phase === PHASE.CHECK && (
                    <p className="mt-2 pt-2 border-t text-green-600 font-bold">
                      ãƒã‚§ãƒƒã‚¯é€²æ—: {selectedStudent.votes ? Object.keys(selectedStudent.votes).length : 0} / 30 ä»¶
                    </p>
                  )}
                </div>

                {/* ã€ä¿®æ­£ã€‘ãƒãƒ¼ãƒ ç§»å‹•UI (Matching/Publish Phase) + æ–°è¦TEAMä½œæˆã‚’ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã§å¯¾å¿œ */}
                {isTeacher && (phase === PHASE.MATCHING || phase === PHASE.PUBLISH) && (
                  <div className="mb-6 p-3 bg-blue-50 rounded-xl border border-blue-100">
                    <label className="block text-xs font-bold text-blue-700 mb-1 flex items-center gap-1">
                      <Move size={12}/> ãƒãƒ¼ãƒ ç§»å‹•èª¿æ•´
                    </label>
                    <div className="flex gap-2">
                      <select
                        className="flex-1 text-xs border border-gray-300 rounded p-2"
                        value={moveTargetGroup}
                        onChange={(e) => setMoveTargetGroup(e.target.value)}
                      >
                        <option value="">ç§»å‹•å…ˆã‚’é¸æŠ...</option>
                        <option value={NEW_TEAM_VALUE}>ï¼‹ æ–°ã—ã„TEAMã‚’ä½œæˆã—ã¦ç§»å‹•</option>
                        {groups.map((g, idx) => {
                          const mems = g.members || g;
                          return <option key={idx} value={idx}>TEAM {idx + 1} ({mems.length}å)</option>;
                        })}
                      </select>
                      <button
                        onClick={() => handleMoveStudent(selectedStudent.id, moveTargetGroup)}
                        disabled={moveTargetGroup === ""}
                        className="bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold px-3 py-2 rounded disabled:opacity-50"
                      >
                        ç§»å‹•
                      </button>
                    </div>
                  </div>
                )}

                <div className="flex gap-2">
                  {(phase === PHASE.INPUT || phase === PHASE.CHECK) && (
                    <button onClick={() => { handleDeleteStudent(selectedStudent.id); setSelectedStudent(null); }} className="flex-1 bg-red-500 hover:bg-red-600 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2">
                      <Trash2 size={18} /> ç™»éŒ²æŠ¹æ¶ˆ
                    </button>
                  )}
                  <button onClick={() => setSelectedStudent(null)} className="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 py-3 rounded-xl font-bold">
                    é–‰ã˜ã‚‹
                  </button>
                </div>
              </div>
            </div>
          )}

          <footer className="py-6 text-center text-gray-300 text-xs font-bold uppercase tracking-widest">
            Quest Learning Matcher v2.0
          </footer>
        </div>
      );
    };

    const root = createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
